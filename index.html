<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Education Upgrade ‚Äî Wars of the Roses (AQA A‚ÄëLevel)</title>

  <!-- PWA essentials (keep if you use them) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#f8f3ef">
  <link rel="preload" as="image" href="header-bg.jpg">
<link rel="preload" as="image" href="section-bg.jpg?v8">
<style>
    /* ======================================================
       LIGHT PASTEL PEACH THEME (eye-safe)
       ====================================================== */

    :root{
      /* Home header background image (hosted in this repo) */
      --homeHeaderBg: url("header-bg.jpg");
      /* Background image used inside cards on all non-Home tabs */
      --sectionCardBg: url("./section-bg.jpg");

      --bg:#fbf8f6;
      --surface:#ffffff;
      --card:#ffffff;
      --line:#eadfd8;

      --text:#262626;
      --muted:#6c6c6c;

      --accent:#f2b7a6;    /* peach */
      --accent2:#f7d5c8;   /* soft peach */
      --accent3:#fdebe4;   /* very light peach */

      --good:#77cfa3;
      --warn:#f1c97a;
      --bad:#ef8a8a;

      --radius:18px;
      --shadow:0 8px 18px rgba(0,0,0,.06);

      --navH: 72px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 12% 8%, rgba(242,183,166,.22), transparent 60%),
        radial-gradient(900px 520px at 90% 12%, rgba(247,213,200,.22), transparent 60%),
        linear-gradient(180deg, var(--bg), #ffffff);
      color:var(--text);
      overflow-x:hidden;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:16px 16px calc(var(--navH) + env(safe-area-inset-bottom) + 16px);
    }

/* =========================
   HOME HEADER (HOME ONLY)
   ========================= */
header{
  position:relative;
  overflow:hidden;
  background: linear-gradient(180deg, var(--accent3), var(--bg));
  border-bottom:1px solid var(--line);
}

/* Image layer (behind everything) */
header#homeHeader::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--homeHeaderBg);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: .38;
  pointer-events:none;
  z-index:0;
}

/* Tint overlay (above image, below content) */
header#homeHeader::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(
    180deg,
    rgba(253,235,228,.22),
    rgba(251,248,246,.38)
  );
  pointer-events:none;
  z-index:1;
}

.headerInner{
  position:relative;
  z-index:2;
  max-width:1100px;
  margin:0 auto;
  padding:18px 16px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

.brand{ display:flex; align-items:center; gap:12px; }

.logo{
  width:44px;height:44px;border-radius:16px;
  background:linear-gradient(135deg, rgba(242,183,166,.95), rgba(247,213,200,.95));
  border:1px solid rgba(0,0,0,.06);
  display:grid;place-items:center;
  box-shadow: var(--shadow);
  font-size:20px;
}

h1{
  margin:0;
  font-size:28px;
  letter-spacing:.4px;
  font-weight:1000;
  line-height:1.05;
  text-shadow:0 10px 18px rgba(0,0,0,.08);
}

.sub{
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
}

    /* =========================
       CARDS (flat, no overlap)
       ========================= */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }

    /* =========================
       CARD BACKDROP (NON-HOME TABS)
       Subtle background image inside cards on Study/Quiz/Games/Exam/Settings
       ========================= */
    section.tabpane:not(#home) .card{
      position:relative;
      overflow:hidden;
      isolation:isolate;
      background: rgba(255,255,255,.92);
    }
    section.tabpane:not(#home) .card::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--sectionCardBg);
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      opacity:.14;
      filter: saturate(1.12) contrast(1.05);
      transform: scale(1.05);
      z-index:0;
      pointer-events:none;
    }
    section.tabpane:not(#home) .card > *{
      position:relative;
      z-index:1;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* =========================
   Banner KPI pills (Home)
   ========================= */
.bannerKpis{
  width:100%;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:stretch;
  margin-top:10px;
}

.kpiPill{
  min-width:150px;
  flex:1 1 150px;
  padding:12px 12px;
  border-radius:999px;

  background: rgba(255,255,255,.40);
  backdrop-filter: blur(16px) saturate(140%);
  -webkit-backdrop-filter: blur(16px) saturate(140%);
  -webkit-mask-image: -webkit-radial-gradient(white, black);

  border: 1px solid rgba(255,255,255,.50);
  box-shadow:
    0 8px 18px rgba(0,0,0,.06),
    inset 0 1px 0 rgba(255,255,255,.40);

  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.kpiPill .kpiLabel{
  font-size:12px;
  color:var(--muted);
  font-weight:900;
  letter-spacing:.2px;
}

.kpiPill .kpiVal{
  font-size:18px;
  font-weight:1000;
  font-variant-numeric:tabular-nums;
}

/* Combined progress pill */
.kpiPillLong{
  justify-content:flex-start;
}

.kpiLong{
  width:100%;
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:14px;
  flex-wrap:wrap;
}

.kpiItem{
  display:flex;
  align-items:baseline;
  gap:6px;
  white-space:nowrap;
}

.kpiMiniLabel{
  font-size:12px;
  color:var(--muted);
  font-weight:900;
  letter-spacing:.2px;
  text-transform:none;
}

.kpiMiniVal{
  font-size:18px;
  font-weight:1000;
  font-variant-numeric:tabular-nums;
}

.kpiSep{
  opacity:.35;
  font-weight:900;
}

    /* Icon-only settings button */
    .iconBtn{
      width:40px; height:40px;
      border-radius:999px;
      display:grid; place-items:center;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.85);
      box-shadow: 0 6px 14px rgba(0,0,0,.05);
      cursor:pointer;
      font-size:18px;
      padding:0;
    }
    .iconBtn:active{ transform:translateY(1px); }

    /* Mobile: keep header compact so streak card is first thing visible */
    @media (max-width: 520px){
      .headerInner{ padding:12px 14px 10px; }
      h1{ font-size:24px; }
      .sub{ font-size:12px; }
      .bannerKpis{ margin-top:8px; gap:8px; }
      .kpiPill{ min-width: 0; flex:1 1 30%; padding:10px 10px; }
      .kpiPill .kpiVal{ font-size:16px; }
      main{ padding-top:12px; }
    }
    

.topicDash{
  display:grid;
  /* Smaller, more navigable dashboard tiles */
  grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));
  gap:10px;
  margin:10px 0 6px;
}
.topicTile{
  width:100%;
  border:1px solid var(--line);
  background:linear-gradient(180deg,#fff,var(--accent3));
  border-radius:16px;
  padding:10px 10px 10px;
  box-shadow:var(--shadow);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}
.topicTile:hover{ filter:brightness(0.99); }
.topicTile:active{ transform:translateY(1px); }

/* Topic on/off toggle (per tile) */
.topicToggleWrap{
  position:absolute;
  top:10px;
  right:10px;
  z-index:3;
}
.switch{
  position:relative;
  display:inline-block;
  width:44px;
  height:24px;
}
.switch input{ opacity:0; width:0; height:0; }
.slider{
  position:absolute; cursor:pointer;
  inset:0;
  background:rgba(0,0,0,.12);
  border:1px solid rgba(0,0,0,.08);
  border-radius:999px;
  transition: all .18s ease;
  box-shadow: 0 6px 10px rgba(0,0,0,.08);
}
.slider:before{
  content:"";
  position:absolute;
  height:18px; width:18px;
  left:3px; top:2px;
  background:white;
  border-radius:50%;
  transition: all .18s ease;
  box-shadow: 0 4px 8px rgba(0,0,0,.18);
}
.switch input:checked + .slider{
  background:rgba(51, 157, 98, .35); /* good-ish tint */
}
.switch input:checked + .slider:before{
  transform: translateX(20px);
}
.topicTile.isDisabled{
  opacity:.55;
}
.topicTile.isDisabled .progressTank{
  filter:grayscale(.35) saturate(.75);
}

/* =========================
   Topic tiles (liquid fill)
   ========================= */
.progressTank{
  width:100%;
  height:132px;
  border-radius:16px;
  border:1px solid rgba(0,0,0,.08);
  background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(253,235,228,.70));
  box-shadow: 0 8px 14px rgba(0,0,0,.06);
  position:relative;
  overflow:hidden;
}
.progressLiquid{
  position:absolute;
  left:0; right:0; bottom:0;
  height: var(--fill, 0%);
  /* Fallback first (no color-mix), then enhanced */
  background:
    linear-gradient(180deg,
      rgba(255,255,255,.22),
      rgba(255,255,255,0) 22%),
    linear-gradient(135deg, rgba(255,255,255,.10), var(--liq, var(--bad)));
  background:
    linear-gradient(180deg,
      rgba(255,255,255,.22),
      rgba(255,255,255,0) 22%),
    linear-gradient(135deg,
      color-mix(in srgb, var(--liq, var(--bad)) 84%, white 16%),
      var(--liq, var(--bad)));
  transition: height .7s cubic-bezier(.2,.9,.2,1);
  will-change: height;
}
.progressLiquid::before{
  content:"";
  position:absolute;
  left:-30%;
  bottom: calc(100% - 18px);
  width:160%;
  height:46px;
  background:
    radial-gradient(20px 18px at 20px 30px, rgba(255,255,255,.55) 0 55%, transparent 58%),
    radial-gradient(22px 18px at 60px 18px, rgba(255,255,255,.45) 0 55%, transparent 58%),
    radial-gradient(22px 18px at 100px 30px, rgba(255,255,255,.40) 0 55%, transparent 58%);
  opacity:.7;
  filter: blur(.2px);
  animation: waveSlide 4.5s linear infinite;
  pointer-events:none;
}
@keyframes waveSlide{
  from{ transform: translateX(0); }
  to{ transform: translateX(-120px); }
}

.tankContent{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:14px 12px;
  z-index:2;
}
.tankContent .tileNum{ font-size:18px; }
.tankContent .tileMain{ font-size:13px; }
.tankContent .tileYears{ font-size:11px; }

.topicTile .levelBadge{ margin-top:10px; }

@media (max-width:420px){
  .progressTank{ height:124px; }
}



.xpRing{
  width:118px;
  height:118px;
  border-radius:50%;
  padding:8px;
  display:grid;
  place-items:center;
  background:conic-gradient(from -90deg,
      var(--good) 0 var(--g),
      var(--warn) var(--g) calc(var(--g) + var(--y)),
      var(--bad) calc(var(--g) + var(--y)) 100%);
  border:1px solid rgba(0,0,0,.06);
  box-shadow: 0 8px 14px rgba(0,0,0,.06);
}
.xpInner{
  width:100%;
  height:100%;
  border-radius:50%;
  background:linear-gradient(180deg,#fff, #fff);
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:8px;
}
.tileNum{
  font-weight:900;
  font-size:18px;
  line-height:1;
  margin-bottom:3px;
}
.tileMain{
  font-weight:900;
  font-size:13px;
  line-height:1.15;
}
.tileYears{
  margin-top:5px;
  font-size:11px;
  color:var(--muted);
  font-weight:800;
  letter-spacing:.2px;
}

.levelBadge{
  width:86%;
  text-align:center;
  border:1px solid rgba(0,0,0,.10);
  border-radius:12px;
  padding:8px 8px;
  font-weight:900;
  letter-spacing:.6px;
  font-size:11px;
}

/* Tighten on very small screens */
@media (max-width:420px){
  .topicDash{ grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:9px; }
  .xpRing{ width:112px; height:112px; }
}

.level-starting{ background:rgba(239,138,138,.18); }
.level-developing{ background:rgba(241,201,122,.22); }
.level-secure{ background:rgba(119,207,163,.20); }
.level-master{ background:rgba(119,207,163,.28); border-color: rgba(119,207,163,.55); }

.levelUpBanner{
  position:fixed;
  left:50%;
  top:12px;
  transform:translateX(-50%) translateY(-10px);
  background:linear-gradient(135deg, rgba(255,255,255,.96), rgba(253,235,228,.96));
  border:1px solid rgba(0,0,0,.10);
  box-shadow: 0 14px 26px rgba(0,0,0,.10);
  border-radius:999px;
  padding:10px 14px;
  font-weight:900;
  letter-spacing:.2px;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:10000;
  opacity:0;
  pointer-events:none;
  transition: opacity .35s ease, transform .35s ease;
}
.levelUpBanner.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
.levelUpBanner .smallNote{
  font-weight:800;
  color:var(--muted);
  font-size:12px;
}

@media(max-width:520px){
  .xpRing{ width:170px; height:170px; }
  .tileMain{ font-size:15px; }
}

.grow{flex:1;min-width:200px}

    .pill{
      border:1px solid var(--line);
      background: #fff;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }

    /* Signal pills (meaning + gentle pressure, no new UI blocks) */
    .signalPill{
      flex-direction:column;
      align-items:flex-start;
      white-space:normal;
      line-height:1.15;
      padding:8px 12px;
      gap:2px;
      max-width:260px;
    }
    .signalPill .pillTop{font-weight:900;color:var(--text);font-size:12px}
    .signalPill .pillSub{font-size:11px;color:var(--muted);font-weight:750}
    .signalPill .pillTopRow{display:flex;align-items:center;gap:8px}

    .hookLine{margin-top:3px;color:var(--muted);font-size:12px}
.divider{height:1px;background:var(--line);margin:12px 0}

    label{font-size:12px;color:var(--muted)}
    select,input,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    select:focus,input:focus,textarea:focus{
      border-color: rgba(242,183,166,.85);
      box-shadow: 0 0 0 3px rgba(242,183,166,.18);
    }

    .btn{
      border:1px solid rgba(0,0,0,.06);
      background: var(--accent3);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(242,183,166,.95), rgba(247,213,200,.95));
    }
    .btn.small{padding:8px 10px;font-size:12px;font-weight:700}

    .revealBand{
      width:100%;
      padding:16px 14px;
      border-radius:16px;
      font-size:clamp(17px, 2vw, 19px);
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform:translateY(1px)}

    /* =========================
       TAB PAGES
       ========================= */
    /* Generic hide utility (used across study/quiz UI) */
    .hidden{display:none !important}

    .tabpane.hidden{display:none}

    /* =========================
       KPI / RINGS
       ========================= */
    .kpiGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.kpiGrid{grid-template-columns:1fr}}

    .kpiBig{font-size:28px;font-weight:900}
    .note{color:var(--muted);font-size:12px;line-height:1.45}
    .qText{font-size:clamp(20px, 2.1vw, 24px);font-weight:800;line-height:1.3;margin:0;letter-spacing:-.2px}
    .aBox{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed var(--line);
      white-space:pre-wrap;
      font-size:clamp(16px, 1.9vw, 20px);
      line-height:1.5;
      font-weight:550;
      color:#242424;
      letter-spacing:-.1px;
    }

    /* =========================
       FLASHCARD STANDALONE BOX
       ========================= */
    .flashcardFrame{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #fff, var(--accent3));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      min-height: 190px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:10px;
    }
    @media(max-width:600px){
      .flashcardFrame{ padding:16px; min-height: 200px; }
    }
    .flashcardFrame .qText{ font-size:clamp(22px, 2.4vw, 26px); }
    .flashcardFrame .aBox{ border-top:1px dashed var(--line); padding-top:14px; margin-top:0; }


    /* =========================
       STUDY PAGE (mobile-first tidy)
       ========================= */
    .studyWrap{ display:flex; flex-direction:column; gap:14px; }
    .studyControls{ order:1; }
    .studyCard{ order:2; }

    /* On phones: card first, menus second */
    @media(max-width:700px){
      .studyControls{ order:2; }
      .studyCard{ order:1; }
    }

    /* Fixed-height card frame so buttons stay visible when Reveal expands */
    .fixedCard{
      height: 300px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    @media(max-width:700px){
      .fixedCard{ height: 320px; }
      .studyPrompt{ text-align:center; }
    }

    /* Emoji buttons: 3 equal-width blocks, bigger tap targets */
    .emojiRow{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      width:100%;
    }
    .emojiBtn{
      width:100%;
      padding:14px 0;
      font-size:30px;
      line-height:1;
      border-radius:16px;
    }
    @media(max-width:700px){
      .emojiBtn{ font-size:34px; padding:16px 0; }
    }


    .ringWrap{display:flex;align-items:center;gap:12px}
    .ring{
      width:56px;height:56px;border-radius:999px;
      display:grid;place-items:center;
      background:
        conic-gradient(var(--accent) var(--deg), #f0e7e2 0);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      font-weight:900;
    }
    .ringInner{
      width:42px;height:42px;border-radius:999px;
      background:#fff;
      border:1px solid var(--line);
      display:grid;place-items:center;
      font-size:12px;
      color:#000;
    }

    /* =========================
       CHOICE BUTTONS
       ========================= */
    .choiceGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:520px){.choiceGrid{grid-template-columns:1fr}}
    .choiceBtn{
      width:100%;
      text-align:left;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    .choiceBtn.correct{border-color: rgba(119,207,163,.9); background: rgba(119,207,163,.12)}
    .choiceBtn.wrong{border-color: rgba(239,138,138,.9); background: rgba(239,138,138,.10)}

    /* =========================
       MATCH GAME (two panels)
       ========================= */
    .matchGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.matchGrid{grid-template-columns:1fr}}
    .matchCol{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      background:#fff;
      height:52vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .matchItem{
      width:100%;
      text-align:left;
      margin:6px 0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-size:14px;
      font-weight:700;
    }
    .matchItem.selected{border-color: rgba(242,183,166,.95); background: rgba(242,183,166,.14)}
    .matchItem.correct{border-color: rgba(119,207,163,.95); background: rgba(119,207,163,.12)}

/* =========================
   Connections-style game (Games tab)
   ========================= */
/* Apply same section background image as other game cards */
.connectionsCard{
  position:relative;
  overflow:hidden;
  isolation:isolate;
  background: rgba(255,255,255,.92);
}
.connectionsCard::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--sectionCardBg);
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  opacity:.14;
  filter: saturate(1.12) contrast(1.05);
  transform: scale(1.05);
  z-index:0;
  pointer-events:none;
}
.connectionsCard > *{
  position:relative;
  z-index:1;
}

.connectionsCard{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  margin: 12px 0 14px;
}

.connectionsTop{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}

.connectionsTop h3{
  margin:0;
  font-size:16px;
  letter-spacing:.2px;
}

.connectionsMeta{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.connectionsMeta select{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:800;
}

.mistakes{
  display:flex;
  gap:6px;
  align-items:center;
  color:var(--muted);
  font-size:12px;
  font-weight:900;
}

.mDot{
  width:10px;
  height:10px;
  border-radius:50%;
  background: rgba(0,0,0,.25);
}

.mDot.used{ background: rgba(0,0,0,.08); }

.connectionsSolved{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.solvedGroup{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  background: linear-gradient(180deg, #fff, var(--accent3));
}

.solvedTitle{
  font-weight:1000;
  font-size:12px;
  color: var(--muted);
  letter-spacing:.2px;
  margin-bottom:6px;
}

.solvedTerms{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  font-weight:900;
}

.connectionsGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:10px;
}

.connTile{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px 10px;
  background:#fff;
  box-shadow: 0 6px 14px rgba(0,0,0,.04);
  font-weight:1000;
  text-align:center;
  cursor:pointer;
  user-select:none;
  min-height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1.15;
}

.connTile.selected{
  outline: 2px solid rgba(0,0,0,.18);
  background: linear-gradient(180deg, #fff, rgba(242,183,166,.25));
}

.connTile.locked{
  opacity:.55;
  cursor:not-allowed;
}

.connectionsActions{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.connBtn{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.10);
  background:rgba(255,255,255,.92);
  box-shadow: 0 6px 14px rgba(0,0,0,.05);
  font-weight:1000;
  cursor:pointer;
}

.connBtn.primary{
  background: linear-gradient(135deg, rgba(242,183,166,.95), rgba(247,213,200,.95));
}

.connMsg{
  margin-top:10px;
  color: var(--muted);
  font-size:12px;
  font-weight:900;
  letter-spacing:.2px;
}

/* Connections win overlay (trophy) */
.connWinOverlay{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index:3;
}
.connWinInner{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px 16px;
  border-radius:18px;
  border:1px solid rgba(119,207,163,.55);
  background: rgba(119,207,163,.14);
  box-shadow: var(--shadow);
  transform: translateY(8px) scale(.98);
  opacity:0;
}
.connWinOverlay.show .connWinInner{
  animation: connWinPop 220ms ease-out both;
}
@keyframes connWinPop{
  from{ opacity:0; transform: translateY(10px) scale(.98); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}
.connTrophy{
  font-size:30px;
  line-height:1;
}
.connWinTitle{
  font-weight:1000;
}
.connWinSub{
  margin-top:2px;
  font-size:12px;
  font-weight:900;
  color: var(--muted);
}



/* Mobile: keep 4 columns but reduce padding */
@media (max-width: 520px){
  .connectionsGrid{ gap:8px; }
  .connTile{ padding:10px 8px; min-height:52px; font-size:13px; }
}


    
/* =========================
   Games hub + full-screen game panes
   ========================= */
.gamesHub{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-top:10px;
}
.gamePillBtn{
  width:100%;
  text-align:left;
  border:1px solid var(--line);
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  padding:14px 14px;
  cursor:pointer;
  position:relative;
  overflow:hidden;
  isolation:isolate;
}
.gamePillBtn::before{
  content:"";
  position:absolute;
  inset:0;
  background-image: var(--sectionCardBg);
  background-size: cover;
  background-position:center;
  background-repeat:no-repeat;
  opacity:.12;
  filter:saturate(1.1) contrast(1.05);
  transform:scale(1.05);
  z-index:0;
  pointer-events:none;
}
.gamePillBtn > *{ position:relative; z-index:1; }
.gamePillBtn:hover{ filter:brightness(.99); }
.gamePillBtn:active{ transform:translateY(1px); }

.gamePillTitle{
  font-weight:1000;
  font-size:16px;
  margin-bottom:4px;
}
.gamePillDesc{
  color:var(--muted);
  font-size:12.5px;
  line-height:1.25;
}

.gamePaneTop{
  position:sticky;
  top:0;
  z-index:5;
  background: linear-gradient(180deg, rgba(251,248,246,.95), rgba(251,248,246,.55));
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  padding:6px 0 8px;
  margin-bottom:6px;
}

@media (max-width: 520px){
  .gamePillBtn{ min-height:120px; display:flex; flex-direction:column; justify-content:center; }
  .gamePillTitle{ font-size:18px; }
  .gamePillDesc{ font-size:13px; }
}

/* =========================
       BOTTOM NAV (fixed & safe)
       ========================= */
    nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height: var(--navH);
      padding-bottom: env(safe-area-inset-bottom);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      display:flex;
      z-index:1000;
    }
    .navBtn{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .navBtn.active{
      color:#000;
      font-weight:800;
    }

    /* Accessibility */
    :focus-visible{ outline: 3px solid rgba(242,183,166,.85); outline-offset: 3px; }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }


    /* =========================
       STREAK (Duolingo-style hero)
       ========================= */

    /* Clean, controlled streak card (match Daily Challenge card styling) */
    .streakCountPill{
      padding:10px 14px;
      border-radius:999px;
      background:linear-gradient(180deg,#fff,var(--accent3));
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow);
      display:flex; align-items:center; gap:10px;
    }
    .streakCountLabel{
      color:var(--muted);
      font-weight:900;
      font-size:11px;
      letter-spacing:.7px;
      text-transform:uppercase;
    }
    .streakCountNum{
      font-weight:1000;
      font-size:18px;
      font-variant-numeric: tabular-nums;
      color:var(--text);
    }
    .streakMiniPill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      display:flex; align-items:center; gap:8px;
    }
    .streakMiniLabel{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .streakMiniNum{
      font-weight:900;
      font-variant-numeric: tabular-nums;
    }
    .streakStatus{
      margin-top:0;
      width:100%;
    }
    .protectBtn{
      background:linear-gradient(180deg, rgba(242,183,166,.65), rgba(247,213,200,.65));
    }

    .streakPillBtn{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(180deg,#fff,var(--accent3));
      box-shadow:var(--shadow);
    }
    .streakBubble{
      min-width:34px; height:30px;
      border-radius:999px;
      display:grid; place-items:center;
      font-weight:900;
      background:rgba(242,183,166,.28);
      border:1px solid rgba(242,183,166,.55);
    }

    .streakHero{
      background:linear-gradient(180deg,#fff, var(--accent3));
      position:relative;
      overflow:hidden;
    }
    .streakHero::before{
      content:"";
      position:absolute; inset:-120px -80px auto auto;
      width:320px; height:320px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(242,183,166,.45), transparent 60%);
      transform:rotate(18deg);
      pointer-events:none;
    }
    .streakTop{
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:flex-start;
    }
    .streakBig{
      display:flex; align-items:center; gap:12px;
    }
    
.streakFlame{
      width:52px; height:52px; border-radius:18px;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(242,183,166,.95), rgba(247,213,200,.95));
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow);
      font-size:26px;
    }
.streakPillNumStatic{
      font-weight:900;
      font-size:28px;
      color:var(--text);
      text-shadow:none;
}
@keyframes streakPulse{
      0%,100%{ transform:scale(1); filter:saturate(1); }
      50%{ transform:scale(1.05); filter:saturate(1.2); }
    }
    .streakNum{
      font-size:44px;
      font-weight:1000;
      line-height:1;
      letter-spacing:-1px;

      /* flaming number */
      color:#ff7a18;
      text-shadow:
        0 0 6px rgba(255,122,24,.8),
        0 0 12px rgba(255,94,0,.6),
        0 0 18px rgba(255,60,0,.4);
      animation: flamePulse 1.6s ease-in-out infinite;
    }
    .streakMeta{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
    }
    
    .bestStreakPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(242,183,166,.18);
      border:1px solid rgba(242,183,166,.45);
      color:#3b2a25;
      font-weight:900;
      letter-spacing:.2px;
    }
    .bestStreakPill .bestLabel{
      font-weight:800;
      font-size:12px;
      color: rgba(38,38,38,.78);
    }
    .bestStreakPill .bestNum{
      font-variant-numeric: tabular-nums;
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 6px 12px rgba(0,0,0,.06);
      color:#000;
    }
.streakStatus{
      display:flex; align-items:center; gap:8px;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      font-weight:700;
    }
    .streakStatus.risk{
      border-color: rgba(239,138,138,.55);
      background: rgba(239,138,138,.10);
    }
    .streakStatus.safe{
      border-color: rgba(119,207,163,.55);
      background: rgba(119,207,163,.10);
    }
    .countdown{
      font-variant-numeric: tabular-nums;
      font-weight:900;
    }
    .streakRight{
      display:flex; flex-direction:column; gap:10px; min-width:260px;
      align-items:flex-end;
    }
    .weekStrip{
      display:flex; gap:6px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
    }
    .dayBlock{
      width:26px; height:26px; border-radius:9px;
      display:grid; place-items:center;
      font-size:12px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:var(--muted);
      user-select:none;
    }
    .dayBlock.done{
      background: rgba(119,207,163,.18);
      border-color: rgba(119,207,163,.55);
      color:#0b4b2a;
      font-weight:900;
    }
    .dayBlock.missed{
      background: rgba(239,138,138,.12);
      border-color: rgba(239,138,138,.45);
      color:#6b1a1a;
      font-weight:800;
    }
    .milestone{
      width:100%;
      display:flex; align-items:center; gap:10px; justify-content:flex-end;
      color:var(--muted);
      font-size:13px;
    }
    .bar{
      width:220px; height:10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(242,183,166,.95), rgba(247,213,200,.95));
      border-right:1px solid rgba(0,0,0,.06);
    }

    .streakChecklist{
      margin-top:12px;
      display:grid; gap:8px;
    }
    .checkRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    /* Make the checklist rows behave like clean, tappable buttons */
    .checkRowBtn{
      width:100%;
      cursor:pointer;
      text-align:left;
      appearance:none;
      -webkit-appearance:none;
      font: inherit;
    }
    .checkRowBtn:hover{ border-color: rgba(0,0,0,.16); }
    .checkRowBtn:active{ transform: translateY(1px); }
    .checkRowBtn:focus{ outline:2px solid rgba(242,183,166,.55); outline-offset:2px; }
    .checkLeft{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .checkDot{
      width:22px; height:22px; border-radius:8px;
      display:grid; place-items:center;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:13px;
    }
    .checkDot.done{
      background: rgba(119,207,163,.18);
      border-color: rgba(119,207,163,.55);
    }
    .checkVal{
      color:var(--muted);
      font-weight:800;
      font-variant-numeric: tabular-nums;
    }
    .protectBtn{
      margin-top:12px;
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      font-weight:1000;
      border:1px solid rgba(0,0,0,.10);
      background:linear-gradient(180deg, rgba(242,183,166,.85), rgba(247,213,200,.85));
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .protectBtn:hover{ filter:brightness(.98); }

    /* Confetti canvas */
    #confettiCanvas{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9999;
    }
  
.banner-title-pill {
  display: inline-block;
  padding: 10px 20px;
  font-size: 30px;        /* same size as before */
  font-weight: 800;
  letter-spacing: -0.4px;
  line-height: 1;
  border-radius: 999px;

  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
  animation: bannerFadeUp 180ms ease-out both;
}



@keyframes bannerFadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

@keyframes pillShimmer {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes pillPulse {
  0%   { transform: translateY(0) scale(1); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
  35%  { transform: translateY(-1px) scale(1.02); box-shadow: 0 10px 24px rgba(0,0,0,0.14); }
  100% { transform: translateY(0) scale(1); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
}

/* Diamond week shimmer (subtle) */
.banner-title-pill.pill-diamond {
  background: linear-gradient(90deg,
    rgba(255, 255, 255, 0.78),
    rgba(255, 255, 255, 0.55),
    rgba(255, 255, 255, 0.78)
  );
  background-size: 200% 100%;
  animation: bannerFadeUp 180ms ease-out both, pillShimmer 2.8s ease-in-out infinite;
}

/* Streak milestone pulse (one-off) */
.banner-title-pill.pill-pulse {
  animation: bannerFadeUp 180ms ease-out both, pillPulse 900ms ease-out 1;
}


/* ===== Flaming streak number ===== */
.streak-display{
  display:flex;
  align-items:center;
  gap:6px;
  justify-content:center;
}
.streak-number{
  font-size:2.6rem;
  font-weight:800;
  color:#ff7a18;
  text-shadow:
    0 0 6px rgba(255,122,24,.8),
    0 0 12px rgba(255,94,0,.6),
    0 0 18px rgba(255,60,0,.4);
  animation:flamePulse 1.6s ease-in-out infinite;
}
.streak-flame{
  font-size:2.2rem;
  animation:flameFlicker .9s infinite alternate;
}
@keyframes flamePulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.08)}
  100%{transform:scale(1)}
}
@keyframes flameFlicker{
  from{transform:translateY(0);opacity:.9}
  to{transform:translateY(-2px);opacity:1}
}


/* ===== FORCE: no pulse on main streak number ===== */
.streakNum{
  animation: none !important;
}


/* ===== Restore original streak layout with pill ===== */
.streakBig{
  display:flex;
  align-items:center;
  gap:12px;
}


/* ==========================================================
   Timeline Tension (game)
   ========================================================== */
.timelineLayout{
  display:grid;
  grid-template-columns: 1fr 1.2fr;
  gap:14px;
}
@media (max-width: 780px){
  .timelineLayout{ grid-template-columns:1fr; }
}
.timelinePool{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.tlChip{
  border:1px solid var(--line);
  background:rgba(255,255,255,.9);
  border-radius:999px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.04);
  user-select:none;
}
.tlChip:hover{ filter:brightness(.99); }
.tlChip.isSelected{
  outline:3px solid rgba(242,183,166,.55);
  border-color: rgba(242,183,166,.55);
}
.timelineSlots{
  list-style:decimal;
  margin:0;
  padding-left:18px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.tlSlot{
  border:1px dashed rgba(0,0,0,.16);
  border-radius:14px;
  padding:10px 12px;
  min-height:44px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  background: rgba(255,255,255,.75);
}
.tlSlot strong{ font-weight:1000; }
.tlSlot .tlDate{
  font-weight:1000;
  color:var(--muted);
  font-variant-numeric: tabular-nums;
}
.tlSlot.empty{
  color:var(--muted);
}
.tlSlot button{
  border:none;
  background:transparent;
  cursor:pointer;
  font:inherit;
  text-align:left;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.tlSlot.isWrong{
  border-color: rgba(239,138,138,.55);
  background: rgba(239,138,138,.10);
}
.timelineMsg{
  margin-top:10px;
  font-weight:900;
  color:var(--muted);
}
.tlWinOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,.18);
  z-index:9998;
}
.tlWinInner{
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
  border:1px solid rgba(0,0,0,.10);
  border-radius:18px;
  padding:14px 16px;
  box-shadow: var(--shadow);
  display:flex;
  gap:12px;
  align-items:center;
  max-width: 520px;
  margin: 0 14px;
}
.tlTrophy{ font-size:30px; }
.tlWinTitle{ font-weight:1000; }
.tlWinSub{ color:var(--muted); font-weight:900; font-size:12px; margin-top:2px; }



/* ======================================================
   CLEAN PROFESSIONAL UI MODE
   (Applied override)
   ====================================================== */

body{
  background:#f7f7f7 !important;
}

/* ---------- HEADER ---------- */

header#homeHeader::before{
  opacity:.16 !important;
}

header#homeHeader::after{
  display:none !important;
}

.banner-title-pill{
  background:none !important;
  backdrop-filter:none !important;
  box-shadow:none !important;
  padding:0 !important;
}

/* ---------- CARDS ---------- */

.card{
  background:#ffffff !important;
  border:1px solid #e6e6e6 !important;
  box-shadow:0 2px 6px rgba(0,0,0,.05) !important;
}

section.tabpane:not(#home) .card::before{
  display:none !important;
}

/* ---------- TYPOGRAPHY ---------- */

h1,
.tileMain,
.tileNum,
.levelBadge,
.kpiMiniVal,
.kpiVal{
  font-weight:700 !important;
}

label,
.pill,
.note{
  font-weight:500 !important;
}

/* ---------- KPI PILLS ---------- */

.kpiPill{
  background:#fff !important;
  backdrop-filter:none !important;
  box-shadow:none !important;
  border:1px solid #e5e5e5 !important;
}

/* ---------- BUTTONS ---------- */

.btn{
  background:#fff !important;
  border:1px solid #ddd !important;
  box-shadow:none !important;
}

.btn.primary{
  background:#f2b7a6 !important;
  border:none !important;
  color:#fff !important;
}

/* ---------- TOPIC TILES ---------- */

.progressTank{
  background:#f4f4f4 !important;
  box-shadow:none !important;
}

.progressLiquid{
  background:#f2b7a6 !important;
}

.progressLiquid::before{
  display:none !important;
}

/* ---------- TOGGLE SWITCH ---------- */

.slider{
  background:#ddd !important;
  box-shadow:none !important;
}

.switch input:checked + .slider{
  background:#77cfa3 !important;
}

/* ---------- STREAK ---------- */

.streakNum{
  text-shadow:none !important;
  color:#333 !important;
}

.streakFlame{
  animation:none !important;
}

.streakHero::before{
  display:none !important;
}

/* ---------- PILLS ---------- */

.pill{
  background:#fff !important;
  border:1px solid #e3e3e3 !important;
  box-shadow:none !important;
}

/* ---------- NAV BAR ---------- */

nav{
  backdrop-filter:none !important;
  background:#ffffff !important;
}

.navBtn.active{
  position:relative;
}

.navBtn.active::after{
  content:"";
  position:absolute;
  bottom:8px;
  width:22px;
  height:3px;
  border-radius:3px;
  background:#f2b7a6;
}

/* ---------- GAMES / PANES ---------- */

.connectionsCard::before,
.gamePillBtn::before{
  display:none !important;
}

/* ---------- REMOVE IDLE ANIMATIONS ---------- */

*{
  animation-duration:.001ms !important;
  animation-iteration-count:1 !important;
}


</style>
</head>

<body>

<canvas id="confettiCanvas"></canvas>
<div id="levelUpBanner" class="levelUpBanner" aria-live="polite"></div>

<header id="homeHeader">
  <div class="headerInner">
    <div class="brand">
      <div>
        <div class="banner-title-pill">Education Upgrade</div>
      </div>
    </div>

    <div class="row">
      <div class="pill signalPill" id="weeklyBadgePill">
        <div class="pillTop">üèÖ Week signal</div>
        <div class="pillSub">Keep momentum rolling</div>
      </div>
      
      <button class="iconBtn" id="openSettingsBtn" type="button" aria-label="Open settings">‚öôÔ∏è</button>

    </div>

    <!-- KPI pills: keep key stats visible without pushing streak off-screen on mobile -->
    <div class="bannerKpis" aria-label="Quick stats">
      <div class="kpiPill kpiPillLong" title="Overall progress">
        <div class="kpiLong" aria-label="Progress indicators">
          <div class="kpiItem"><span class="kpiMiniLabel">Studied</span><span class="kpiMiniVal" id="kpiStudied">0</span></div>
          <span class="kpiSep" aria-hidden="true">‚Ä¢</span>
          <div class="kpiItem"><span class="kpiMiniLabel">Focus</span><span class="kpiMiniVal" id="kpiFocus">0</span></div>
          <span class="kpiSep" aria-hidden="true">‚Ä¢</span>
          <div class="kpiItem"><span class="kpiMiniLabel">Quiz</span><span class="kpiMiniVal" id="kpiQuiz">0%</span></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main>

  <!-- HOME -->
  <section id="home" class="tabpane">
    
    <div class="card" id="todayPathCard">
      <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px">
        <div class="grow">
          <div style="font-weight:800;font-size:16px">Continue</div>
          <div class="note" id="todayNextNote">Your next step for today (about 8‚Äì10 minutes).</div>
        </div>
        <div class="pill" aria-label="Weekly goal">
          <span style="font-weight:800;color:var(--muted)">Weekly goal</span>
          <span style="font-weight:900;margin-left:8px" id="weeklyGoalText">0/5</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="gap:10px;flex-wrap:wrap;align-items:stretch">
        <button class="btn primary" id="btnContinueToday" type="button" style="flex:1;min-width:220px;padding:14px 14px;border-radius:16px;font-weight:900">
          ‚ñ∂ Continue today‚Äôs thread
        </button>
        <button class="btn" id="btnSmartReview" type="button" style="flex:1;min-width:220px;padding:14px 14px;border-radius:16px;font-weight:900">
          üîÅ Smart review (Focus set)
        </button>
      </div>

      <div class="divider"></div>

      <div>
        <div class="note" style="margin:0 0 8px">Pinned topics</div>
        <div class="row" id="pinnedTopicsRow" style="gap:8px;flex-wrap:wrap"></div>
      </div>

      <div class="divider"></div>

      <div>
        <div style="font-weight:800;font-size:14px">Your pathway</div>
        <div class="note" style="margin-top:4px">Work through units in order. The app will pull Focus items automatically.</div>

        <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn" type="button" data-unit="1" id="unitBtn1" style="flex:1;min-width:220px;padding:12px 12px;border-radius:16px;text-align:left">
            <div style="font-weight:900">Unit 1</div>
            <div class="note" style="margin-top:4px">Foundations ‚Ä¢ key terms + core ideas</div>
          </button>
          <button class="btn" type="button" data-unit="2" id="unitBtn2" style="flex:1;min-width:220px;padding:12px 12px;border-radius:16px;text-align:left">
            <div style="font-weight:900">Unit 2</div>
            <div class="note" style="margin-top:4px">Application ‚Ä¢ exam-style practice</div>
          </button>
          <button class="btn" type="button" data-unit="3" id="unitBtn3" style="flex:1;min-width:220px;padding:12px 12px;border-radius:16px;text-align:left">
            <div style="font-weight:900">Unit 3</div>
            <div class="note" style="margin-top:4px">Mastery ‚Ä¢ mixed practice + timed work</div>
          </button>
        </div>
      </div>
    </div>

<div class="card" id="streakHeroCard">
  <div class="row" style="justify-content:space-between; align-items:flex-start">
    <div>
      <div style="font-weight:900;font-size:16px">Daily streak</div>
      <div class="note" id="streakNote">Protect todays streak by completing the daily challenge below.<br>Today‚Äôs topic thread: <b id="dailyTopicLabel">‚Äî</b></div>
    </div>
    <div class="pill streakCountPill" aria-label="Current streak">
      <span class="streakCountLabel">Streak</span>
      <span class="streakCountNum" id="streakBigNum">0</span>
    </div>
  </div>

  <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
    <div class="pill streakMiniPill" aria-label="Best streak">
      <span class="streakMiniLabel">Best</span>
      <span class="streakMiniNum" id="streakBestNum">0</span>
    </div>
    <div class="pill streakMiniPill" aria-label="Reset timer">
      <span class="streakMiniLabel">Resets in</span>
      <span class="streakMiniNum countdown" id="streakCountdown">--:--:--</span>
    </div>
  </div>

  <div id="streakCompleteBanner" class="hidden" style="border:1px solid rgba(119,207,163,.55);background:rgba(119,207,163,.14);border-radius:18px;padding:12px;display:flex;gap:10px;align-items:center;margin-top:12px">
    <div style="font-size:26px">üèÜ</div>
    <div>
      <div style="font-weight:900">Daily Challenge Complete!</div>
      <div class="note" style="margin-top:4px">Nice. Come back tomorrow for a new topic.</div>
    </div>
  </div>

  <div class="streakChecklist" aria-label="Daily Challenge checklist">
    <button class="checkRow checkRowBtn" id="goDailyFlash" type="button" aria-label="Open flashcards for today's Daily Challenge topic">
      <div class="checkLeft"><span class="checkDot" id="chkFlashDot">üìö</span> Flashcards</div>
      <div class="checkVal" id="chkFlashVal">0/12</div>
    </button>
    <button class="checkRow checkRowBtn" id="goDailyQuiz" type="button" aria-label="Open topic quiz for today's Daily Challenge topic">
      <div class="checkLeft"><span class="checkDot" id="chkQuizDot">üß†</span> Topic Quiz</div>
      <div class="checkVal" id="chkQuizVal">0% / 70%</div>
    </button>
    <button class="checkRow checkRowBtn" id="goDailyPlan" type="button" aria-label="Open the 25-mark plan for today's Daily Challenge topic">
      <div class="checkLeft"><span class="checkDot" id="chkPlanDot">üß±</span> 25-mark plan</div>
      <div class="checkVal" id="chkPlanVal">Not opened</div>
    </button>
  </div>

  <button class="protectBtn" id="protectStreakBtn" type="button">Protect today‚Äôs streak (Daily Challenge)</button>

  <div class="row" style="justify-content:space-between; align-items:center; margin-top:12px">
    <div class="note" style="margin:0">Last 7 days</div>
    <div class="weekStrip" id="weekStrip"></div>
  </div>
</div>



    
  </section>


  <!-- LIBRARY -->
  <section id="library" class="tabpane hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <div style="font-weight:800;font-size:16px">üìö Library</div>
          <div class="note">Browse everything. Use Today for the guided pathway.</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" type="button" id="libGoExam">üìù Exam practice</button>
          <button class="btn" type="button" id="libGoSettings">‚öôÔ∏è Settings</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900;font-size:16px">üìö Topic tiles</div>
          <div class="note">Toggle topics to match what you‚Äôve covered in class.</div>
        </div>
        <div class="pill">Start where you are in class</div>
      </div>
      <div class="divider"></div>
      <div id="topicDash" class="topicDash"></div>
    </div>

    <div class="card">
      <div style="font-weight:800;font-size:16px">üß≠ Quick links</div>
      <div class="note" style="margin-top:4px">Jump straight into a mode.</div>
      <div class="divider"></div>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button class="btn primary" type="button" id="libStartStudy" style="flex:1;min-width:220px">Start Study</button>
        <button class="btn" type="button" id="libStartQuiz" style="flex:1;min-width:220px">Start Quiz</button>
        <button class="btn" type="button" id="libStartGames" style="flex:1;min-width:220px">Open Games</button>
      </div>
    </div>
  </section>


  <!-- STUDY -->
  <section id="study" class="tabpane hidden">
    <div class="studyWrap">
      <!-- FLASHCARD (shown first on mobile) -->
      <div class="card studyCard">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="pill" id="cardMeta">üÉè Card 0/0</div>
        </div>

        <div class="divider"></div>

        <div class="flashcardFrame fixedCard" id="flashcardFrame">
<p class="qText" id="qText" aria-live="polite">Choose a topic and press ‚ÄúReveal‚Äù.</p>

          <div id="aBox" class="aBox hidden">
            <div id="aText"></div>
          </div>
        </div>

        <button class="btn primary revealBand" id="btnRevealBand" aria-label="Reveal or hide answer">üëÄ Reveal answer</button>

        <div class="divider"></div>
<div class="emojiRow" style="margin-top:10px">
          <button class="btn emojiBtn" data-score="2" aria-label="Smiley (confident)" style="border-color: rgba(119,207,163,.55)">üòä</button>
          <button class="btn emojiBtn" data-score="1" aria-label="Neutral (unsure)" style="border-color: rgba(241,201,122,.55)">üòê</button>
          <button class="btn emojiBtn" data-score="0" aria-label="Sad (needs focus)" style="border-color: rgba(239,138,138,.55)">‚òπÔ∏è</button>
        </div>
      </div>

      <!-- MENUS / FILTERS (shown second on mobile) -->
      <div class="card studyControls">
        <div class="row">
          <div class="grow">
            <label>Topic</label>
            <select id="topicSelect"></select>
          </div>
          <div class="grow" style="min-width:170px">
            <label>Mode</label>
            <select id="modeSelect">
              <option value="all" selected>üé≤ All</option>
              <option value="focus">üéØ Focus</option>
            </select>
          </div>
          <div class="grow" style="min-width:160px">
            <label>Order</label>
            <select id="orderSelect">
              <option value="ordered" selected>üìå In order</option>
              <option value="random">üé≤ Random</option>
            </select>
          </div>
          <div class="grow">
            <label>Search (optional)</label>
            <input id="searchInput" placeholder="e.g. key term / study / evaluation" />
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- QUIZ -->
  <section id="quiz" class="tabpane hidden">
    <div class="card">
      <div class="row">
        <div class="grow">
          <label>Topic</label>
          <select id="mcqTopicSelect"></select>
        </div>
        <div class="grow" style="min-width:200px">
          <label>Number of questions</label>
          <select id="mcqCount">
            <option>10</option><option>15</option><option selected>20</option><option>30</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="btnStartQuiz">‚ö° Start quiz</button>
        </div>
      </div>

      <div class="divider"></div>

      <div id="quizEmpty" class="note">
        Your quiz score feeds the Home ‚ÄúProgress score‚Äù.
      </div>

      <div id="quizBox" class="hidden">
        <div class="row" style="justify-content:space-between">
          <div class="pill" id="quizMeta">Q 1/20</div>
          <div class="pill" id="quizScore">Score: 0</div>
        </div>

        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="pill" id="quizStreakPill">üî• Streak: 0</div>
          <div class="pill" id="quizBestStreakPill">üèÜ Best: 0</div>
        </div>

        <div class="divider"></div>

        <p class="qText" id="quizQ"></p>
        <div id="quizChoices" class="row" style="flex-direction:column;align-items:stretch"></div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between">
          <div class="note" id="quizExplainer">Pick an answer.</div>
          <button class="btn small" id="btnNextQ">‚û°Ô∏è Next</button>
        </div>
      </div>
    
      <div id="quizSummary" class="hidden" style="margin-top:14px">
        <div class="divider"></div>
        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900;font-size:16px">Quiz summary</div>
            <div class="note" id="quizSummaryNote">Nice work.</div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn primary" id="btnRetryWeak" type="button">üîÅ Retry weak set</button>
            <button class="btn" id="btnBackToToday" type="button">üè† Back to Today</button>
          </div>
        </div>
        <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px">
          <div class="pill">Accuracy: <span id="sumAcc">0%</span></div>
          <div class="pill">Best streak: <span id="sumBest">0</span></div>
          <div class="pill">Score: <span id="sumScore">0</span></div>
        </div>
      </div>
</div>
  </section>

  <!-- GAMES -->
  <section id="games" class="tabpane hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900;font-size:16px">üéÆ Games</div>
          <div class="note">Use these to stop ‚Äúmix-ups‚Äù between similar terms/people.</div>
        </div>
        <div class="pill" id="gamesTip">Dual coding + discrimination</div>
      </div>
    </div>

    <!-- Games hub: tap a pill to open a full game screen -->
    <div id="gamesHub" class="gamesHub">
      <button class="gamePillBtn" type="button" id="openConnBtn">
        <div class="gamePillTitle">Connections (Daily)</div>
        <div class="gamePillDesc">Select 4 linked terms. Solve 4 groups of 4 (4 mistakes max).</div>
      </button>

      <button class="gamePillBtn" type="button" id="openEmojiBtn">
        <div class="gamePillTitle">Emoji Multiple Choice</div>
        <div class="gamePillDesc">Pick the best answer from 4. Build accuracy + streaks.</div>
      </button>

      <button class="gamePillBtn" type="button" id="openMatchBtn">
        <div class="gamePillTitle">Match-Up</div>
        <div class="gamePillDesc">Match names to descriptions. Fast discrimination practice.</div>
      </button>

      <button class="gamePillBtn"const TOPICS = [
  { id:"t1", title:"1. Fall of the House of Lancaster (1450\u20131459)" },
  { id:"t2", title:"2. War of the Barons (1459\u20131461)" },
  { id:"t3", title:"3. Triumph of the Yorkists (1461\u20131471)" },
  { id:"t4", title:"4. \u2018Sun in Splendour\u2019: Edward IV (1471\u20131483)" },
  { id:"t5", title:"5. Downfall of the Yorkist Monarchy (1483\u20131486)" }
];tton" id="openTimelineBtn">
        <div class="gamePillTitle">Timeline Tension</div>
        <div class="gamePillDesc">Order key events. Dates reveal only after a perfect timeline.</div>
      </button>

      <button class="gamePillBtn" type="button" id="openFactorsBtn">
        <div class="gamePillTitle">Factors Face‚ÄëOff</div>
        <div class="gamePillDesc">Compare Yorkist strength vs Lancastrian weakness by factor.</div>
      </button>

    </div>

    <!-- Connections game screen -->
    <div id="gamesConnPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromConn">‚Üê Games</button>
      </div>
      <div class="connectionsCard" id="connectionsGame">
  <div class="connectionsTop">
    <h3>Connections (Daily)</h3>
    <div class="connectionsMeta">
      <label style="display:flex;gap:8px;align-items:center;font-weight:900;color:var(--muted);font-size:12px;">
        Topic
        <select id="connTopicSelect"></select>
      </label>

      <div class="mistakes" title="Mistakes remaining">
        Mistakes:
        <span class="mDot" id="m1"></span>
        <span class="mDot" id="m2"></span>
        <span class="mDot" id="m3"></span>
        <span class="mDot" id="m4"></span>
      </div>
    </div>
  </div>

  <div class="connectionsSolved" id="connSolved"></div>

  <div class="connectionsGrid" id="connGrid"></div>

  <div class="connectionsActions">
    <button class="connBtn" id="connClearBtn" type="button">Clear</button>
    <button class="connBtn primary" id="connSubmitBtn" type="button">Submit 4</button>
  </div>

  <div class="connMsg" id="connMsg"></div>

<div class="connWinOverlay hidden" id="connWinOverlay" aria-live="polite">
  <div class="connWinInner">
    <div class="connTrophy">üèÜ</div>
    <div>
      <div class="connWinTitle">Full game complete!</div>
      <div class="connWinSub">Nice work.</div>
    </div>
  </div>
</div>
</div>
    </div>

    <!-- Emoji game screen -->
    <div id="gamesEmojiPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromEmoji">‚Üê Games</button>
      </div>
      <div class="card">
      <div class="row">
        <div class="grow">
          <label>Topic</label>
          <select id="emojiTopicSelect"></select>
        </div>
        <div class="grow" style="min-width:200px">
          <label>Mode</label>
          <select id="emojiMode">
            <option value="terms" selected>Key terms</option>
            <option value="people">Key characters</option>
            <option value="mixed">Mixed</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="btnStartEmoji">üéØ New round</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div class="pill" id="emojiMeta">0 correct ‚Ä¢ 0 attempted</div>
        <div class="pill" id="emojiHelp">Pick the best answer from 4.</div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="pill" id="emojiStreakPill">üî• Streak: 0</div>
        <div class="pill" id="emojiBestStreakPill">üèÜ Best: 0</div>
      </div>

      <div class="divider"></div>

      <div style="font-size:36px;text-align:center;padding:14px;border:1px solid var(--line);border-radius:16px;background:#fff" id="emojiClue">üé≠ üß† üìö</div>
      <div class="choiceGrid" id="emojiChoices"></div>
    </div>
    </div>

    <!-- Match game screen -->
    <div id="gamesMatchPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromMatch">‚Üê Games</button>
      </div>
      <div class="card">
      <div class="row">
        <div class="grow">
          <label>Topic</label>
          <select id="matchTopicSelect"></select>
        </div>
        <div class="grow" style="min-width:200px">
          <label>Difficulty</label>
          <select id="matchDifficulty">
            <option value="8">8 pairs</option>
            <option value="10" selected>10 pairs</option>
            <option value="12">12 pairs</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="btnStartMatch">üß© New game</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div class="pill" id="matchMeta">Pairs: 0 ‚Ä¢ Correct: 0</div>
        <div class="pill" id="matchHelp">Pick a name, then a description.</div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="pill" id="matchStreakPill">üî• Streak: 0</div>
        <div class="pill" id="matchBestStreakPill">üèÜ Best: 0</div>
      </div>

      <div class="divider"></div>

      <div class="matchGrid">
        <div class="matchCol">
          <div class="note" style="margin-bottom:8px">Names</div>
          <div id="matchNames"></div>
        </div>
        <div class="matchCol">
          <div class="note" style="margin-bottom:8px">Descriptions</div>
          <div id="matchDescs"></div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="note">Mobile-friendly: each column scrolls internally (page stays stable).</div>
    </div>
    </div>
    <!-- Timeline Tension game screen -->
    <div id="gamesTimelinePane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromTimeline">‚Üê Games</button>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="grow" style="min-width:220px">
            <label>Topic</label>
            <select id="timelineTopicSelect"></select>
          </div>
          <div class="grow" style="min-width:220px">
            <label>Difficulty</label>
            <select id="timelineSize">
              <option value="6">6 events</option>
              <option value="8" selected>8 events</option>
              <option value="10">10 events</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end">
            <button class="btn primary" id="btnStartTimeline" type="button">‚è≥ New timeline</button>
            <button class="btn" id="btnResetTimeline" type="button">Reset</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="pill" id="timelineHelp">Place events in chronological order. Dates reveal only after a perfect timeline.</div>
          <button class="btn" id="btnCheckTimeline" type="button" disabled>‚úÖ Check timeline</button>
        </div>

        <div class="timelineLayout" style="margin-top:12px">
          <div class="timelineBank">
            <div class="note" style="margin:0 0 8px 0;font-weight:900">Unplaced events</div>
            <div id="timelinePool" class="timelinePool"></div>
          </div>

          <div class="timelineBoard">
            <div class="note" style="margin:0 0 8px 0;font-weight:900">Your timeline</div>
            <ol id="timelineSlots" class="timelineSlots"></ol>
            <div class="timelineMsg" id="timelineMsg"></div>
          </div>
        </div>

        <div class="tlWinOverlay hidden" id="tlWinOverlay" aria-live="polite">
          <div class="tlWinInner">
            <div class="tlTrophy">üèÜ</div>
            <div>
              <div class="tlWinTitle">Timeline complete!</div>
              <div class="tlWinSub">Dates unlocked ‚Äî nice work.</div>
            </div>
          </div>
        </div>

      </div>
    </div>

  
    <!-- Factors Face‚ÄëOff game screen -->
    <div id="gamesFactorsPane" class="gamePane hidden">
      <div class="gamePaneTop">
        <button class="btn" type="button" id="backFromFactors">‚Üê Games</button>
      </div>

      <div class="card">
        <div style="font-weight:900;font-size:16px">Factors Face‚ÄëOff</div>
        <div class="note" style="margin-top:6px">Yorkist strength vs Lancastrian weakness ‚Äî a quick comparative lens for exam argument.</div>

        <div class="divider"></div>

        <div class="note">Tap a row to toggle ‚Äústudy view‚Äù (hide/show one side) for self‚Äëtesting.</div>

        <div style="margin-top:10px; overflow:auto">
          <table class="miniTable" id="factorsTable" style="width:100%; border-collapse:separate; border-spacing:0">
            <thead>
              <tr>
                <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line)">Factor</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line)">Yorkist strength (Edward IV)</th>
                <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line)">Lancastrian weakness (Henry VI)</th>
              </tr>
            </thead>
            <tbody id="factorsTbody"></tbody>
          </table>
        </div>

        <div class="note" style="margin-top:10px">Tip: turn one column off, try to recall, then toggle back on.</div>
      </div>
    </div>
</section>
<!-- EXAM -->
  <section id="exam" class="tabpane hidden">
    <div class="card">
      <div style="font-weight:900;font-size:16px">üìù Exam (25-mark) practice</div>
      <div class="note" style="margin-top:6px">
        Exactly <b>3 questions per topic</b>. Select a question ‚Üí follow the plan ‚Üí only open Help if you‚Äôre really stuck.
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="grow">
          <label>Filter by topic</label>
          <select id="examTopicSelect"></select>
        </div>
        <div class="grow">
          <label>Question</label>
          <select id="examSelect"></select>
        </div>
      </div>

      <div class="divider"></div>

      <div style="border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff">
        <div class="note">25-mark question</div>
        <div class="qText" id="examQText">Pick a question to begin.</div>
        <div class="note" id="examTag" style="margin-top:6px"></div>
      </div>

      <div class="divider"></div>
      <div class="note">Suggested plan (use 3‚Äì4 factors)</div>
      <div id="examPlan" style="margin-top:10px"></div>

      <div class="divider"></div>

      <details id="examHelp" style="border:1px solid var(--line);border-radius:16px;padding:10px;background:#fff">
        <summary style="cursor:pointer;font-weight:900;list-style:none">üß∞ Help box (tap to reveal key knowledge)</summary>
        <div class="divider"></div>
        <div id="examHelpBody" class="note"></div>
      </details>
    </div>

    <div class="card">
      <div style="font-weight:900">Level 5 habits</div>
      <ul class="note" style="margin:10px 0 0 18px">
        <li><b>Stay on the wording</b> (‚Äúhalf-hearted‚Äù, ‚Äúmainly‚Äù, ‚Äúmore important than‚Äù).</li>
        <li><b>Factor structure</b>: 3‚Äì4 factors, each weighed (reach, timing, impact).</li>
        <li><b>Precise evidence</b>: dates + named policies + clear consequence.</li>
        <li><b>Judgement</b>: not just ‚Äúboth‚Äù ‚Äî explain why one matters more.</li>
      </ul>
    </div>
  </section>

  <!-- SETTINGS (includes Progress) -->
  <section id="settings" class="tabpane hidden">
    <div class="card">
      <div style="font-weight:900;font-size:16px">‚öôÔ∏è Settings</div>
      <div class="note" style="margin-top:6px">Progress lives here (export/import/reset).</div>

      <div class="divider"></div>

      <button class="btn" id="btnExport">üì§ Export progress</button>
      <button class="btn" id="btnImport" style="margin-left:8px">üì• Import progress</button>

      <div class="divider"></div>

      <label>Export / Import box</label>
      <textarea id="dataBox" rows="8" placeholder="Exported JSON will appear here. Paste JSON here to import."></textarea>

      <div class="divider"></div>

      <button class="btn" id="btnReset" style="border-color: rgba(239,138,138,.35);">üß® Reset all progress</button>
    </div>

    <div class="card">
      <div style="font-weight:900">Teacher notes</div>
      <div class="note" style="margin-top:10px">
        <ul style="margin:0 0 0 18px">
          <li>Quiz auto-generates 30+ questions per topic from FACT_BANK.</li>
          <li>Emoji clues are in EMOJI_BANK ‚Äî easy to expand.</li>
          <li>Exam questions are in EXAM_BANK (3 per topic enforced).</li>
        </ul>
      </div>
    </div>
  </section>

</main>

<!-- Bottom nav -->
<nav>
  <div class="navBtn active" data-tab="home">üè†<div>Today</div></div>
  <div class="navBtn" data-tab="study">üß†<div>Study</div></div>
  <div class="navBtn" data-tab="quiz">‚ö°<div>Quiz</div></div>
  <div class="navBtn" data-tab="games">üéÆ<div>Games</div></div>
  <div class="navBtn" data-tab="library">üìö<div>Library</div></div>
</nav>

<script>
/* ==========================================================
   TOPICS (SoW order)
   ========================================================== */
const TOPICS = [
  { id:"t1", title:"1. Topic 1" },
  { id:"t2", title:"2. Topic 2" },
  { id:"t3", title:"3. Topic 3" },
  { id:"t4", title:"4. Topic 4" }
];
/* ==================================== */
const FACT_BANK = {
  "t1": {
    "title": "1. Fall of the House of Lancaster (1450‚Äì1459)",
    "terms": [
      {
        "term": "Minority government",
        "meaning": "Period when Henry ruled as a child under regency councils.",
        "significance": "Early factional rivalries developed during this period, shaping later conflict.",
        "date": ""
      },
      {
        "term": "Royal authority",
        "meaning": "The recognised power of the monarch to govern effectively.",
        "significance": "Its decline in the 1450s encouraged nobles to pursue power independently.",
        "date": ""
      },
      {
        "term": "Personal rule",
        "meaning": "Direct governance by the monarch without strong oversight.",
        "significance": "Henry‚Äôs ineffective personal rule deepened dissatisfaction among nobles.",
        "date": ""
      },
      {
        "term": "Magnates",
        "meaning": "The most powerful nobles controlling large estates and armed retainers.",
        "significance": "Their rivalries became the main drivers of civil war.",
        "date": ""
      },
      {
        "term": "Bastard feudalism",
        "meaning": "System where loyalty was secured through contracts and payment.",
        "significance": "Allowed nobles to raise private armies during the wars.",
        "date": ""
      },
      {
        "term": "Livery and maintenance",
        "meaning": "Distribution of badges and protection to retainers.",
        "significance": "Increased lawlessness and noble military strength.",
        "date": ""
      },
      {
        "term": "Affinity",
        "meaning": "A noble‚Äôs network of supporters and retainers.",
        "significance": "Determined the scale of support available in battle.",
        "date": ""
      },
      {
        "term": "Hundred Years‚Äô War",
        "meaning": "Long conflict between England and France (1337‚Äì1453).",
        "significance": "Its costly failures damaged Lancastrian prestige.",
        "date": "1337"
      },
      {
        "term": "Royal financial crisis",
        "meaning": "Chronic shortage of Crown income.",
        "significance": "Limited Henry‚Äôs ability to control the nobility.",
        "date": ""
      },
      {
        "term": "Corruption",
        "meaning": "Abuse of office for personal gain.",
        "significance": "Blamed on Lancastrian favourites, undermining legitimacy.",
        "date": ""
      },
      {
        "term": "Richard, Duke of York",
        "meaning": "Senior noble with a strong dynastic claim to the throne.",
        "significance": "His challenge transformed factional rivalry into dynastic conflict.",
        "date": ""
      },
      {
        "term": "Dynastic claim",
        "meaning": "Hereditary right to the throne.",
        "significance": "York‚Äôs claim undermined Lancastrian legitimacy.",
        "date": ""
      },
      {
        "term": "House of York",
        "meaning": "Royal line descended from Lionel of Antwerp.",
        "significance": "Offered an alternative ruling dynasty.",
        "date": ""
      },
      {
        "term": "House of Lancaster",
        "meaning": "Royal line descended from John of Gaunt.",
        "significance": "Its legitimacy was increasingly questioned.",
        "date": ""
      },
      {
        "term": "Mortimer claim",
        "meaning": "York‚Äôs claim through the senior line of Edward III.",
        "significance": "Provided a legal basis for Yorkist challenge.",
        "date": ""
      },
      {
        "term": "Somerset faction",
        "meaning": "Group supporting Edmund Beaufort.",
        "significance": "Rivalry with York led directly to armed conflict.",
        "date": ""
      },
      {
        "term": "Duke of Somerset",
        "meaning": "Lancastrian favourite blamed for French defeats.",
        "significance": "His death at St Albans escalated hostilities.",
        "date": ""
      },
      {
        "term": "Exclusion from office",
        "meaning": "York denied influence at court.",
        "significance": "Fuelled resentment and rebellion.",
        "date": ""
      },
      {
        "term": "Lancastrian defeat",
        "meaning": "Loss of key nobles.",
        "significance": "Deepened the cycle of revenge.",
        "date": ""
      },
      {
        "term": "Second Protectorate",
        "meaning": "York resumed control after St Albans.",
        "significance": "Increased mistrust between factions.",
        "date": ""
      },
      {
        "term": "Civil war",
        "meaning": "Armed conflict within England.",
        "significance": "Destabilised governance and society.",
        "date": ""
      },
      {
        "term": "Queen‚Äôs faction",
        "meaning": "Political group centred on Margaret.",
        "significance": "Hardened factional divisions.",
        "date": ""
      },
      {
        "term": "Prince Edward of Westminster",
        "meaning": "Lancastrian heir.",
        "significance": "Secured succession but intensified Yorkist fears.",
        "date": ""
      },
      {
        "term": "Factional rivalry",
        "meaning": "Competition between noble groups.",
        "significance": "Prevented lasting peace.",
        "date": ""
      },
      {
        "term": "Court politics",
        "meaning": "Struggles for influence at court.",
        "significance": "Sustained instability.",
        "date": ""
      },
      {
        "term": "Kingmaker",
        "meaning": "Title given to Warwick.",
        "significance": "Illustrates the dominance of noble power over monarchy.",
        "date": ""
      },
      {
        "term": "Calais garrison",
        "meaning": "Strategic English base controlled by Warwick.",
        "significance": "Provided crucial military resources.",
        "date": ""
      },
      {
        "term": "Private army",
        "meaning": "Forces raised by nobles.",
        "significance": "Enabled sustained civil conflict.",
        "date": ""
      },
      {
        "term": "Attainder",
        "meaning": "Parliamentary act stripping lands for treason.",
        "significance": "Used to punish defeated enemies.",
        "date": ""
      },
      {
        "term": "Legitimacy",
        "meaning": "Accepted right to rule.",
        "significance": "Core issue driving the conflict.",
        "date": ""
      },
      {
        "term": "Usurpation",
        "meaning": "Seizing the throne unlawfully.",
        "significance": "Lancastrian rule stemmed from Henry IV‚Äôs usurpation.",
        "date": ""
      },
      {
        "term": "Authority",
        "meaning": "Power to command obedience.",
        "significance": "Weak authority invited rebellion.",
        "date": ""
      },
      {
        "term": "Dynastic instability",
        "meaning": "Uncertainty over succession.",
        "significance": "Sustained conflict.",
        "date": ""
      },
      {
        "term": "Percy‚ÄìNeville feud",
        "meaning": "Northern noble rivalry.",
        "significance": "Demonstrated how local feuds fed national war.",
        "date": ""
      },
      {
        "term": "Justices of the Peace",
        "meaning": "Local law officials.",
        "significance": "Struggled to maintain order.",
        "date": ""
      },
      {
        "term": "Regional rivalry",
        "meaning": "Conflicts between powerful families.",
        "significance": "Escalated tensions nationally.",
        "date": ""
      },
      {
        "term": "Blood feud",
        "meaning": "Cycle of revenge killings.",
        "significance": "Made reconciliation difficult.",
        "date": ""
      },
      {
        "term": "Political propaganda",
        "meaning": "Justifications for rebellion.",
        "significance": "Framed war as defence of the realm.",
        "date": ""
      },
      {
        "term": "Common people",
        "meaning": "Non-noble population.",
        "significance": "Often caught in disorder and economic strain.",
        "date": ""
      },
      {
        "term": "Taxation grievances",
        "meaning": "Complaints over royal demands.",
        "significance": "Increased hostility to Lancastrian rule.",
        "date": ""
      },
      {
        "term": "Urban unrest",
        "meaning": "Disorder in towns like London.",
        "significance": "Demonstrated national instability.",
        "date": ""
      },
      {
        "term": "Gentry",
        "meaning": "Lesser landowners below nobility.",
        "significance": "Key supporters in local power struggles.",
        "date": ""
      },
      {
        "term": "Marcher lordships",
        "meaning": "Powerful border territories.",
        "significance": "Provided York with strong regional bases.",
        "date": ""
      },
      {
        "term": "Feudal loyalty",
        "meaning": "Obligation to support one‚Äôs lord.",
        "significance": "Bound retainers to factional armies.",
        "date": ""
      },
      {
        "term": "Armed retinue",
        "meaning": "Group of noble soldiers.",
        "significance": "Enabled rapid mobilisation.",
        "date": ""
      },
      {
        "term": "Royal summons",
        "meaning": "Order to provide troops.",
        "significance": "Often ignored, showing weak control.",
        "date": ""
      },
      {
        "term": "Pardon",
        "meaning": "Royal forgiveness.",
        "significance": "Used to attempt reconciliation.",
        "date": ""
      },
      {
        "term": "Exile",
        "meaning": "Forced departure of nobles.",
        "significance": "Often temporary before renewed conflict.",
        "date": ""
      },
      {
        "term": "Noble exile alliances",
        "meaning": "Temporary foreign alliances.",
        "significance": "Prolonged the wars.",
        "date": ""
      },
      {
        "term": "Foreign support (France/Burgundy)",
        "meaning": "Continental involvement.",
        "significance": "Influenced outcomes of campaigns.",
        "date": ""
      },
      {
        "term": "Blood royal",
        "meaning": "Direct descent from Edward III.",
        "significance": "Basis of dynastic claims.",
        "date": ""
      },
      {
        "term": "Chivalric culture",
        "meaning": "Ideals of knightly honour.",
        "significance": "Justified noble participation in battle.",
        "date": ""
      },
      {
        "term": "Military contracts",
        "meaning": "Agreements binding retainers.",
        "significance": "Structured noble armies.",
        "date": ""
      },
      {
        "term": "Authority vs faction",
        "meaning": "Struggle between monarchy and nobles.",
        "significance": "Central dynamic of the wars.",
        "date": ""
      },
      {
        "term": "Balance of military power",
        "meaning": "Relative strength of factions.",
        "significance": "Determined shifts in control.",
        "date": ""
      },
      {
        "term": "Political breakdown",
        "meaning": "Collapse of effective governance.",
        "significance": "Characterised the 1450s.",
        "date": ""
      },
      {
        "term": "Legitimacy crisis",
        "meaning": "Doubts over rightful rule.",
        "significance": "Fuelled dynastic war.",
        "date": ""
      },
      {
        "term": "Factionalism",
        "meaning": "Persistent noble rivalry.",
        "significance": "Prevented stability.",
        "date": ""
      },
      {
        "term": "Succession dispute",
        "meaning": "Disagreement over inheritance of the throne.",
        "significance": "Core cause of war.",
        "date": ""
      },
      {
        "term": "Retainer system",
        "meaning": "Contract-based noble following.",
        "significance": "Sustained armed conflict.",
        "date": ""
      },
      {
        "term": "Regional power bases",
        "meaning": "Strongholds of noble families.",
        "significance": "Enabled mobilisation.",
        "date": ""
      },
      {
        "term": "White Rose",
        "meaning": "Symbol of York.",
        "significance": "Represented Yorkist identity.",
        "date": ""
      },
      {
        "term": "Red Rose",
        "meaning": "Symbol of Lancaster.",
        "significance": "Represented Lancastrian cause.",
        "date": ""
      },
      {
        "term": "Heraldry",
        "meaning": "Coats of arms identifying nobles.",
        "significance": "Reinforced factional loyalty.",
        "date": ""
      },
      {
        "term": "Badge system",
        "meaning": "Noble symbols worn by retainers.",
        "significance": "Marked political allegiance.",
        "date": ""
      },
      {
        "term": "Standard-bearing",
        "meaning": "Display of faction banners.",
        "significance": "Symbolised open conflict.",
        "date": ""
      },
      {
        "term": "Lancastrian loyalty",
        "meaning": "Allegiance to Henry VI.",
        "significance": "Sustained resistance.",
        "date": ""
      },
      {
        "term": "Restored monarchy",
        "meaning": "Henry‚Äôs brief return.",
        "significance": "Demonstrated unresolved tensions.",
        "date": ""
      },
      {
        "term": "Consolidation of power",
        "meaning": "Edward IV securing his rule after 1471.",
        "significance": "Marked the end of the first phase of conflict.",
        "date": "1471"
      }
    ],
    "people": [
      {
        "term": "Henry VI",
        "meaning": "King of England whose pious character, poor leadership and periods of mental illness weakened royal authority.",
        "significance": "His weakness created the political instability that allowed noble factions to challenge the Crown.",
        "date": ""
      },
      {
        "term": "Overmighty subjects",
        "meaning": "Nobles whose power rivalled that of the king.",
        "significance": "Figures such as Warwick threatened the supremacy of the Crown.",
        "date": ""
      },
      {
        "term": "Royal patronage",
        "meaning": "Grants of land, offices and rewards by the king.",
        "significance": "Henry‚Äôs biased patronage fuelled resentment and factional conflict.",
        "date": ""
      },
      {
        "term": "Jack Cade",
        "meaning": "Leader of the 1450 rebellion in Kent.",
        "significance": "Exposed widespread dissatisfaction with Lancastrian rule.",
        "date": "1450"
      },
      {
        "term": "Good governance",
        "meaning": "Expectation that the king rule justly and competently.",
        "significance": "Used by Yorkists to justify political intervention.",
        "date": ""
      },
      {
        "term": "Commonweal",
        "meaning": "The welfare of the kingdom as a whole.",
        "significance": "Became a rhetorical justification for rebellion.",
        "date": ""
      },
      {
        "term": "Yorkist victory",
        "meaning": "Defeat of Lancastrian leadership.",
        "significance": "Shifted political dominance to York.",
        "date": ""
      },
      {
        "term": "Margaret of Anjou",
        "meaning": "Queen of Henry VI and Lancastrian leader.",
        "significance": "Became the driving force of Lancastrian resistance.",
        "date": ""
      },
      {
        "term": "Edward IV",
        "meaning": "Yorkist king crowned in 1461.",
        "significance": "Replaced Lancastrian rule with Yorkist dominance.",
        "date": "1461"
      },
      {
        "term": "Richard Neville, Earl of Warwick",
        "meaning": "Powerful Yorkist noble known as ‚ÄúKingmaker.‚Äù",
        "significance": "Played a decisive role in placing Edward IV on the throne.",
        "date": ""
      },
      {
        "term": "Hierarchy",
        "meaning": "Social order placing king at the top.",
        "significance": "Breakdown led to disorder.",
        "date": ""
      },
      {
        "term": "Power vacuum",
        "meaning": "Absence of strong leadership.",
        "significance": "Enabled York‚Äôs rise.",
        "date": ""
      },
      {
        "term": "Monarchical weakness",
        "meaning": "Failure of effective kingship.",
        "significance": "Primary long-term cause.",
        "date": ""
      }
    ],
    "events": [
      {
        "term": "Loss of Normandy (1450)",
        "meaning": "Final defeat of English forces in Normandy.",
        "significance": "Sparked anger at royal advisers and weakened confidence in Henry.",
        "date": "1450"
      },
      {
        "term": "Loss of Gascony (1453)",
        "meaning": "Fall of Bordeaux ending English claims in France.",
        "significance": "Contributed directly to Henry VI‚Äôs mental breakdown.",
        "date": "1453"
      },
      {
        "term": "Economic depression (1450s)",
        "meaning": "Trade decline and unemployment.",
        "significance": "Increased social unrest and support for reformist causes.",
        "date": ""
      },
      {
        "term": "Cade‚Äôs Rebellion (1450)",
        "meaning": "Popular uprising demanding reform and removal of corrupt officials.",
        "significance": "Demonstrated how fragile royal authority had become.",
        "date": "1450"
      },
      {
        "term": "Protectorate (1454‚Äì55)",
        "meaning": "York ruling during Henry‚Äôs incapacity.",
        "significance": "Strengthened York‚Äôs political authority.",
        "date": "1454"
      },
      {
        "term": "Mental breakdown (1453)",
        "meaning": "Henry VI‚Äôs period of incapacity.",
        "significance": "Created a power vacuum.",
        "date": "1453"
      },
      {
        "term": "First Battle of St Albans (1455)",
        "meaning": "First armed clash between Yorkists and Lancastrians.",
        "significance": "Marked the beginning of open civil war.",
        "date": "1455"
      },
      {
        "term": "Act of Accord (1460)",
        "meaning": "Agreement naming York heir to the throne.",
        "significance": "Disinherited Prince Edward and ensured continued war.",
        "date": "1460"
      },
      {
        "term": "Battle of Northampton (1460)",
        "meaning": "Yorkist victory capturing Henry VI.",
        "significance": "Demonstrated Yorkist military superiority.",
        "date": "1460"
      },
      {
        "term": "Battle of Wakefield (1460)",
        "meaning": "Lancastrian victory killing York.",
        "significance": "Intensified dynastic blood feud.",
        "date": "1460"
      },
      {
        "term": "Battle of Towton (1461)",
        "meaning": "Decisive Yorkist victory.",
        "significance": "Secured the throne for Edward IV.",
        "date": "1461"
      },
      {
        "term": "Battle of Barnet (1471)",
        "meaning": "Yorkist victory over Warwick.",
        "significance": "Ended Warwick‚Äôs challenge.",
        "date": "1471"
      },
      {
        "term": "Battle of Tewkesbury (1471)",
        "meaning": "Yorkist victory killing Prince Edward.",
        "significance": "Ended the direct Lancastrian line.",
        "date": "1471"
      },
      {
        "term": "Lancastrian collapse (1471)",
        "meaning": "Final defeat of Henry VI‚Äôs supporters.",
        "significance": "Secured Yorkist supremacy.",
        "date": "1471"
      },
      {
        "term": "Restoration of Henry VI (1470)",
        "meaning": "Brief return to throne.",
        "significance": "Showed fragility of Edward IV‚Äôs rule.",
        "date": "1470"
      },
      {
        "term": "Readeption (1470‚Äì71)",
        "meaning": "Period of Henry VI‚Äôs restoration.",
        "significance": "Demonstrated continued instability.",
        "date": "1470"
      },
      {
        "term": "Yorkist supremacy (1461‚Äì1470)",
        "meaning": "Period of Edward IV‚Äôs rule.",
        "significance": "Showed temporary resolution.",
        "date": "1461"
      },
      {
        "term": "Civil conflict (1455‚Äì1471)",
        "meaning": "Series of dynastic wars between Lancaster and York.",
        "significance": "Reshaped English monarchy and noble power structures.",
        "date": "1455"
      },
      {
        "term": "Percy‚ÄìNeville Feud (1453‚Äì1454)",
        "meaning": "Violent rivalry between the Percy and Neville families in northern England, involving armed clashes and competition for regional dominance.",
        "significance": "The feud demonstrated the breakdown of royal authority in the localities and helped draw powerful magnates like the Earl of Warwick into national factional conflict, escalating tensions that contributed directly to the outbreak of the Wars of the Roses.",
        "date": "1453"
      }
    ]
  },
  "t2": {
    "title": "2. War of the Barons (1459‚Äì1461)",
    "terms": [
      {
        "term": "York‚Äôs Flight to Ireland",
        "meaning": "York escaped after Ludford.",
        "significance": "Preserved the Yorkist claim for future return.",
        "date": ""
      },
      {
        "term": "Warwick‚Äôs Flight to Calais",
        "meaning": "Warwick withdrew to his stronghold.",
        "significance": "Allowed Yorkists to regroup with naval support.",
        "date": ""
      },
      {
        "term": "Attainder",
        "meaning": "Legal confiscation of lands and titles for treason.",
        "significance": "Forced Yorkists into outright rebellion.",
        "date": ""
      },
      {
        "term": "Richard Neville, Earl of Warwick",
        "meaning": "Leading Yorkist magnate and commander.",
        "significance": "Became central to Yorkist military and political recovery.",
        "date": ""
      },
      {
        "term": "‚ÄòThe Kingmaker‚Äô",
        "meaning": "Title reflecting Warwick‚Äôs power to influence succession.",
        "significance": "Shows the dominance of magnates in this phase of war.",
        "date": ""
      },
      {
        "term": "Calais Garrison",
        "meaning": "English base under Warwick‚Äôs control.",
        "significance": "Provided troops and strategic advantage.",
        "date": ""
      },
      {
        "term": "Naval Control of the Channel",
        "meaning": "Warwick‚Äôs maritime dominance.",
        "significance": "Enabled Yorkist invasion in 1460.",
        "date": ""
      },
      {
        "term": "Royal Captivity",
        "meaning": "Henry held by Yorkists.",
        "significance": "Undermined Lancastrian legitimacy.",
        "date": ""
      },
      {
        "term": "Legitimacy Crisis",
        "meaning": "Doubts over rightful succession.",
        "significance": "Divided the political nation.",
        "date": ""
      },
      {
        "term": "Prince Edward of Westminster",
        "meaning": "Lancastrian heir disinherited.",
        "significance": "His exclusion intensified civil war.",
        "date": ""
      },
      {
        "term": "Northern Coalition",
        "meaning": "Lancastrian alliance of northern nobles.",
        "significance": "Enabled revival after York‚Äôs claim.",
        "date": ""
      },
      {
        "term": "Death of Richard of York",
        "meaning": "York killed in battle.",
        "significance": "Radicalised Yorkist leadership.",
        "date": ""
      },
      {
        "term": "Death of Edmund, Earl of Rutland",
        "meaning": "York‚Äôs son killed.",
        "significance": "Hardened Yorkist resolve.",
        "date": ""
      },
      {
        "term": "London‚Äôs Resistance",
        "meaning": "City barred Margaret‚Äôs army.",
        "significance": "Allowed Yorkists to regroup.",
        "date": ""
      },
      {
        "term": "Lancastrian Collapse at Towton",
        "meaning": "Heavy casualties and retreat.",
        "significance": "Broke organised Lancastrian resistance.",
        "date": ""
      },
      {
        "term": "Exile of Henry and Margaret",
        "meaning": "Flight to Scotland.",
        "significance": "Confirmed Yorkist supremacy by 1461.",
        "date": ""
      },
      {
        "term": "Military Leadership",
        "meaning": "Capable commanders like Warwick and Edward.",
        "significance": "Delivered battlefield success.",
        "date": ""
      },
      {
        "term": "Naval Superiority",
        "meaning": "Control of sea routes.",
        "significance": "Prevented Lancastrian reinforcement.",
        "date": ""
      },
      {
        "term": "Clear Dynastic Claim",
        "meaning": "Edward‚Äôs hereditary legitimacy.",
        "significance": "Strengthened Yorkist authority.",
        "date": ""
      },
      {
        "term": "Magnate Alliances",
        "meaning": "Support from key noble families.",
        "significance": "Consolidated Yorkist power.",
        "date": ""
      },
      {
        "term": "Northern Hostility",
        "meaning": "Continued Lancastrian sympathy.",
        "significance": "Threatened stability.",
        "date": ""
      },
      {
        "term": "Reliance on Warwick",
        "meaning": "Heavy dependence on one magnate.",
        "significance": "Risked future factional instability.",
        "date": ""
      },
      {
        "term": "Usurpation",
        "meaning": "Seizing the throne unlawfully.",
        "significance": "Question underlying Edward‚Äôs accession.",
        "date": ""
      },
      {
        "term": "Blood Feud",
        "meaning": "Cycle of vengeance between families.",
        "significance": "Hardened divisions post-Wakefield.",
        "date": ""
      },
      {
        "term": "Political Nation",
        "meaning": "Elite nobles and gentry.",
        "significance": "Divided loyalties shaped outcomes.",
        "date": ""
      },
      {
        "term": "Military Retinue",
        "meaning": "Contracted noble troops.",
        "significance": "Sustained campaigning.",
        "date": ""
      },
      {
        "term": "Scottish Alliance",
        "meaning": "Margaret‚Äôs support from Scotland.",
        "significance": "Extended Lancastrian resistance.",
        "date": ""
      },
      {
        "term": "Marcher Lords",
        "meaning": "Powerful border nobles.",
        "significance": "Strengthened Yorkist base.",
        "date": ""
      },
      {
        "term": "Confiscation of Lands",
        "meaning": "Redistribution after victory.",
        "significance": "Rewarded loyalty and punished enemies.",
        "date": ""
      },
      {
        "term": "Oath of Allegiance",
        "meaning": "Swearing loyalty to Edward IV.",
        "significance": "Secured political recognition.",
        "date": ""
      },
      {
        "term": "Elite Defections",
        "meaning": "Nobles switching sides.",
        "significance": "Shaped military outcomes.",
        "date": ""
      },
      {
        "term": "Political Settlement Attempts",
        "meaning": "Efforts at compromise.",
        "significance": "Failed to prevent escalation.",
        "date": ""
      },
      {
        "term": "Magnate Rivalry",
        "meaning": "Competition among powerful nobles.",
        "significance": "Underpinned instability.",
        "date": ""
      },
      {
        "term": "Authority",
        "meaning": "Power to command obedience.",
        "significance": "Contested throughout 1459‚Äì61.",
        "date": ""
      },
      {
        "term": "Factionalism",
        "meaning": "Persistent noble rivalry.",
        "significance": "Drove continuation of war.",
        "date": ""
      },
      {
        "term": "Dynastic Conflict",
        "meaning": "War over rightful succession.",
        "significance": "Core cause of violence.",
        "date": ""
      },
      {
        "term": "Military Logistics",
        "meaning": "Organisation of armies.",
        "significance": "Crucial to Towton victory.",
        "date": ""
      },
      {
        "term": "Snowstorm at Towton",
        "meaning": "Weather conditions aiding Yorkists.",
        "significance": "Tactical advantage.",
        "date": ""
      },
      {
        "term": "Rout at Towton",
        "meaning": "Lancastrian retreat turned massacre.",
        "significance": "Decisive destruction of opposition.",
        "date": ""
      },
      {
        "term": "Exile Networks",
        "meaning": "Lancastrian supporters abroad.",
        "significance": "Maintained alternative claim.",
        "date": ""
      },
      {
        "term": "Restoration Threat",
        "meaning": "Possibility of Henry‚Äôs return.",
        "significance": "Undermined Yorkist security.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Royal Justice",
        "meaning": "The Crown‚Äôs authority to enforce law and order across the realm.",
        "significance": "Its breakdown during 1459‚Äì61 demonstrated how magnate conflict had overtaken central authority.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Reward Network",
        "meaning": "Distribution of lands and offices to loyal Yorkists after victory.",
        "significance": "Helped secure loyalty but increased dependence on key magnates.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Attainders after Towton",
        "meaning": "Parliamentary punishment of leading Lancastrians.",
        "significance": "Eliminated opposition but deepened long-term divisions.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Confiscated Estates",
        "meaning": "Lands seized from defeated Lancastrians.",
        "significance": "Strengthened Yorkist supporters and reshaped noble power structures.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Lancastrian Exile Court",
        "meaning": "Henry VI and Margaret‚Äôs supporters operating from Scotland and France.",
        "significance": "Maintained an alternative dynastic claim after 1461.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Scottish Support for Lancaster",
        "meaning": "Military backing from Scotland.",
        "significance": "Prolonged instability in northern England.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Burgundian Diplomacy",
        "meaning": "Edward IV‚Äôs relationship with Burgundy.",
        "significance": "Provided crucial foreign recognition and potential support.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Northern Garrison Control",
        "meaning": "Yorkist military presence in the north.",
        "significance": "Necessary to suppress ongoing Lancastrian resistance.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Submission of Nobles",
        "meaning": "Former Lancastrians accepting Edward‚Äôs rule.",
        "significance": "Demonstrated shifting loyalties for survival.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Elite Pragmatism",
        "meaning": "Nobles changing sides for political advantage.",
        "significance": "Shaped the outcomes of battles and political settlements.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Military Patronage",
        "meaning": "Rewarding commanders for battlefield success.",
        "significance": "Reinforced Yorkist leadership structure.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Magnate Dependency",
        "meaning": "Edward‚Äôs reliance on powerful nobles like Warwick.",
        "significance": "Created potential instability within the Yorkist regime.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Factional Continuity",
        "meaning": "Persistence of noble rivalries despite regime change.",
        "significance": "Suggested Towton did not fully resolve political tensions.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Political Reconciliation Attempts",
        "meaning": "Efforts to stabilise relations with former enemies.",
        "significance": "Necessary for consolidation but often fragile.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Restoration Threat (Post-1461)",
        "meaning": "Continued possibility of Henry VI‚Äôs return.",
        "significance": "Undermined complete Yorkist security.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Dynastic Legitimisation",
        "meaning": "Parliamentary confirmation of Edward‚Äôs title.",
        "significance": "Strengthened legal basis of his kingship.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Military Exhaustion",
        "meaning": "Strain caused by sustained campaigning.",
        "significance": "Affected both factions‚Äô capacity for prolonged conflict.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Economic Strain of War",
        "meaning": "Financial burden of military mobilisation.",
        "significance": "Pressured the Crown and political nation.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Urban Loyalty (London)",
        "meaning": "Support from the capital city.",
        "significance": "Crucial to Edward‚Äôs proclamation and legitimacy.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Snowstorm at Towton",
        "meaning": "Severe weather affecting battle tactics.",
        "significance": "Gave Yorkists a strategic advantage.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Lancastrian Rout at Towton",
        "meaning": "Disorganised retreat turned massacre.",
        "significance": "Decisively weakened Lancastrian military strength.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Bloodshed at Towton",
        "meaning": "Extremely high casualties.",
        "significance": "Demonstrated the intensity and brutality of the conflict.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Baronial War",
        "meaning": "Conflict dominated by magnate leadership rather than popular revolt.",
        "significance": "Highlights the central role of noble power in 1459‚Äì61.",
        "date": ""
      },
      {
        "term": "ÔÇ∑  Authority vs Magnate Power",
        "meaning": "Ongoing struggle between monarchy and leading nobles.",
        "significance": "Defined the structural weakness of English kingship in this period.",
        "date": ""
      }
    ],
    "people": [
      {
        "term": "Kentish Support",
        "meaning": "Popular backing in south-east England.",
        "significance": "Strengthened Yorkist manpower.",
        "date": ""
      },
      {
        "term": "Margaret of Anjou",
        "meaning": "Leader of Lancastrian resistance.",
        "significance": "Organised northern forces to challenge York.",
        "date": ""
      },
      {
        "term": "Edward IV",
        "meaning": "Son of York proclaimed king in March 1461.",
        "significance": "Shifted Yorkist aim from reform to regime change.",
        "date": "1461"
      },
      {
        "term": "Dynastic Continuity",
        "meaning": "Transfer of leadership from York to Edward.",
        "significance": "Ensured Yorkist cause survived Wakefield.",
        "date": ""
      },
      {
        "term": "Southern Support Base",
        "meaning": "Backing from London and merchants.",
        "significance": "Provided financial stability.",
        "date": ""
      },
      {
        "term": "Henry VI Alive",
        "meaning": "Lancastrian claimant survived.",
        "significance": "Allowed possibility of restoration.",
        "date": ""
      },
      {
        "term": "Foreign Diplomacy",
        "meaning": "Seeking continental backing.",
        "significance": "Influenced military strength.",
        "date": ""
      },
      {
        "term": "Hierarchy",
        "meaning": "Social order with king at top.",
        "significance": "Undermined by baronial dominance.",
        "date": ""
      }
    ],
    "events": [
      {
        "term": "Renewal of War (1459)",
        "meaning": "The collapse of the uneasy peace between Yorkists and Lancastrians.",
        "significance": "Marked the shift from factional tension to sustained civil conflict.",
        "date": "1459"
      },
      {
        "term": "Battle of Blore Heath (1459)",
        "meaning": "Yorkist victory led by Salisbury.",
        "significance": "Showed Yorkist forces were still militarily capable.",
        "date": "1459"
      },
      {
        "term": "Battle of Ludford Bridge (1459)",
        "meaning": "Lancastrian victory forcing Yorkist retreat.",
        "significance": "Temporarily restored Lancastrian dominance and drove York into exile.",
        "date": "1459"
      },
      {
        "term": "Parliament of Devils (1459)",
        "meaning": "Lancastrian parliament issuing attainders against Yorkists.",
        "significance": "Deepened divisions and made compromise impossible.",
        "date": "1459"
      },
      {
        "term": "Lancastrian Supremacy (1459)",
        "meaning": "Period of apparent restoration of Henry VI‚Äôs control.",
        "significance": "Demonstrated the instability of power before Yorkist resurgence.",
        "date": "1459"
      },
      {
        "term": "Yorkist Manifestos (1460)",
        "meaning": "Public declarations justifying return.",
        "significance": "Framed rebellion as defence of good governance.",
        "date": "1460"
      },
      {
        "term": "Battle of Northampton (1460)",
        "meaning": "Yorkist victory capturing Henry VI.",
        "significance": "Gave Yorkists control of the Crown‚Äôs authority.",
        "date": "1460"
      },
      {
        "term": "Political Vacuum (1460)",
        "meaning": "Lack of effective Lancastrian leadership.",
        "significance": "Enabled York to assert his dynastic claim.",
        "date": "1460"
      },
      {
        "term": "York‚Äôs Claim to the Throne (1460)",
        "meaning": "Public assertion of kingship.",
        "significance": "Escalated conflict into open dynastic revolution.",
        "date": "1460"
      },
      {
        "term": "Act of Accord (1460)",
        "meaning": "Settlement naming York heir instead of Prince Edward.",
        "significance": "Ensured Lancastrian resistance would continue.",
        "date": "1460"
      },
      {
        "term": "Protector of England (1460)",
        "meaning": "York ruling during Henry‚Äôs lifetime.",
        "significance": "Attempted compromise between loyalty and ambition.",
        "date": "1460"
      },
      {
        "term": "Battle of Wakefield (1460)",
        "meaning": "Lancastrian victory killing York.",
        "significance": "Turned conflict into blood feud.",
        "date": "1460"
      },
      {
        "term": "Lancastrian Momentum (1460‚Äì61)",
        "meaning": "Period of military success.",
        "significance": "Threatened Yorkist survival.",
        "date": "1460"
      },
      {
        "term": "Second Battle of St Albans (1461)",
        "meaning": "Lancastrian victory freeing Henry VI.",
        "significance": "Temporarily restored Lancastrian authority.",
        "date": "1461"
      },
      {
        "term": "Restoration of Henry VI (1461)",
        "meaning": "Henry returned to Lancastrian control.",
        "significance": "Demonstrated fluidity of power.",
        "date": "1461"
      },
      {
        "term": "Proclamation of Edward IV (1461)",
        "meaning": "Formal declaration in London.",
        "significance": "Cemented Yorkist dynastic ambition.",
        "date": "1461"
      },
      {
        "term": "Battle of Towton (1461)",
        "meaning": "Largest and bloodiest battle of the conflict.",
        "significance": "Secured Edward IV‚Äôs throne decisively.",
        "date": "1461"
      },
      {
        "term": "Rebellion",
        "meaning": "Armed resistance to royal authority.",
        "significance": "Normalised as political method.",
        "date": ""
      },
      {
        "term": "Parliamentary Legitimisation (1461)",
        "meaning": "Parliament confirming Edward‚Äôs rule.",
        "significance": "Strengthened legal authority.",
        "date": "1461"
      },
      {
        "term": "Northern Resistance (1461)",
        "meaning": "Continued uprisings.",
        "significance": "Demonstrated incomplete consolidation.",
        "date": "1461"
      },
      {
        "term": "Consolidation of Yorkist Rule (1461)",
        "meaning": "Securing authority after victory.",
        "significance": "Marked end of War of the Barons phase.",
        "date": "1461"
      },
      {
        "term": "ÔÇ∑  Reassertion of Royal Authority (1461)",
        "meaning": "Edward IV‚Äôs efforts to restore effective monarchy after Towton.",
        "significance": "Essential for stabilising Yorkist rule following years of baronial dominance.",
        "date": "1461"
      },
      {
        "term": "ÔÇ∑  French Neutrality (1461)",
        "meaning": "Limited early French intervention.",
        "significance": "Reduced immediate foreign threat to Edward‚Äôs rule.",
        "date": "1461"
      },
      {
        "term": "ÔÇ∑  Political Oaths (1461)",
        "meaning": "Nobles swearing loyalty to Edward IV.",
        "significance": "Helped formalise acceptance of Yorkist kingship.",
        "date": "1461"
      },
      {
        "term": "ÔÇ∑  Regime Change (1461)",
        "meaning": "Replacement of Lancastrian monarchy with Yorkist rule.",
        "significance": "Marked a fundamental shift in dynastic control.",
        "date": "1461"
      },
      {
        "term": "ÔÇ∑  Yorkist Consolidation (1461)",
        "meaning": "Securing political and military control after victory.",
        "significance": "Determined whether Edward‚Äôs rule would endure.",
        "date": "1461"
      },
      {
        "term": "ÔÇ∑  Transition from Faction to Dynasty (1459‚Äì61)",
        "meaning": "Shift from baronial rivalry to open dynastic revolution.",
        "significance": "Turned a political dispute into a full regime change by 1461.",
        "date": "1459"
      }
    ]
  },
  "t3": {
    "title": "3. Triumph of the Yorkists (1461‚Äì1471)",
    "terms": [
      {
        "term": "Royal Authority",
        "meaning": "The effective exercise of monarchical power.",
        "significance": "Edward restored confidence in monarchy after civil war.",
        "date": ""
      },
      {
        "term": "Financial Recovery",
        "meaning": "Improvement of Crown revenues under Edward.",
        "significance": "Strengthened independence from magnates.",
        "date": ""
      },
      {
        "term": "Chamber System",
        "meaning": "Financial administration managed through the royal household.",
        "significance": "Increased efficiency and royal control over finances.",
        "date": ""
      },
      {
        "term": "Crown Lands",
        "meaning": "Estates owned by the monarchy.",
        "significance": "Provided Edward with independent income.",
        "date": ""
      },
      {
        "term": "Patronage Network",
        "meaning": "Distribution of offices and rewards.",
        "significance": "Helped consolidate Yorkist loyalty.",
        "date": ""
      },
      {
        "term": "Elizabeth Woodville",
        "meaning": "Widow secretly married to Edward IV in 1464.",
        "significance": "Marriage alienated Warwick and destabilised Yorkist unity.",
        "date": "1464"
      },
      {
        "term": "Woodville Family Advancement",
        "meaning": "Rapid promotion of Elizabeth‚Äôs relatives.",
        "significance": "Caused resentment among established nobles.",
        "date": ""
      },
      {
        "term": "Marriage Alliance with Burgundy (abandoned)",
        "meaning": "Warwick‚Äôs planned diplomatic marriage.",
        "significance": "Its failure damaged Warwick‚Äôs influence.",
        "date": ""
      },
      {
        "term": "Marriage Politics",
        "meaning": "Use of dynastic marriage for diplomacy.",
        "significance": "Edward‚Äôs choice prioritised personal preference over strategy.",
        "date": ""
      },
      {
        "term": "Warwick ‚Äòthe Kingmaker‚Äô",
        "meaning": "Powerful magnate and former Yorkist ally.",
        "significance": "His rebellion nearly destroyed Edward‚Äôs rule.",
        "date": ""
      },
      {
        "term": "Neville‚ÄìWoodville Rivalry",
        "meaning": "Political competition at court.",
        "significance": "Deepened factional division.",
        "date": ""
      },
      {
        "term": "Edward, Prince of Wales",
        "meaning": "Lancastrian heir.",
        "significance": "Represented continuation of Lancastrian claim.",
        "date": ""
      },
      {
        "term": "French Support",
        "meaning": "Assistance from Louis XI.",
        "significance": "Sustained Lancastrian efforts.",
        "date": ""
      },
      {
        "term": "Exile Politics",
        "meaning": "Lancastrian activity abroad.",
        "significance": "Kept restoration alive.",
        "date": ""
      },
      {
        "term": "Destruction of Lancastrian Nobility",
        "meaning": "Loss of key families.",
        "significance": "Strengthened Yorkist dominance.",
        "date": ""
      },
      {
        "term": "Weakening of the Aristocracy",
        "meaning": "Decline in leading noble families.",
        "significance": "Reduced threat of overmighty subjects.",
        "date": ""
      },
      {
        "term": "Noble Casualties",
        "meaning": "High death toll among peers.",
        "significance": "Reshaped political elite.",
        "date": ""
      },
      {
        "term": "Consolidation of Crown Lands",
        "meaning": "Expansion of royal holdings.",
        "significance": "Increased royal financial security.",
        "date": ""
      },
      {
        "term": "Reduction of Private Armies",
        "meaning": "Fewer magnate forces.",
        "significance": "Strengthened monarchical authority.",
        "date": ""
      },
      {
        "term": "Restoration of Stability (Post-1471)",
        "meaning": "End of major civil conflict.",
        "significance": "Encouraged recovery of trade.",
        "date": ""
      },
      {
        "term": "London Merchants",
        "meaning": "Key supporters of Edward.",
        "significance": "Financial backing reinforced regime.",
        "date": ""
      },
      {
        "term": "Wool Trade Recovery",
        "meaning": "Revival of key export.",
        "significance": "Boosted economic stability.",
        "date": ""
      },
      {
        "term": "Commercial Treaties",
        "meaning": "Agreements with Burgundy.",
        "significance": "Improved international trade.",
        "date": ""
      },
      {
        "term": "Factionalism",
        "meaning": "Rival noble groupings.",
        "significance": "Continued to threaten stability.",
        "date": ""
      },
      {
        "term": "Magnate Power vs Crown",
        "meaning": "Balance of authority.",
        "significance": "Central theme of Edward‚Äôs reign.",
        "date": ""
      },
      {
        "term": "Dynastic Legitimacy",
        "meaning": "Rightful claim to throne.",
        "significance": "Resolved in Yorkist favour by 1471.",
        "date": ""
      },
      {
        "term": "Regime Security (Post-1471)",
        "meaning": "Stability of Edward‚Äôs rule.",
        "significance": "Marked triumph of Yorkists.",
        "date": ""
      },
      {
        "term": "Political Pragmatism",
        "meaning": "Shifting alliances for survival.",
        "significance": "Defined 1470‚Äì71 crisis.",
        "date": ""
      },
      {
        "term": "Foreign Intervention",
        "meaning": "Support from France or Burgundy.",
        "significance": "Influenced military outcomes.",
        "date": ""
      },
      {
        "term": "Redistribution of Lancastrian Lands",
        "meaning": "Granting confiscated estates to Yorkist supporters after 1471.",
        "significance": "Strengthened Edward IV‚Äôs reward network and weakened surviving opposition.",
        "date": "1471"
      },
      {
        "term": "Forfeiture",
        "meaning": "Loss of property due to treason.",
        "significance": "Reduced the independent power of rival noble families.",
        "date": ""
      },
      {
        "term": "Reversal of Attainders",
        "meaning": "Restoration of lands to reconciled nobles.",
        "significance": "Helped Edward stabilise the political nation after 1471.",
        "date": ""
      },
      {
        "term": "Noble Realignment",
        "meaning": "Former Lancastrians transferring loyalty to Edward.",
        "significance": "Demonstrated pragmatism within the aristocracy and consolidated Yorkist rule.",
        "date": ""
      },
      {
        "term": "Reduction of Magnate Autonomy",
        "meaning": "Limiting independent noble authority.",
        "significance": "Strengthened the central monarchy after years of baronial dominance.",
        "date": ""
      },
      {
        "term": "Royal Justice Circuits",
        "meaning": "Reassertion of royal law enforcement in the regions.",
        "significance": "Signalled restoration of order after civil disruption.",
        "date": ""
      },
      {
        "term": "Council of the North (early foundations)",
        "meaning": "Strengthening governance in northern England.",
        "significance": "Aimed to control previously unstable Lancastrian heartlands.",
        "date": ""
      },
      {
        "term": "Suppression of Local Feuds",
        "meaning": "Reduction in private noble warfare.",
        "significance": "Marked decline of baronial militarism by 1471.",
        "date": ""
      },
      {
        "term": "Decline of Neville Power",
        "meaning": "Fall of the Neville affinity after Warwick‚Äôs death.",
        "significance": "Removed the greatest magnate threat to the Crown.",
        "date": ""
      },
      {
        "term": "End of Kingmaker Politics",
        "meaning": "No magnate could dominate succession after 1471.",
        "significance": "Confirmed resurgence of monarchical supremacy.",
        "date": "1471"
      },
      {
        "term": "Restoration of Trade Stability",
        "meaning": "Gradual normalisation of commerce after 1471.",
        "significance": "Demonstrated that Yorkist victory restored economic confidence.",
        "date": "1471"
      },
      {
        "term": "Merchant Confidence",
        "meaning": "Renewed trust among London and provincial merchants.",
        "significance": "Strengthened Edward‚Äôs financial position.",
        "date": ""
      },
      {
        "term": "Anglo-Burgundian Trade Links",
        "meaning": "Strengthened commercial relations with Burgundy.",
        "significance": "Supported export recovery, especially in wool.",
        "date": ""
      },
      {
        "term": "Intercursus Magnus (precursor diplomacy)",
        "meaning": "Development of trade diplomacy under Edward.",
        "significance": "Reflected emphasis on economic security.",
        "date": ""
      },
      {
        "term": "Recovery of Wool Exports",
        "meaning": "Growth in England‚Äôs primary export industry.",
        "significance": "Signalled post-war economic recovery.",
        "date": ""
      },
      {
        "term": "Urban Recovery (Post-1471)",
        "meaning": "Rebuilding of disrupted towns.",
        "significance": "Highlighted the wider social cost of earlier baronial wars.",
        "date": ""
      },
      {
        "term": "Reduced Military Levies",
        "meaning": "Fewer noble musters after 1471.",
        "significance": "Reflected stabilisation of political life.",
        "date": "1471"
      },
      {
        "term": "Taxation Stability",
        "meaning": "Fewer emergency war taxes.",
        "significance": "Improved relations between Crown and political nation.",
        "date": ""
      },
      {
        "term": "Impact on Gentry",
        "meaning": "Increased influence of lesser landowners.",
        "significance": "Strengthened local governance under a stronger monarchy.",
        "date": ""
      },
      {
        "term": "Social Mobility Through Service",
        "meaning": "Advancement via royal service rather than noble patronage.",
        "significance": "Reduced aristocratic monopoly over power.",
        "date": ""
      },
      {
        "term": "Hereditary Security",
        "meaning": "Birth of Edward‚Äôs sons.",
        "significance": "Strengthened dynastic stability.",
        "date": ""
      },
      {
        "term": "Royal Image of Strength",
        "meaning": "Edward‚Äôs projection of martial authority.",
        "significance": "Reversed perceptions of weak kingship under Henry VI.",
        "date": ""
      },
      {
        "term": "Centralisation of Power",
        "meaning": "Greater concentration of authority in royal hands.",
        "significance": "Reduced opportunity for baronial rebellion.",
        "date": ""
      },
      {
        "term": "Diplomatic Recognition",
        "meaning": "Acceptance of Edward‚Äôs rule by foreign powers.",
        "significance": "Secured international legitimacy.",
        "date": ""
      },
      {
        "term": "Suppression of Lancastrian Remnants",
        "meaning": "Elimination of surviving opposition networks.",
        "significance": "Ensured Yorkist dominance.",
        "date": ""
      },
      {
        "term": "Political Reconciliation Policy",
        "meaning": "Edward‚Äôs willingness to restore some former enemies.",
        "significance": "Promoted longer-term stability.",
        "date": ""
      },
      {
        "term": "Control of the North",
        "meaning": "Yorkist dominance in previously hostile regions.",
        "significance": "Prevented resurgence of rebellion.",
        "date": ""
      },
      {
        "term": "Magnate Surveillance",
        "meaning": "Monitoring of powerful nobles.",
        "significance": "Limited future factional conspiracies.",
        "date": ""
      },
      {
        "term": "Weakening of the Aristocracy",
        "meaning": "Heavy noble casualties between 1455‚Äì1471.",
        "significance": "Reduced number of overmighty subjects.",
        "date": "1455"
      },
      {
        "term": "Concentration of Land Ownership",
        "meaning": "Fewer but more carefully managed estates.",
        "significance": "Increased Crown leverage over nobility.",
        "date": ""
      },
      {
        "term": "Shift from Baronial to Royal War",
        "meaning": "Decline of independent noble campaigns.",
        "significance": "Marked structural shift toward stronger monarchy.",
        "date": ""
      },
      {
        "term": "Political Nation‚Äôs War Weariness",
        "meaning": "Elite desire for stability after prolonged conflict.",
        "significance": "Supported Edward‚Äôs consolidation.",
        "date": ""
      },
      {
        "term": "End of Large-Scale Civil Battles (Post-1471)",
        "meaning": "No comparable conflict until 1483.",
        "significance": "Demonstrated temporary resolution of dynastic struggle.",
        "date": "1483"
      },
      {
        "term": "Reassertion of Hierarchy",
        "meaning": "Restoration of clear social order.",
        "significance": "Reinforced traditional monarchical supremacy.",
        "date": ""
      },
      {
        "term": "Authority Restored",
        "meaning": "Stronger enforcement of royal commands.",
        "significance": "Corrected breakdown of the 1450s.",
        "date": ""
      },
      {
        "term": "Decline of Feudal Militarism",
        "meaning": "Reduced reliance on private noble armies.",
        "significance": "Signalled transformation of political culture.",
        "date": ""
      }
    ],
    "people": [
      {
        "term": "Edward IV",
        "meaning": "Yorkist king who ruled from 1461‚Äì70 and 1471‚Äì83.",
        "significance": "His survival and restoration in 1471 secured Yorkist supremacy.",
        "date": "1461"
      },
      {
        "term": "Royal Council",
        "meaning": "Body advising the king.",
        "significance": "Reflected Edward‚Äôs more controlled style of rule.",
        "date": ""
      },
      {
        "term": "Burgundian Support for Edward",
        "meaning": "Backing from Charles the Bold.",
        "significance": "Enabled Edward‚Äôs return in 1471.",
        "date": ""
      },
      {
        "term": "Margaret of Anjou",
        "meaning": "Leader of Lancastrian resistance.",
        "significance": "Maintained opposition to Yorkist rule.",
        "date": ""
      },
      {
        "term": "Alliance with Clarence",
        "meaning": "Warwick allied with Edward‚Äôs brother.",
        "significance": "Showed internal Yorkist division.",
        "date": ""
      },
      {
        "term": "George, Duke of Clarence",
        "meaning": "Edward‚Äôs brother who defected.",
        "significance": "Undermined Yorkist unity.",
        "date": ""
      }
    ],
    "events": [
      {
        "term": "Personal Rule (1461‚Äì1470)",
        "meaning": "Edward governing without overreliance on Parliament.",
        "significance": "Demonstrated stronger kingship compared to Henry VI.",
        "date": "1461"
      },
      {
        "term": "Secret Marriage (1464)",
        "meaning": "Edward‚Äôs unexpected union with Elizabeth.",
        "significance": "Undermined Warwick‚Äôs diplomatic strategy.",
        "date": "1464"
      },
      {
        "term": "Court Factionalism (1460s)",
        "meaning": "Rivalries between Woodvilles and Nevilles.",
        "significance": "Reignited internal Yorkist conflict.",
        "date": ""
      },
      {
        "term": "Rebellion of 1469",
        "meaning": "Warwick-backed uprising in the north.",
        "significance": "Demonstrated fragility of Edward‚Äôs authority.",
        "date": ""
      },
      {
        "term": "Battle of Edgecote (1469)",
        "meaning": "Defeat of royal forces.",
        "significance": "Temporarily weakened Edward‚Äôs position.",
        "date": "1469"
      },
      {
        "term": "Capture of Edward IV (1469)",
        "meaning": "Edward briefly imprisoned by Warwick.",
        "significance": "Showed magnate power could still challenge the king.",
        "date": "1469"
      },
      {
        "term": "Restoration of Edward‚Äôs Authority (1469‚Äì70)",
        "meaning": "Edward regained control.",
        "significance": "Revealed limits of Warwick‚Äôs influence.",
        "date": "1469"
      },
      {
        "term": "Readeption (1470‚Äì1471)",
        "meaning": "Brief restoration of Henry VI.",
        "significance": "Proved Yorkist rule was not yet secure.",
        "date": "1470"
      },
      {
        "term": "Alliance of Warwick and Margaret (1470)",
        "meaning": "Former enemies united.",
        "significance": "Demonstrated pragmatic factional politics.",
        "date": "1470"
      },
      {
        "term": "Flight of Edward IV (1470)",
        "meaning": "Edward fled to Burgundy.",
        "significance": "Marked peak of Lancastrian revival.",
        "date": "1470"
      },
      {
        "term": "Henry VI Restored (1470)",
        "meaning": "Lancastrian king briefly reinstated.",
        "significance": "Highlighted continued dynastic instability.",
        "date": "1470"
      },
      {
        "term": "Battle of Barnet (1471)",
        "meaning": "Edward IV defeated Warwick.",
        "significance": "Eliminated the Kingmaker as a threat.",
        "date": "1471"
      },
      {
        "term": "Battle of Tewkesbury (1471)",
        "meaning": "Yorkist victory over Lancastrians.",
        "significance": "Ended organised Lancastrian resistance.",
        "date": "1471"
      },
      {
        "term": "Death of Warwick (1471)",
        "meaning": "Killed at Barnet.",
        "significance": "Removed leading magnate challenger.",
        "date": "1471"
      },
      {
        "term": "Death of Prince Edward (1471)",
        "meaning": "Killed after Tewkesbury.",
        "significance": "Destroyed direct Lancastrian succession.",
        "date": "1471"
      },
      {
        "term": "Death of Henry VI (1471)",
        "meaning": "Murdered in the Tower of London.",
        "significance": "Ended the Lancastrian royal line.",
        "date": "1471"
      },
      {
        "term": "Attainders (1471)",
        "meaning": "Confiscation of Lancastrian estates.",
        "significance": "Redistributed wealth to loyal Yorkists.",
        "date": "1471"
      },
      {
        "term": "Economic Disruption (1460s)",
        "meaning": "Trade interrupted by war.",
        "significance": "Demonstrated wider social impact of baronial conflict.",
        "date": ""
      },
      {
        "term": "Triumph of the Yorkists (1471)",
        "meaning": "Final defeat of Lancastrians.",
        "significance": "Established Edward IV‚Äôs uncontested kingship.",
        "date": "1471"
      },
      {
        "term": "Rebellion of Lincolnshire (1470)",
        "meaning": "Warwick-inspired uprising.",
        "significance": "Triggered Edward‚Äôs temporary loss of throne.",
        "date": "1470"
      },
      {
        "term": "Battle of Losecoat Field (1470)",
        "meaning": "Royal victory over rebels.",
        "significance": "Exposed Warwick‚Äôs involvement.",
        "date": "1470"
      },
      {
        "term": "Exile and Return (1470‚Äì71)",
        "meaning": "Edward‚Äôs temporary displacement.",
        "significance": "Demonstrated resilience of Yorkist cause.",
        "date": "1470"
      },
      {
        "term": "Yorkist Restoration (1471)",
        "meaning": "Edward‚Äôs return to power.",
        "significance": "Confirmed military and political superiority.",
        "date": "1471"
      },
      {
        "term": "Parliament of 1471",
        "meaning": "Confirmed Edward‚Äôs rule.",
        "significance": "Legalised regime security.",
        "date": ""
      },
      {
        "term": "Parliamentary Confirmation (1471)",
        "meaning": "Parliament reaffirming Edward‚Äôs kingship.",
        "significance": "Gave legal legitimacy to Yorkist triumph.",
        "date": "1471"
      },
      {
        "term": "End of Direct Lancastrian Line (1471)",
        "meaning": "Death of Henry VI and Prince Edward.",
        "significance": "Removed immediate dynastic rival.",
        "date": "1471"
      },
      {
        "term": "Yorkist Regime Security (1471)",
        "meaning": "Edward‚Äôs uncontested position.",
        "significance": "Represented culmination of Yorkist triumph.",
        "date": "1471"
      },
      {
        "term": "Triumph of the Yorkists (1461‚Äì1471)",
        "meaning": "Final defeat of Lancastrian challenge.",
        "significance": "Established a stronger, more centralised monarchy and reshaped the English political elite.",
        "date": "1461"
      }
    ]
  },
  "t4": {
    "title": "4. ‚ÄòSun in Splendour‚Äô: Edward IV (1471‚Äì1483)",
    "terms": [
      {
        "term": "The ‚ÄòSun in Splendour‚Äô",
        "meaning": "Edward‚Äôs personal badge symbolising triumph and authority.",
        "significance": "Reinforced royal image and legitimacy after civil war.",
        "date": ""
      },
      {
        "term": "Consolidation of Royal Authority",
        "meaning": "Strengthening of monarchical control after 1471.",
        "significance": "Reduced the threat of magnate rebellion.",
        "date": "1471"
      },
      {
        "term": "Centralisation of Power",
        "meaning": "Greater authority exercised directly by the Crown.",
        "significance": "Limited magnate autonomy.",
        "date": ""
      },
      {
        "term": "Royal Prerogative",
        "meaning": "Powers exercised independently of Parliament.",
        "significance": "Allowed Edward to govern efficiently.",
        "date": ""
      },
      {
        "term": "Council Governance",
        "meaning": "Use of smaller, more controlled advisory groups.",
        "significance": "Reduced factional dominance at court.",
        "date": ""
      },
      {
        "term": "Household Government",
        "meaning": "Administration run through the royal household.",
        "significance": "Increased loyalty and efficiency.",
        "date": ""
      },
      {
        "term": "Crown Lands Expansion",
        "meaning": "Growth of royal estates after attainders.",
        "significance": "Strengthened financial independence.",
        "date": ""
      },
      {
        "term": "Customs Revenue",
        "meaning": "Income from trade duties.",
        "significance": "Provided steady royal income during peacetime.",
        "date": ""
      },
      {
        "term": "Diplomatic Pragmatism",
        "meaning": "Preference for negotiation over war.",
        "significance": "Maintained domestic stability.",
        "date": ""
      },
      {
        "term": "Financial Self-Sufficiency",
        "meaning": "Crown able to govern without heavy taxation.",
        "significance": "Reduced conflict with political nation.",
        "date": ""
      },
      {
        "term": "Exchequer vs Chamber",
        "meaning": "Shift from traditional treasury to household finance.",
        "significance": "Modernised government practice.",
        "date": ""
      },
      {
        "term": "Royal Affinity (Reorganised)",
        "meaning": "More controlled network of loyal retainers.",
        "significance": "Prevented rise of overmighty subjects.",
        "date": ""
      },
      {
        "term": "Woodville Ascendancy",
        "meaning": "Rise of Woodville influence in government.",
        "significance": "Created factional tensions at court.",
        "date": ""
      },
      {
        "term": "Anti-Woodville Sentiment",
        "meaning": "Hostility among established nobles.",
        "significance": "Highlighted fragility of political unity.",
        "date": ""
      },
      {
        "term": "Court Factionalism",
        "meaning": "Competition between noble families.",
        "significance": "Continued despite peacetime stability.",
        "date": ""
      },
      {
        "term": "Royal Control of Nobility",
        "meaning": "Monitoring and limiting magnate power.",
        "significance": "Reduced likelihood of renewed civil war.",
        "date": ""
      },
      {
        "term": "Marriage Alliances",
        "meaning": "Strategic marriages arranged for royal children.",
        "significance": "Strengthened dynastic security.",
        "date": ""
      },
      {
        "term": "Decade of Peace",
        "meaning": "Relative domestic stability after 1471.",
        "significance": "Allowed economic and social recovery.",
        "date": "1471"
      },
      {
        "term": "Trade Expansion",
        "meaning": "Growth in overseas commerce.",
        "significance": "Reflected improved national stability.",
        "date": ""
      },
      {
        "term": "Wool Export Revival",
        "meaning": "Recovery of England‚Äôs key industry.",
        "significance": "Strengthened Crown revenue.",
        "date": ""
      },
      {
        "term": "Merchant Adventurers",
        "meaning": "Trading organisation expanding exports.",
        "significance": "Demonstrated increasing commercial sophistication.",
        "date": ""
      },
      {
        "term": "Urban Prosperity",
        "meaning": "Growth in towns like London.",
        "significance": "Indicated economic recovery.",
        "date": ""
      },
      {
        "term": "Social Mobility",
        "meaning": "Advancement through royal service.",
        "significance": "Reduced exclusive dominance of old aristocracy.",
        "date": ""
      },
      {
        "term": "Rise of the Gentry",
        "meaning": "Increasing importance of lesser landowners.",
        "significance": "Strengthened local governance.",
        "date": ""
      },
      {
        "term": "Regional Governance",
        "meaning": "Increased royal oversight outside London.",
        "significance": "Reduced localised disorder.",
        "date": ""
      },
      {
        "term": "Council of the North (strengthened)",
        "meaning": "Administrative body for northern England.",
        "significance": "Maintained stability in former Lancastrian heartlands.",
        "date": ""
      },
      {
        "term": "Continuity of Hierarchy",
        "meaning": "Traditional social order maintained.",
        "significance": "Civil war did not radically transform society.",
        "date": ""
      },
      {
        "term": "Decline of Private Feuds",
        "meaning": "Reduction in noble violence.",
        "significance": "Demonstrated effectiveness of royal control.",
        "date": ""
      },
      {
        "term": "Judicial Enforcement",
        "meaning": "Stronger implementation of royal justice.",
        "significance": "Reinforced central authority.",
        "date": ""
      },
      {
        "term": "Burgundian Alliance",
        "meaning": "Relationship with Charles the Bold.",
        "significance": "Secured trade and diplomatic security.",
        "date": ""
      },
      {
        "term": "French Relations",
        "meaning": "Managed through diplomacy rather than war.",
        "significance": "Avoided financial strain.",
        "date": ""
      },
      {
        "term": "Scottish Border Stability",
        "meaning": "Reduced northern conflict.",
        "significance": "Improved regional peace.",
        "date": ""
      },
      {
        "term": "Military Restraint",
        "meaning": "Avoidance of major foreign wars.",
        "significance": "Preserved financial strength.",
        "date": ""
      },
      {
        "term": "Edward V",
        "meaning": "Young heir aged 12.",
        "significance": "Minority rule risked renewed factional conflict.",
        "date": ""
      },
      {
        "term": "Protectorate of Richard, Duke of Gloucester",
        "meaning": "Richard appointed Protector.",
        "significance": "Shifted balance of power at court.",
        "date": ""
      },
      {
        "term": "Dynastic Instability",
        "meaning": "Fragility of hereditary monarchy.",
        "significance": "Re-emerged upon Edward‚Äôs death.",
        "date": ""
      },
      {
        "term": "Royal Image of Strength",
        "meaning": "Edward‚Äôs cultivated authority.",
        "significance": "Prevented rebellion during his lifetime.",
        "date": ""
      },
      {
        "term": "Magnate Surveillance",
        "meaning": "Monitoring powerful nobles.",
        "significance": "Limited conspiracies.",
        "date": ""
      },
      {
        "term": "Political Nation‚Äôs Loyalty",
        "meaning": "Acceptance of Edward‚Äôs rule.",
        "significance": "Ensured decade of peace.",
        "date": ""
      },
      {
        "term": "Peace Dividend",
        "meaning": "Financial gain from absence of civil war.",
        "significance": "Reinforced Edward‚Äôs authority.",
        "date": ""
      },
      {
        "term": "Decline of Overmighty Subjects",
        "meaning": "Reduced magnate dominance.",
        "significance": "Strengthened monarchy",
        "date": ""
      },
      {
        "term": "Limited Taxation Policy",
        "meaning": "Avoidance of frequent parliamentary subsidies.",
        "significance": "Prevented unrest that had destabilised earlier reigns.",
        "date": ""
      },
      {
        "term": "Royal Magnificence",
        "meaning": "Display of wealth and splendour at court.",
        "significance": "Reinforced prestige and projected secure kingship.",
        "date": ""
      },
      {
        "term": "Patronage Restraint",
        "meaning": "More cautious distribution of offices after 1471.",
        "significance": "Prevented emergence of another overmighty magnate like Warwick.",
        "date": "1471"
      },
      {
        "term": "Control of Retaining",
        "meaning": "Regulation of private armies.",
        "significance": "Reduced threat of baronial militarism.",
        "date": ""
      },
      {
        "term": "Livery Regulation",
        "meaning": "Attempts to limit distribution of noble badges.",
        "significance": "Curbed factional mobilisation.",
        "date": ""
      },
      {
        "term": "Council Learned (early foundations)",
        "meaning": "Increasing reliance on administrative expertise.",
        "significance": "Indicated shift toward more professional governance.",
        "date": ""
      },
      {
        "term": "Regional Pacification",
        "meaning": "Stabilisation of previously turbulent areas.",
        "significance": "Consolidated national unity.",
        "date": ""
      },
      {
        "term": "Merchant Adventurers‚Äô Expansion",
        "meaning": "Growth of English overseas trading company.",
        "significance": "Reflected renewed commercial confidence.",
        "date": ""
      },
      {
        "term": "London as Financial Hub",
        "meaning": "Dominance of the capital in trade.",
        "significance": "Strengthened royal revenue base.",
        "date": ""
      },
      {
        "term": "Staple System Reform",
        "meaning": "Regulation of wool exports.",
        "significance": "Improved efficiency of trade taxation.",
        "date": ""
      },
      {
        "term": "Customs Farming",
        "meaning": "Leasing of tax collection rights.",
        "significance": "Increased predictable income for the Crown.",
        "date": ""
      },
      {
        "term": "Burgundian Commercial Alliance",
        "meaning": "Strong trade ties with Burgundy.",
        "significance": "Secured economic prosperity.",
        "date": ""
      },
      {
        "term": "Naval Investment",
        "meaning": "Maintenance of fleet strength.",
        "significance": "Protected English trade routes.",
        "date": ""
      },
      {
        "term": "Decline in Civil Disruption",
        "meaning": "Fewer internal rebellions.",
        "significance": "Demonstrated effectiveness of Edward‚Äôs consolidation.",
        "date": ""
      },
      {
        "term": "Strengthening of the Gentry",
        "meaning": "Increased reliance on local landowners.",
        "significance": "Broadened base of royal governance.",
        "date": ""
      },
      {
        "term": "Judicial Stability",
        "meaning": "Consistent enforcement of law.",
        "significance": "Rebuilt trust in royal authority.",
        "date": ""
      },
      {
        "term": "Continuity of Feudal Hierarchy",
        "meaning": "No radical social restructuring.",
        "significance": "Civil war had limited transformative social impact.",
        "date": ""
      },
      {
        "term": "Alienation of Old Nobility",
        "meaning": "Marginalisation of traditional magnates.",
        "significance": "Reduced baronial threat but increased elite dissatisfaction.",
        "date": ""
      },
      {
        "term": "Surveillance of Nobility",
        "meaning": "Monitoring of magnate activities.",
        "significance": "Prevented coordinated rebellion.",
        "date": ""
      },
      {
        "term": "Factional Containment",
        "meaning": "Limiting open rivalry within court.",
        "significance": "Preserved decade-long peace.",
        "date": ""
      },
      {
        "term": "Yorkist Dynastic Security (Late 1470s)",
        "meaning": "Multiple male heirs alive.",
        "significance": "Appeared to secure long-term stability.",
        "date": ""
      },
      {
        "term": "Royal Household Expansion",
        "meaning": "Growth of administrative structure.",
        "significance": "Enhanced central governance.",
        "date": ""
      },
      {
        "term": "Elite Pragmatism",
        "meaning": "Nobles prioritising stability over rivalry.",
        "significance": "Reflected exhaustion after decades of war.",
        "date": ""
      },
      {
        "term": "Decline of Kingmaker Politics",
        "meaning": "No magnate able to dominate Edward.",
        "significance": "Confirmed stronger monarchy.",
        "date": ""
      },
      {
        "term": "Richard, Duke of Gloucester",
        "meaning": "Appointed Protector after Edward IV‚Äôs death.",
        "significance": "Key figure in succession crisis.",
        "date": ""
      },
      {
        "term": "Claim of Pre-Contract",
        "meaning": "Allegation Edward IV had prior marriage promise.",
        "significance": "Provided legal basis for illegitimising heirs.",
        "date": ""
      },
      {
        "term": "Collapse of Woodville Power",
        "meaning": "Removal of dominant court faction.",
        "significance": "Shifted political balance to Gloucester.",
        "date": ""
      },
      {
        "term": "Failure of Long-Term Dynastic Security",
        "meaning": "Edward‚Äôs death destabilised regime.",
        "significance": "Revealed that despite a decade of peace, Yorkist succession remained structurally vulnerable.",
        "date": ""
      }
    ],
    "people": [
      {
        "term": "Edward IV (Second Reign, 1471‚Äì1483)",
        "meaning": "Yorkist king restored after Barnet and Tewkesbury.",
        "significance": "His second reign marked the most stable period of Yorkist rule.",
        "date": ""
      },
      {
        "term": "The Chamber System",
        "meaning": "Financial management through the king‚Äôs household.",
        "significance": "Improved royal revenue collection.",
        "date": ""
      },
      {
        "term": "Benevolences",
        "meaning": "‚ÄòVoluntary‚Äô financial contributions requested by the king.",
        "significance": "Increased royal funds without parliamentary taxation.",
        "date": ""
      },
      {
        "term": "Elizabeth Woodville",
        "meaning": "Queen and influential court figure.",
        "significance": "Her family‚Äôs prominence caused resentment.",
        "date": ""
      },
      {
        "term": "George, Duke of Clarence",
        "meaning": "Edward‚Äôs brother involved in plots.",
        "significance": "His rivalry exposed dynastic tensions.",
        "date": ""
      },
      {
        "term": "Richard, Duke of Gloucester",
        "meaning": "Edward‚Äôs brother and Protector.",
        "significance": "Central figure in succession crisis.",
        "date": ""
      },
      {
        "term": "Princes in the Tower",
        "meaning": "Edward V and his brother disappeared.",
        "significance": "Deepened legitimacy crisis of Yorkist rule.",
        "date": ""
      },
      {
        "term": "Minority Crisis",
        "meaning": "Risks of child kingship.",
        "significance": "Echoed problems of Henry VI‚Äôs reign.",
        "date": ""
      },
      {
        "term": "Reassertion of Hierarchy",
        "meaning": "Clear restoration of king above magnates.",
        "significance": "Corrected breakdown seen under Henry VI.",
        "date": ""
      },
      {
        "term": "Royal Progresses",
        "meaning": "King travelling through the regions.",
        "significance": "Reinforced royal authority across the realm.",
        "date": ""
      },
      {
        "term": "Woodville Influence at Court",
        "meaning": "Continued prominence of queen‚Äôs family.",
        "significance": "Sustained undercurrent of aristocratic resentment.",
        "date": ""
      },
      {
        "term": "Marriage of Elizabeth of York",
        "meaning": "Dynastic asset of Edward‚Äôs daughter.",
        "significance": "Important for future succession stability.",
        "date": ""
      },
      {
        "term": "Princes in the Tower",
        "meaning": "Disappearance of Edward V and his brother.",
        "significance": "Deepened legitimacy crisis of Yorkist rule.",
        "date": ""
      }
    ],
    "events": [
      {
        "term": "Personal Rule (1471‚Äì1483)",
        "meaning": "Edward governing with minimal parliamentary interference.",
        "significance": "Demonstrated stronger kingship than Henry VI.",
        "date": "1471"
      },
      {
        "term": "French Pension (Treaty of Picquigny, 1475)",
        "meaning": "Annual payment from France to Edward.",
        "significance": "Demonstrated diplomatic pragmatism and financial gain.",
        "date": ""
      },
      {
        "term": "Treaty of Picquigny (1475)",
        "meaning": "Agreement between Edward IV and Louis XI.",
        "significance": "Secured peace and financial compensation instead of costly war.",
        "date": "1475"
      },
      {
        "term": "Execution of Clarence (1478)",
        "meaning": "Death of Edward‚Äôs brother for treason.",
        "significance": "Demonstrated Edward‚Äôs determination to suppress threats.",
        "date": "1478"
      },
      {
        "term": "Premature Death of Edward IV (1483)",
        "meaning": "Edward died unexpectedly aged 40.",
        "significance": "Created immediate political instability.",
        "date": "1483"
      },
      {
        "term": "Minority Government (1483)",
        "meaning": "Rule during Edward V‚Äôs youth.",
        "significance": "Recreated conditions of instability seen under Henry VI.",
        "date": "1483"
      },
      {
        "term": "Arrest of the Woodvilles (1483)",
        "meaning": "Gloucester moved against queen‚Äôs family.",
        "significance": "Demonstrated factional rivalry resurfacing.",
        "date": "1483"
      },
      {
        "term": "Titulus Regius (1484)",
        "meaning": "Act declaring Edward IV‚Äôs children illegitimate.",
        "significance": "Justified Richard‚Äôs claim to throne.",
        "date": "1484"
      },
      {
        "term": "Factional Resurgence (1483)",
        "meaning": "Revival of court divisions.",
        "significance": "Undermined Yorkist unity.",
        "date": "1483"
      },
      {
        "term": "Economic Recovery (1470s)",
        "meaning": "Sustained financial growth.",
        "significance": "Demonstrated benefits of stability.",
        "date": ""
      },
      {
        "term": "Legitimacy Through Victory (1471)",
        "meaning": "Edward‚Äôs authority rooted in decisive military success.",
        "significance": "His battlefield triumph gave him stronger authority than hereditary claim alone.",
        "date": "1471"
      },
      {
        "term": "Parliamentary Cooperation",
        "meaning": "Edward‚Äôs limited but strategic use of Parliament.",
        "significance": "Reduced financial and political friction with the political nation.",
        "date": ""
      },
      {
        "term": "Execution of Clarence (1478)",
        "meaning": "Removal of Edward‚Äôs rival brother.",
        "significance": "Demonstrated ruthless defence of dynasty.",
        "date": "1478"
      },
      {
        "term": "Edward V (1483)",
        "meaning": "Twelve-year-old heir to the throne.",
        "significance": "His minority reopened risks of factional instability.",
        "date": "1483"
      },
      {
        "term": "Protectorate Crisis (1483)",
        "meaning": "Power struggle during minority.",
        "significance": "Undermined Yorkist unity.",
        "date": "1483"
      },
      {
        "term": "Arrest of Woodville Leaders (1483)",
        "meaning": "Gloucester‚Äôs move against queen‚Äôs kin.",
        "significance": "Reflected resurgence of factional politics.",
        "date": "1483"
      },
      {
        "term": "Titulus Regius (1484)",
        "meaning": "Act declaring Edward IV‚Äôs marriage invalid.",
        "significance": "Justified Richard‚Äôs seizure of throne.",
        "date": "1484"
      },
      {
        "term": "Yorkist Succession Crisis (1483)",
        "meaning": "Breakdown of dynastic continuity.",
        "significance": "Demonstrated fragility of Edward‚Äôs settlement.",
        "date": "1483"
      }
    ]
  },
  "t5": {
    "title": "5. Downfall of the Yorkist Monarchy (1483‚Äì1486)",
    "terms": [
      {
        "term": "Protectorate of 1483",
        "meaning": "Richard‚Äôs temporary authority during Edward V‚Äôs minority.",
        "significance": "Provided legal stepping-stone to the throne.",
        "date": ""
      },
      {
        "term": "Claim of Pre-Contract",
        "meaning": "Allegation Edward IV had a prior marriage agreement.",
        "significance": "Justified declaring Edward V illegitimate.",
        "date": ""
      },
      {
        "term": "Usurpation",
        "meaning": "Seizing the throne unlawfully.",
        "significance": "Richard‚Äôs reputation as a usurper undermined his legitimacy.",
        "date": ""
      },
      {
        "term": "Tower of London",
        "meaning": "Royal fortress and prison.",
        "significance": "Symbol of royal authority and secrecy.",
        "date": ""
      },
      {
        "term": "Public Suspicion",
        "meaning": "Widespread belief the princes were murdered.",
        "significance": "Weakened Richard‚Äôs moral authority.",
        "date": ""
      },
      {
        "term": "Beaufort Claim",
        "meaning": "Henry‚Äôs descent from John of Gaunt.",
        "significance": "Weak legally, but symbolically important.",
        "date": ""
      },
      {
        "term": "Exile in Brittany",
        "meaning": "Henry‚Äôs residence abroad before 1485.",
        "significance": "Protected him from Yorkist retaliation.",
        "date": "1485"
      },
      {
        "term": "Duke of Buckingham",
        "meaning": "Former ally of Richard who rebelled.",
        "significance": "His defection showed fragility of Richard‚Äôs support.",
        "date": ""
      },
      {
        "term": "Yorkist Dissension",
        "meaning": "Division among former Edward IV supporters.",
        "significance": "Undermined regime stability.",
        "date": ""
      },
      {
        "term": "Council of the North",
        "meaning": "Strengthened regional governance.",
        "significance": "Consolidated northern loyalty.",
        "date": ""
      },
      {
        "term": "Northern Support Base",
        "meaning": "Richard‚Äôs power base in Yorkshire.",
        "significance": "Provided core military backing.",
        "date": ""
      },
      {
        "term": "Lancastrian Exile Network",
        "meaning": "Supporters abroad.",
        "significance": "Sustained alternative dynasty.",
        "date": ""
      },
      {
        "term": "Propaganda Against Richard",
        "meaning": "Portrayal of Richard as tyrant.",
        "significance": "Weakened Yorkist morale.",
        "date": ""
      },
      {
        "term": "Defection of Lord Stanley",
        "meaning": "Stanley switching sides during battle.",
        "significance": "Critical factor in Richard‚Äôs defeat.",
        "date": ""
      },
      {
        "term": "Crown Taken in Battle",
        "meaning": "Richard‚Äôs crown found and placed on Henry‚Äôs head.",
        "significance": "Symbolised immediate regime change.",
        "date": ""
      },
      {
        "term": "Henry VII",
        "meaning": "Founder of the Tudor dynasty.",
        "significance": "Ended Wars of the Roses.",
        "date": ""
      },
      {
        "term": "Tudor Rose",
        "meaning": "Combined red and white rose emblem.",
        "significance": "Represented dynastic reconciliation.",
        "date": ""
      },
      {
        "term": "End of Plantagenet Rule",
        "meaning": "Conclusion of long royal line.",
        "significance": "Structural shift in English monarchy.",
        "date": ""
      },
      {
        "term": "Usurpation Debate",
        "meaning": "Ongoing argument over Richard‚Äôs legitimacy.",
        "significance": "Central to instability of 1483‚Äì85.",
        "date": ""
      },
      {
        "term": "Factional Fragmentation",
        "meaning": "Division within Yorkist ranks.",
        "significance": "Weakened resistance to Henry.",
        "date": ""
      },
      {
        "term": "Stanley Family Power",
        "meaning": "Strategic neutrality until Bosworth.",
        "significance": "Kingmakers of 1485.",
        "date": ""
      },
      {
        "term": "Yorkist Legitimacy Undermined",
        "meaning": "Damage from princes‚Äô disappearance.",
        "significance": "Alienated political nation.",
        "date": ""
      },
      {
        "term": "Dynastic Fusion",
        "meaning": "Union of York and Lancaster under Tudors.",
        "significance": "Reduced basis for further dynastic war.",
        "date": ""
      },
      {
        "term": "War Weariness",
        "meaning": "Exhaustion after decades of conflict.",
        "significance": "Encouraged acceptance of Tudor rule.",
        "date": ""
      },
      {
        "term": "Political Pragmatism of Nobility",
        "meaning": "Switching allegiance to survive.",
        "significance": "Enabled Tudor victory.",
        "date": ""
      },
      {
        "term": "Backdating of Henry VII‚Äôs Reign",
        "meaning": "Henry dated his reign from 21 August 1485.",
        "significance": "Enabled him to declare Richard‚Äôs supporters at Bosworth traitors.",
        "date": "1485"
      },
      {
        "term": "Tudor Propaganda",
        "meaning": "Promotion of Richard as a tyrant and child-murderer.",
        "significance": "Strengthened Henry‚Äôs moral and political legitimacy.",
        "date": ""
      },
      {
        "term": "Myth of the Tyrant King",
        "meaning": "Image of Richard as cruel and illegitimate.",
        "significance": "Justified the Tudor takeover as restoration of justice.",
        "date": ""
      },
      {
        "term": "Legitimacy by Right of Conquest",
        "meaning": "Henry‚Äôs claim to rule through victory at Bosworth.",
        "significance": "Provided immediate authority despite weak hereditary claim.",
        "date": ""
      },
      {
        "term": "Beaufort Lineage",
        "meaning": "Henry‚Äôs descent from John of Gaunt‚Äôs legitimised children.",
        "significance": "Gave him a symbolic Lancastrian link, though legally weak.",
        "date": ""
      },
      {
        "term": "Tudor Rose",
        "meaning": "Combined red and white rose emblem.",
        "significance": "Symbolised end of dynastic division.",
        "date": ""
      },
      {
        "term": "Repeal of Titulus Regius",
        "meaning": "Removal of act declaring Edward IV‚Äôs children illegitimate.",
        "significance": "Restored Elizabeth of York‚Äôs legitimacy for Tudor marriage.",
        "date": ""
      },
      {
        "term": "Confiscation of Rebel Estates",
        "meaning": "Seizure of lands from Richard‚Äôs supporters.",
        "significance": "Rewarded Tudor loyalists and weakened opposition.",
        "date": ""
      },
      {
        "term": "Bond and Recognisance (early forms)",
        "meaning": "Financial guarantees of loyalty.",
        "significance": "Began Tudor control over the nobility.",
        "date": ""
      },
      {
        "term": "Noble Casualties at Bosworth",
        "meaning": "Death of key Yorkist magnates.",
        "significance": "Reduced aristocratic opposition to Tudor rule.",
        "date": ""
      },
      {
        "term": "Yorkist Claimants in Exile",
        "meaning": "Surviving Plantagenet supporters abroad.",
        "significance": "Represented ongoing threat to Tudor stability.",
        "date": ""
      },
      {
        "term": "Plantagenet Bloodline",
        "meaning": "Surviving distant Yorkist relatives.",
        "significance": "Provided potential alternative claimants.",
        "date": ""
      },
      {
        "term": "Stanley Influence",
        "meaning": "Support of Thomas, Lord Stanley.",
        "significance": "Critical in securing Tudor victory.",
        "date": ""
      },
      {
        "term": "Lord Stanley",
        "meaning": "Step-father of Henry Tudor.",
        "significance": "His intervention at Bosworth determined outcome.",
        "date": ""
      },
      {
        "term": "Ambiguous Loyalty of Nobility",
        "meaning": "Hesitant support before Bosworth.",
        "significance": "Demonstrated fragility of Richard‚Äôs regime.",
        "date": ""
      },
      {
        "term": "War Weariness of Political Nation",
        "meaning": "Exhaustion after decades of conflict.",
        "significance": "Encouraged acceptance of Tudor rule.",
        "date": ""
      },
      {
        "term": "Collapse of Yorkist Unity",
        "meaning": "Fragmentation after 1483.",
        "significance": "Prevented effective resistance to Henry.",
        "date": "1483"
      },
      {
        "term": "End of the Plantagenet Dynasty",
        "meaning": "Conclusion of over 300 years of rule.",
        "significance": "Marked structural transformation of monarchy.",
        "date": ""
      },
      {
        "term": "Failure of Yorkist Settlement",
        "meaning": "Inability of Edward IV‚Äôs regime to endure.",
        "significance": "Showed limits of personal monarchy.",
        "date": ""
      },
      {
        "term": "Factional Rivalry Resurgence",
        "meaning": "Woodville vs Gloucester tensions.",
        "significance": "Undermined regime stability.",
        "date": ""
      },
      {
        "term": "Political Isolation of Richard III",
        "meaning": "Diminished support by 1485.",
        "significance": "Reduced capacity to resist invasion.",
        "date": "1485"
      },
      {
        "term": "Northern vs Southern Divide",
        "meaning": "Richard stronger in north than south.",
        "significance": "Limited nationwide backing.",
        "date": ""
      },
      {
        "term": "Foreign Backing for Henry Tudor",
        "meaning": "Support from France.",
        "significance": "Enabled successful invasion.",
        "date": ""
      },
      {
        "term": "Dynastic Fusion",
        "meaning": "Union of Lancaster and York.",
        "significance": "Reduced ideological basis for civil war.",
        "date": ""
      },
      {
        "term": "End of Major Dynastic Warfare (Post-1486)",
        "meaning": "No immediate large-scale civil war.",
        "significance": "Marked resolution of succession struggle.",
        "date": ""
      },
      {
        "term": "Strengthening of Monarchical Authority",
        "meaning": "Shift toward stronger Crown under Tudors.",
        "significance": "Reaction to instability of 1450‚Äì85.",
        "date": ""
      },
      {
        "term": "Reduction of Overmighty Subjects",
        "meaning": "Continued decline of magnate independence.",
        "significance": "Prevented recurrence of baronial coups.",
        "date": ""
      },
      {
        "term": "Political Centralisation",
        "meaning": "Greater control from the royal court.",
        "significance": "Structural consequence of Yorkist collapse.",
        "date": ""
      },
      {
        "term": "Transformation of Legitimacy Concept",
        "meaning": "Emphasis on legal sanction and dynastic unity.",
        "significance": "Tudor regime carefully reinforced its claim.",
        "date": ""
      },
      {
        "term": "Shift from Feudal Warfare to Dynastic Statecraft",
        "meaning": "Reduced reliance on private armies.",
        "significance": "Reflected broader evolution of monarchy.",
        "date": ""
      },
      {
        "term": "Memory of Civil War",
        "meaning": "Lingering fear of instability.",
        "significance": "Encouraged obedience to new regime.",
        "date": ""
      }
    ],
    "people": [
      {
        "term": "Richard, Duke of Gloucester",
        "meaning": "Brother of Edward IV and Protector in 1483.",
        "significance": "Central architect of the Yorkist coup.",
        "date": "1483"
      },
      {
        "term": "Edward V",
        "meaning": "Son of Edward IV, briefly king in 1483.",
        "significance": "His removal destabilised Yorkist continuity.",
        "date": "1483"
      },
      {
        "term": "Richard, Duke of York (Prince)",
        "meaning": "Younger son of Edward IV.",
        "significance": "His disappearance intensified suspicion.",
        "date": ""
      },
      {
        "term": "Princes in the Tower",
        "meaning": "Edward V and his brother held in the Tower of London.",
        "significance": "Their disappearance permanently damaged Richard‚Äôs reputation.",
        "date": ""
      },
      {
        "term": "Henry Tudor",
        "meaning": "Lancastrian claimant with distant Beaufort lineage.",
        "significance": "Emerged as alternative to Richard III.",
        "date": ""
      },
      {
        "term": "Elizabeth of York",
        "meaning": "Daughter of Edward IV.",
        "significance": "Key to Tudor legitimacy.",
        "date": ""
      },
      {
        "term": "Elizabeth of York",
        "meaning": "Daughter of Edward IV and Tudor queen.",
        "significance": "United Yorkist bloodline with Tudor dynasty.",
        "date": ""
      }
    ],
    "events": [
      {
        "term": "Coup d‚Äô√©tat (1483)",
        "meaning": "Sudden seizure of power by Richard.",
        "significance": "Overturned the established Yorkist succession.",
        "date": "1483"
      },
      {
        "term": "Arrest of the Woodvilles (1483)",
        "meaning": "Detention of Edward V‚Äôs maternal relatives.",
        "significance": "Neutralised rival faction at court.",
        "date": "1483"
      },
      {
        "term": "Execution of Lord Hastings (1483)",
        "meaning": "Summary execution of a senior Yorkist.",
        "significance": "Demonstrated Richard‚Äôs determination and ruthlessness.",
        "date": "1483"
      },
      {
        "term": "Titulus Regius (1484)",
        "meaning": "Parliamentary act legitimising Richard‚Äôs claim.",
        "significance": "Provided legal foundation for his kingship.",
        "date": "1484"
      },
      {
        "term": "Legitimacy Crisis (1483)",
        "meaning": "Doubts over Richard‚Äôs rightful claim.",
        "significance": "Encouraged opposition among Yorkists.",
        "date": "1483"
      },
      {
        "term": "Buckingham‚Äôs Rebellion (1483)",
        "meaning": "Uprising against Richard III.",
        "significance": "Demonstrated early instability of Richard‚Äôs reign.",
        "date": "1483"
      },
      {
        "term": "Southern Rebellion (1483)",
        "meaning": "Revolts in southern counties.",
        "significance": "Revealed regional opposition.",
        "date": "1483"
      },
      {
        "term": "Failure of Rebellion (1483)",
        "meaning": "Collapse of Buckingham‚Äôs rising.",
        "significance": "Temporarily strengthened Richard‚Äôs position.",
        "date": "1483"
      },
      {
        "term": "Parliament of 1484",
        "meaning": "Richard‚Äôs only parliament.",
        "significance": "Attempted to secure broad political support.",
        "date": ""
      },
      {
        "term": "Legal Reforms (1484)",
        "meaning": "Measures improving access to justice.",
        "significance": "Aimed to build popular legitimacy.",
        "date": "1484"
      },
      {
        "term": "Financial Stability (1484)",
        "meaning": "Continuation of Edward IV‚Äôs fiscal policies.",
        "significance": "Prevented economic collapse.",
        "date": "1484"
      },
      {
        "term": "Death of Anne Neville (1485)",
        "meaning": "Richard‚Äôs queen died.",
        "significance": "Weakened dynastic position.",
        "date": "1485"
      },
      {
        "term": "Death of Edward of Middleham (1484)",
        "meaning": "Richard‚Äôs only legitimate son died.",
        "significance": "Created immediate succession crisis.",
        "date": "1484"
      },
      {
        "term": "Succession Uncertainty (1484‚Äì85)",
        "meaning": "Lack of clear heir.",
        "significance": "Undermined political confidence.",
        "date": "1484"
      },
      {
        "term": "Tudor‚ÄìWoodville Alliance (1483)",
        "meaning": "Agreement to marry Elizabeth of York.",
        "significance": "United Lancastrian and Yorkist claims.",
        "date": "1483"
      },
      {
        "term": "French Support (1485)",
        "meaning": "Financial and military backing for Henry.",
        "significance": "Enabled invasion of England.",
        "date": "1485"
      },
      {
        "term": "Battle of Bosworth (1485)",
        "meaning": "Decisive battle between Richard and Henry Tudor.",
        "significance": "Ended Yorkist monarchy.",
        "date": "1485"
      },
      {
        "term": "Death of Richard III (1485)",
        "meaning": "Killed in battle.",
        "significance": "Ended Plantagenet male line.",
        "date": "1485"
      },
      {
        "term": "Proclamation of Henry VII (1485)",
        "meaning": "Declaration of Tudor kingship.",
        "significance": "Marked beginning of new dynasty.",
        "date": "1485"
      },
      {
        "term": "Marriage to Elizabeth of York (1486)",
        "meaning": "Union of York and Lancaster.",
        "significance": "Symbolically unified rival houses.",
        "date": "1486"
      },
      {
        "term": "Act of Parliament (1485)",
        "meaning": "Backdated Henry‚Äôs reign.",
        "significance": "Declared Richard‚Äôs supporters traitors.",
        "date": "1485"
      },
      {
        "term": "Minority Crisis (1483)",
        "meaning": "Political vulnerability of child king.",
        "significance": "Enabled Gloucester‚Äôs takeover.",
        "date": "1483"
      },
      {
        "term": "Overmighty Subjects (1480s)",
        "meaning": "Powerful nobles like the Stanleys.",
        "significance": "Determined outcome at Bosworth.",
        "date": ""
      },
      {
        "term": "Noble Casualties (1485)",
        "meaning": "Deaths of leading Yorkists.",
        "significance": "Cleared path for Tudor consolidation.",
        "date": "1485"
      },
      {
        "term": "Attainders of Yorkist Supporters (1485)",
        "meaning": "Parliamentary punishment of Richard III‚Äôs loyalists after Bosworth.",
        "significance": "Helped Henry VII secure his new regime by legally dismantling Yorkist resistance.",
        "date": "1485"
      },
      {
        "term": "Marriage Settlement (1486)",
        "meaning": "Formal arrangements for union with Elizabeth of York.",
        "significance": "Secured dynastic reconciliation.",
        "date": "1486"
      },
      {
        "term": "Coronation of Henry VII (1485)",
        "meaning": "Held before Parliament met.",
        "significance": "Emphasised authority derived from kingship, not Parliament.",
        "date": "1485"
      },
      {
        "term": "Parliament of 1485",
        "meaning": "First parliament of Henry VII‚Äôs reign.",
        "significance": "Confirmed Tudor legitimacy and reversed Titulus Regius.",
        "date": ""
      },
      {
        "term": "Political Realignment (1485‚Äì86)",
        "meaning": "Nobles shifting loyalty to Henry VII.",
        "significance": "Enabled peaceful consolidation.",
        "date": "1485"
      },
      {
        "term": "Death of Richard III (1485)",
        "meaning": "Last Plantagenet king killed in battle.",
        "significance": "Ended direct Yorkist male rule.",
        "date": "1485"
      },
      {
        "term": "Succession Crisis (1483‚Äì85)",
        "meaning": "Breakdown in clear dynastic continuity.",
        "significance": "Created conditions for regime change.",
        "date": "1483"
      },
      {
        "term": "Loss of Dynastic Heir (1484)",
        "meaning": "Death of Richard‚Äôs son.",
        "significance": "Weakened confidence in Yorkist future.",
        "date": "1484"
      },
      {
        "term": "Battlefield Kingship",
        "meaning": "Medieval expectation of king leading in battle.",
        "significance": "Richard‚Äôs death fighting reinforced chivalric image but cost him crown.",
        "date": ""
      },
      {
        "term": "Regime Change (1485)",
        "meaning": "Replacement of Yorkist monarchy with Tudor dynasty.",
        "significance": "Ended Wars of the Roses era.",
        "date": "1485"
      },
      {
        "term": "Symbolic End of the Wars of the Roses (1486)",
        "meaning": "Marriage sealing reconciliation.",
        "significance": "Marked ideological closure of conflict.",
        "date": "1486"
      },
      {
        "term": "Tudor Consolidation (1485‚Äì86)",
        "meaning": "Establishing security after Bosworth.",
        "significance": "Determined survival of new dynasty.",
        "date": "1485"
      },
      {
        "term": "Downfall of the Yorkist Monarchy (1483‚Äì1486)",
        "meaning": "Collapse of Plantagenet rule through usurpation, factionalism and military defeat.",
        "significance": "Completed transition from medieval baronial monarchy to early Tudor state.",
        "date": "1483"
      }
    ]
  }
};


/* ==========================================================
   FACTORS TABLE (Comparative snapshot)
   ========================================================== */
const FACTORS_DATA = [
  {
    "factor": "Leadership",
    "yorkist": "Young, charismatic, 6'4\" warrior-king.",
    "lancastrian": "Mentally fragile, physically passive."
  },
  {
    "factor": "Legitimacy",
    "yorkist": "Claim via Lionel of Antwerp (senior line).",
    "lancastrian": "Claim via John of Gaunt (legacy of usurpation in 1399)."
  },
  {
    "factor": "Geopolitics",
    "yorkist": "Supported by London, the South, and naval strength.",
    "lancastrian": "Reliant on the 'Northern Host' (seen as pillagers)."
  },
  {
    "factor": "Succession",
    "yorkist": "Clear Yorkist heirs: Edward, George, Richard.",
    "lancastrian": "Prince Edward disinherited by the Act of Accord."
  }
];

/* ==========================================================
   CONNECTIONS BANK (TEMPLATE)
   Needs >=5 groups per topic; each group has 4 terms.
   ========================================================== */
const CONNECTIONS_BANK = {
  "t1": {
    "title": "1. Topic 1",
    "groups": [
      {
        "label": "Group 1",
        "terms": [
          "Topic1 1A",
          "Topic1 1B",
          "Topic1 1C",
          "Topic1 1D"
        ]
      },
      {
        "label": "Group 2",
        "terms": [
          "Topic1 2A",
          "Topic1 2B",
          "Topic1 2C",
          "Topic1 2D"
        ]
      },
      {
        "label": "Group 3",
        "terms": [
          "Topic1 3A",
          "Topic1 3B",
          "Topic1 3C",
          "Topic1 3D"
        ]
      },
      {
        "label": "Group 4",
        "terms": [
          "Topic1 4A",
          "Topic1 4B",
          "Topic1 4C",
          "Topic1 4D"
        ]
      },
      {
        "label": "Group 5",
        "terms": [
          "Topic1 5A",
          "Topic1 5B",
          "Topic1 5C",
          "Topic1 5D"
        ]
      },
      {
        "label": "Group 6",
        "terms": [
          "Topic1 6A",
          "Topic1 6B",
          "Topic1 6C",
          "Topic1 6D"
        ]
      }
    ]
  },
  "t2": {
    "title": "2. Topic 2",
    "groups": [
      {
        "label": "Group 1",
        "terms": [
          "Topic2 1A",
          "Topic2 1B",
          "Topic2 1C",
          "Topic2 1D"
        ]
      },
      {
        "label": "Group 2",
        "terms": [
          "Topic2 2A",
          "Topic2 2B",
          "Topic2 2C",
          "Topic2 2D"
        ]
      },
      {
        "label": "Group 3",
        "terms": [
          "Topic2 3A",
          "Topic2 3B",
          "Topic2 3C",
          "Topic2 3D"
        ]
      },
      {
        "label": "Group 4",
        "terms": [
          "Topic2 4A",
          "Topic2 4B",
          "Topic2 4C",
          "Topic2 4D"
        ]
      },
      {
        "label": "Group 5",
        "terms": [
          "Topic2 5A",
          "Topic2 5B",
          "Topic2 5C",
          "Topic2 5D"
        ]
      },
      {
        "label": "Group 6",
        "terms": [
          "Topic2 6A",
          "Topic2 6B",
          "Topic2 6C",
          "Topic2 6D"
        ]
      }
    ]
  },
  "t3": {
    "title": "3. Topic 3",
    "groups": [
      {
        "label": "Group 1",
        "terms": [
          "Topic3 1A",
          "Topic3 1B",
          "Topic3 1C",
          "Topic3 1D"
        ]
      },
      {
        "label": "Group 2",
        "terms": [
          "Topic3 2A",
          "Topic3 2B",
          "Topic3 2C",
          "Topic3 2D"
        ]
      },
      {
        "label": "Group 3",
        "terms": [
          "Topic3 3A",
          "Topic3 3B",
          "Topic3 3C",
          "Topic3 3D"
        ]
      },
      {
        "label": "Group 4",
        "terms": [
          "Topic3 4A",
          "Topic3 4B",
          "Topic3 4C",
          "Topic3 4D"
        ]
      },
      {
        "label": "Group 5",
        "terms": [
          "Topic3 5A",
          "Topic3 5B",
          "Topic3 5C",
          "Topic3 5D"
        ]
      },
      {
        "label": "Group 6",
        "terms": [
          "Topic3 6A",
          "Topic3 6B",
          "Topic3 6C",
          "Topic3 6D"
        ]
      }
    ]
  },
  "t4": {
    "title": "4. Topic 4",
    "groups": [
      {
        "label": "Group 1",
        "terms": [
          "Topic4 1A",
          "Topic4 1B",
          "Topic4 1C",
          "Topic4 1D"
        ]
      },
      {
        "label": "Group 2",
        "terms": [
          "Topic4 2A",
          "Topic4 2B",
          "Topic4 2C",
          "Topic4 2D"
        ]
      },
      {
        "label": "Group 3",
        "terms": [
          "Topic4 3A",
          "Topic4 3B",
          "Topic4 3C",
          "Topic4 3D"
        ]
      },
      {
        "label": "Group 4",
        "terms": [
          "Topic4 4A",
          "Topic4 4B",
          "Topic4 4C",
          "Topic4 4D"
        ]
      },
      {
        "label": "Group 5",
        "terms": [
          "Topic4 5A",
          "Topic4 5B",
          "Topic4 5C",
          "Topic4 5D"
        ]
      },
      {
        "label": "Group 6",
        "terms": [
          "Topic4 6A",
          "Topic4 6B",
          "Topic4 6C",
          "Topic4 6D"
        ]
      }
    ]
  }
};

/* ==========================================================
   EMOJI BANK (TEMPLATE)
   ========================================================== */
const EMOJI_BANK = {
  "t1": {
    "terms": [
      {
        "clue": "\ud83e\udde9\ud83d\udcd8",
        "answer": "Key term A",
        "why": "(Add why this is the answer)"
      }
    ],
    "people": [
      {
        "clue": "\ud83d\udc64\u2b50\ufe0f",
        "answer": "Key person A",
        "why": "(Add why this is the answer)"
      }
    ]
  },
  "t2": {
    "terms": [
      {
        "clue": "\ud83e\udde0\ud83d\udca1",
        "answer": "Key term C",
        "why": "(Add why this is the answer)"
      }
    ],
    "people": []
  },
  "t3": {
    "terms": [],
    "people": []
  },
  "t4": {
    "terms": [],
    "people": []
  }
};

/* ==========================================================
   EXAM BANK (TEMPLATE)
   Keep at least 3 questions per topic (recommended).
   ========================================================== */
const EXAM_BANK = [
  {
    "id": "t1_e1",
    "topicId": "t1",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t1_e2",
    "topicId": "t1",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t1_e3",
    "topicId": "t1",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t2_e1",
    "topicId": "t2",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t2_e2",
    "topicId": "t2",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t2_e3",
    "topicId": "t2",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t3_e1",
    "topicId": "t3",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t3_e2",
    "topicId": "t3",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t3_e3",
    "topicId": "t3",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t4_e1",
    "topicId": "t4",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t4_e2",
    "topicId": "t4",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  },
  {
    "id": "t4_e3",
    "topicId": "t4",
    "question": "How far do you agree with the view that \u2026 ? (Template 25-mark)",
    "factors": [
      "Factor 1",
      "Factor 2",
      "Factor 3",
      "Counter / limits"
    ],
    "plan": [
      {
        "title": "Intro",
        "body": "Define the debate and give an overall line of argument."
      },
      {
        "title": "Factor 1",
        "body": "Explain your first factor with specific evidence."
      },
      {
        "title": "Factor 2",
        "body": "Explain your second factor with specific evidence."
      },
      {
        "title": "Factor 3",
        "body": "Explain your third factor with specific evidence."
      },
      {
        "title": "Conclusion",
        "body": "Return to the question and give a clear judgement."
      }
    ],
    "help": [
      "Use precise evidence (names, concepts, studies, examples).",
      "Explain significance (so what?).",
      "Make a comparative judgement across factors."
    ]
  }
];

/* ==========================================================
   STORAGE + STATE
   ========================================================== */
const STORAGE_KEY = "revision_app_pastel_v1";

function baseState(){
  return {
    reviews:{},
    // stats: studied counter (focus backlog is computed from reviews)
    stats:{ studied:0 },
    quiz:{ attempted:0, correct:0, bestStreakAllTime:0 },
    weekly:{},
    topicLevels:{},
    daily:{},
    // Duolingo-style: consecutive days completing the Daily Challenge
    dailyStreak:{ count:0, best:0, lastDate:null },
    // topics toggled off are excluded from flashcards/quizzes/daily challenge
    disabledTopics:{},
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return baseState();
    const s = JSON.parse(raw);
    s.reviews ||= {};
    s.stats ||= { studied:0 };
    s.quiz ||= { attempted:0, correct:0, bestStreakAllTime:0 };
    s.weekly ||= {};
    s.topicLevels ||= {};
    s.daily ||= {};
    s.dailyStreak ||= { count:0, best:0, lastDate:null };
    s.disabledTopics ||= {};
    return s;
  }catch{
    return baseState();
  }
}
let STATE = loadState();
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }


function isTopicEnabled(topicId){
  STATE.disabledTopics ||= {};
  return !STATE.disabledTopics[topicId];
}
function enabledTopicIds(){
  const ids = TOPICS.map(t=>t.id).filter(id=>isTopicEnabled(id));
  return ids.length ? ids : TOPICS.map(t=>t.id);
}
const $ = (id)=>document.getElementById(id);

// Safe HTML escaping for dynamic template strings
function escapeHtml(v){
  return String(v)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function hasText(v){
  return typeof v === "string" ? v.trim().length > 0 : (v != null && String(v).trim().length > 0);
}

function cleanText(v){
  return hasText(v) ? String(v).trim() : "";
}

/* ==========================================================
   DAILY CHALLENGE (purposeful + rotating)
   ========================================================== */
const DAILY_FLASH_GOAL = 12;
const DAILY_QUIZ_GOAL = 70;

function pad2(n){ return String(n).padStart(2,'0'); }
function todayKey(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function keyToDate(k){
  // k = YYYY-MM-DD
  const [y,m,dd] = String(k).split('-').map(n=>parseInt(n,10));
  return new Date(y, (m||1)-1, dd||1);
}
function addDaysKey(k, delta){
  const d = keyToDate(k);
  d.setDate(d.getDate() + delta);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function yesterdayKey(){
  return addDaysKey(todayKey(), -1);
}
function dayOfYear(d){
  const start = new Date(d.getFullYear(), 0, 0);
  const diff = d - start;
  return Math.floor(diff / 86400000);
}
function dailyIndex(){ return dayOfYear(new Date()); }
function getDailyTopicId(){
  // Deterministic rotation: topic depends on the day of year.
  // Exclude any topics toggled off by the student/teacher.
  const ids = enabledTopicIds();
  return ids[dailyIndex() % ids.length];
}
function getDailyExamId(topicId){
  const list = EXAM_BANK.filter(x=>x.topicId===topicId);
  if(!list.length) return null;
  return list[dailyIndex() % list.length].id;
}

function ensureDaily(){
  STATE.daily ||= {};
  const k = todayKey();
  const wantTopic = getDailyTopicId();
  if(!STATE.daily[k]){
    STATE.daily[k] = { topicId: wantTopic, flash:0, quizBest:0, planOpened:false, completed:false };
    saveState();
  }
  // If topic rotation logic changes (or bank changes), keep today aligned.
  if(STATE.daily[k].topicId !== wantTopic){
    STATE.daily[k].topicId = wantTopic;
    // don't wipe progress; just realign.
    saveState();
  }
  return STATE.daily[k];
}

function normalizeDailyStreak(){
  // Duolingo-style: streak remains ‚Äúalive‚Äù if last completion was yesterday.
  STATE.dailyStreak ||= { count:0, best:0, lastDate:null };
  const last = STATE.dailyStreak.lastDate;
  if(!last){
    // Migration / safety: infer last completion from daily log if available
    try{
      const keys = Object.keys(STATE.daily||{}).sort();
      let inferred = null;
      for(let i=keys.length-1;i>=0;i--){
        const k = keys[i];
        if(STATE.daily[k]?.completed){ inferred = k; break; }
      }
      if(inferred){
        STATE.dailyStreak.lastDate = inferred;
        // Compute streak backwards (in case user has a run already)
        let count = 0;
        let cur = inferred;
        while(STATE.daily[cur]?.completed){
          count++;
          cur = addDaysKey(cur, -1);
        }
        STATE.dailyStreak.count = count;
        STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, count);
        saveState();
        return;
      }
    }catch(e){}
    STATE.dailyStreak.count = 0;
    STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, 0);
    saveState();
    return;
  }
  const t = todayKey();
  const y = yesterdayKey();
  if(last === t || last === y) return; // still valid
  // Missed at least one full day ‚Üí streak breaks
  STATE.dailyStreak.count = 0;
  STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, 0);
  STATE.dailyStreak.lastDate = null;
  saveState();
}

function updateDailyStreakOnComplete(){
  STATE.dailyStreak ||= { count:0, best:0, lastDate:null };
  const t = todayKey();
  const last = STATE.dailyStreak.lastDate;
  if(last === t) return; // already counted today
  if(last === yesterdayKey()) STATE.dailyStreak.count = (STATE.dailyStreak.count||0) + 1;
  else STATE.dailyStreak.count = 1;
  STATE.dailyStreak.best = Math.max(STATE.dailyStreak.best||0, STATE.dailyStreak.count);
  STATE.dailyStreak.lastDate = t;
  saveState();
}

function updateDailyUI(){
  const d = ensureDaily();
  const topicTitle = (TOPICS.find(t=>t.id===d.topicId)||{}).title || d.topicId;

  const label = document.getElementById('dailyTopicLabel');
  if(label) label.textContent = topicTitle;

  const timePill = document.getElementById('dailyTimePill');
  if(timePill) timePill.textContent = `üìÖ ${todayKey()} ‚Ä¢ 10‚Äì15 mins`;

  const flashProg = document.getElementById('dmFlashProg');
  if(flashProg) flashProg.textContent = `${Math.min(d.flash, DAILY_FLASH_GOAL)}/${DAILY_FLASH_GOAL}`;

  const quizProg = document.getElementById('dmQuizProg');
  if(quizProg) quizProg.textContent = `${Math.min(100, d.quizBest)}% / ${DAILY_QUIZ_GOAL}%`;

  const planProg = document.getElementById('dmPlanProg');
  if(planProg) planProg.textContent = d.planOpened ? 'Yes' : 'No';

  const flashRow = document.getElementById('dmFlashRow');
  const quizRow  = document.getElementById('dmQuizRow');
  const planRow  = document.getElementById('dmPlanRow');
  const doneFlash = d.flash >= DAILY_FLASH_GOAL;
  const doneQuiz = d.quizBest >= DAILY_QUIZ_GOAL;
  const donePlan = !!d.planOpened;
  if(flashRow) flashRow.style.borderColor = doneFlash ? 'rgba(119,207,163,.55)' : 'rgba(0,0,0,.10)';
  if(quizRow)  quizRow.style.borderColor  = doneQuiz  ? 'rgba(119,207,163,.55)' : 'rgba(0,0,0,.10)';
  if(planRow)  planRow.style.borderColor  = donePlan  ? 'rgba(119,207,163,.55)' : 'rgba(0,0,0,.10)';

  const trophy = document.getElementById('streakCompleteBanner');
  if(trophy){
    if(d.completed) trophy.classList.remove('hidden');
    else trophy.classList.add('hidden');
  }
  try{ renderStreakHero(); }catch(e){}
}


function formatHMS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
}
function msUntilReset(){
  const now = new Date();
  const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);
  return end - now;
}
function streakTier(count){
  if(count >= 30) return "üèÜ Historian Mode (30)";
  if(count >= 14) return "üåü Revolution Ready (14)";
  if(count >= 7)  return "‚úÖ Moderniser (7)";
  if(count >= 3)  return "üå± Reformer (3)";
  if(count >= 1)  return "üî• Started (1)";
  return "Start today";
}
function nextMilestone(count){
  const targets = [3,7,14,30];
  for(const t of targets) if(count < t) return t;
  return 50;
}
let _streakTimer = null;
function renderStreakHero(){
  normalizeDailyStreak();
  const d = ensureDaily();
  const count = STATE.dailyStreak?.count || 0;
  const best  = STATE.dailyStreak?.best || 0;

  const big = $("streakBigNum"); if(big) big.textContent = String(count);
  const bestEl = $("streakBestNum"); if(bestEl) bestEl.textContent = String(best);
  // tier label removed from hero to reduce visual noise

  // Header streak pill
  try{ renderStreakSignal(); }catch(e){}

  // Status + checklist
  const doneToday = !!d.completed;
  const box = $("streakStatusBox");
  const icon = $("streakStatusIcon");
  const textEl = $("streakStatusText");
  const cd = $("streakCountdown");

  const doneFlash = d.flash >= DAILY_FLASH_GOAL;
  const doneQuiz  = d.quizBest >= DAILY_QUIZ_GOAL;
  const donePlan  = !!d.planOpened;

  const flashDot = $("chkFlashDot"); if(flashDot) flashDot.classList.toggle("done", doneFlash);
  const quizDot  = $("chkQuizDot");  if(quizDot)  quizDot.classList.toggle("done", doneQuiz);
  const planDot  = $("chkPlanDot");  if(planDot)  planDot.classList.toggle("done", donePlan);

  const flashVal = $("chkFlashVal"); if(flashVal) flashVal.textContent = `${Math.min(d.flash, DAILY_FLASH_GOAL)}/${DAILY_FLASH_GOAL}`;
  const quizVal  = $("chkQuizVal");  if(quizVal)  quizVal.textContent = `${Math.min(100, d.quizBest)}% / ${DAILY_QUIZ_GOAL}%`;
  const planVal  = $("chkPlanVal");  if(planVal)  planVal.textContent = donePlan ? "Opened" : "Not opened";

  if(box){
    box.classList.toggle("safe", doneToday);
    box.classList.toggle("risk", !doneToday);
  }
  if(icon) icon.textContent = doneToday ? "‚úÖ" : "‚ö†Ô∏è";
  if(textEl){
    textEl.textContent = doneToday
      ? "Streak protected for today ‚Äî come back tomorrow to level it up."
      : "Streak at risk ‚Äî complete today‚Äôs Daily Challenge to protect it.";
  }
  if(cd) cd.textContent = formatHMS(msUntilReset());

  // Milestone progress
  const target = nextMilestone(count);
  const nextLabel = $("nextMilestoneLabel");
  if(nextLabel){
    const remaining = Math.max(0, target - count);
    nextLabel.textContent = remaining === 0
      ? `Unlocked: ${streakTier(count)}`
      : `Next unlock: ${streakTier(target)} ‚Äî ${remaining} to go`;
  }
  const fill = $("milestoneBarFill");
  if(fill){
    const pct = Math.max(0, Math.min(1, count/target)) * 100;
    fill.style.width = `${pct}%`;
  }

  // Week strip (last 7 days ending today)
  const strip = $("weekStrip");
  if(strip){
    const today = todayKey();
    const days = [];
    for(let i=6;i>=0;i--){
      const k = addDaysKey(today, -i);
      const dt = keyToDate(k);
      const letter = ["S","M","T","W","T","F","S"][dt.getDay()];
      const completed = !!STATE.daily?.[k]?.completed;
      const missed = (k !== today) && !completed; // don't mark today as missed until it passes
      days.push({k, letter, completed, missed});
    }
    strip.innerHTML = days.map(dy=>{
      const cls = dy.completed ? "dayBlock done" : (dy.missed ? "dayBlock missed" : "dayBlock");
      const title = dy.completed ? `${dy.k}: Completed` : (dy.missed ? `${dy.k}: Missed` : `${dy.k}: Pending`);
      return `<div class="${cls}" title="${title}">${dy.letter}</div>`;
    }).join("");
  }


  // Completion banner + button behaviour
  const completeBanner = $("streakCompleteBanner");
  if(completeBanner){
    completeBanner.classList.toggle("hidden", !doneToday);
  }

  const btn = $("protectStreakBtn");
  if(btn){
    btn.classList.toggle("hidden", doneToday);
    btn.textContent = "Protect today‚Äôs streak ‚Äî complete today‚Äôs challenge";
    btn.onclick = ()=>{
      // Daily Challenge action buttons were removed; checklist rows are now the navigable controls.
      const row = $("streakHeroCard");
      if(row){
        row.scrollIntoView({ behavior:"smooth", block:"center" });
        row.animate([
          { boxShadow:"0 0 0 rgba(0,0,0,0)" },
          { boxShadow:"0 0 0 6px rgba(242,183,166,.35)" },
          { boxShadow:"0 0 0 rgba(0,0,0,0)" }
        ], { duration:1100, easing:"ease-out" });
      }
    };
  }


  // Countdown tick
  clearInterval(_streakTimer);
  _streakTimer = setInterval(()=>{
    const el = $("streakCountdown");
    if(el) el.textContent = formatHMS(msUntilReset());
  }, 1000);
  updateBannerTitlePill();

}

function checkDailyComplete(){
  const d = ensureDaily();
  if(d.completed) return;
  if(d.flash >= DAILY_FLASH_GOAL && d.quizBest >= DAILY_QUIZ_GOAL && d.planOpened){
    d.completed = true;
    // Update Duolingo-style streak when a Daily Challenge is completed
    updateDailyStreakOnComplete();
    saveState();
    updateDailyUI();
    try{ computeKpis(); }catch(e){}
    showLevelUpBanner(`üèÜ Daily Challenge Complete ‚Ä¢ ${escapeHtml((TOPICS.find(t=>t.id===d.topicId)||{}).title || d.topicId)}`);
    try{ confetti.burst(200); }catch(e){}
  }
}

function recordDailyFlashcard(topicId){
  const d = ensureDaily();
  if(topicId !== d.topicId) return;
  d.flash = (d.flash||0) + 1;
  saveState();
  updateDailyUI();
  checkDailyComplete();
}

function recordDailyQuiz(topicId, percent){
  const d = ensureDaily();
  if(topicId !== d.topicId) return;
  const p = Math.max(0, Math.min(100, Math.round(percent)));
  d.quizBest = Math.max(d.quizBest||0, p);
  saveState();
  updateDailyUI();
  checkDailyComplete();
}

function recordDailyPlanOpened(topicId){
  const d = ensureDaily();
  if(topicId !== d.topicId) return;
  d.planOpened = true;
  saveState();
  updateDailyUI();
  checkDailyComplete();
}

/* ==========================================================
   XP LEVELS + LEVEL-UP NOTIFICATIONS (Topic tiles)
   ========================================================== */
function getXpLevel(avgScore01to2){
  // avgScore is 0..2 based on weak/developing/secure distribution
  // Thresholds chosen to feel achievable but meaningful.
  if(avgScore01to2 >= 1.8) return { key:"master", label:"MASTER", rank:3, icon:"üèÜ" };
  if(avgScore01to2 >= 1.35) return { key:"secure", label:"SECURE", rank:2, icon:"‚úÖ" };
  if(avgScore01to2 >= 0.6) return { key:"developing", label:"DEVELOPING", rank:1, icon:"üå±" };
  return { key:"starting", label:"STARTING OUT", rank:0, icon:"üö¶" };
}

let _bannerTimer = null;
function showLevelUpBanner(html){
  const el = document.getElementById("levelUpBanner");
  if(!el) return;
  el.innerHTML = html;
  el.classList.add("show");
  clearTimeout(_bannerTimer);
  _bannerTimer = setTimeout(()=>{ el.classList.remove("show"); }, 2400);
}

function celebrateLevelUp(topicTitle, levelObj){
  const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  if(!reduceMotion && typeof confetti !== "undefined" && confetti?.burst){
    confetti.burst(160);
  }
  const safeTitle = escapeHtml(topicTitle);
  showLevelUpBanner(`
    <div>${levelObj.icon} Level up: <span style="text-transform:uppercase">${escapeHtml(levelObj.label)}</span></div>
    <div class="smallNote">${safeTitle}</div>
  `);
}

function startOfTodayTs(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.getTime();
}
function addDaysTs(startTs, days){
  const d = new Date(startTs);
  d.setDate(d.getDate()+days);
  d.setHours(0,0,0,0);
  return d.getTime();
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function unique(arr){
  const seen=new Set(), out=[];
  for(const x of arr){
    const k=String(x).toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(x);
  }
  return out;
}
function debounce(fn, ms){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ==========================================================
   ISO WEEK KEY (weekly badge)
   ========================================================== */
function getISOWeekKey(date = new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  const year = d.getUTCFullYear();
  return `${year}-W${String(weekNo).padStart(2,"0")}`;
}
function getWeeklyBucket(){
  const key = getISOWeekKey(new Date());
  STATE.weekly[key] ||= { attempted:0, correct:0, bestStreak:0 };
  return { key, bucket: STATE.weekly[key] };
}
function weeklyPercent(){
  const { bucket } = getWeeklyBucket();
  if(bucket.attempted<=0) return 0;
  return Math.round((bucket.correct/bucket.attempted)*100);
}
function getWeeklyBadge(){
  const { bucket } = getWeeklyBucket();
  const enough = bucket.attempted >= 10;
  if(!enough) return { name:"‚Äî", icon:"üèÖ", note:"Do 10 quiz Qs this week to unlock." };
  const pct = weeklyPercent();
  if(pct>=90) return { name:"Diamond", icon:"üíé", note:"90%+ this week." };
  if(pct>=80) return { name:"Gold", icon:"ü•á", note:"80‚Äì89% this week." };
  if(pct>=65) return { name:"Silver", icon:"ü•à", note:"65‚Äì79% this week." };
  return { name:"Bronze", icon:"ü•â", note:"<65% this week ‚Äî Focus then Mixed." };
}

/* ==========================================================
   CONFETTI (lightweight)
   ========================================================== */
const confetti = (() => {
  const canvas = document.getElementById("confettiCanvas");
  const ctx = canvas.getContext("2d");
  let W=0,H=0,pieces=[],running=false;

  function resize(){
    W = canvas.width = window.innerWidth * devicePixelRatio;
    H = canvas.height = window.innerHeight * devicePixelRatio;
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
  }
  window.addEventListener("resize", resize);

  function spawn(count=110){
    resize();
    const colors = [
      [242,183,166],[247,213,200],[119,207,163],[241,201,122],[239,138,138]
    ];
    pieces = Array.from({length:count}).map(()=> {
      const c = colors[Math.floor(Math.random()*colors.length)];
      return {
        x: Math.random()*W,
        y: -20*Math.random()*devicePixelRatio,
        r: (4+Math.random()*7)*devicePixelRatio,
        vx: (-2 + Math.random()*4)*devicePixelRatio,
        vy: (3 + Math.random()*6)*devicePixelRatio,
        rot: Math.random()*Math.PI,
        vr: (-0.2 + Math.random()*0.4),
        c,
        life: 110 + Math.random()*40
      };
    });
  }
  function tick(){
    if(!running) return;
    ctx.clearRect(0,0,W,H);
    pieces.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.vy += 0.03*devicePixelRatio;
      p.life--;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `rgba(${p.c[0]},${p.c[1]},${p.c[2]},0.9)`;
      ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
      ctx.restore();
    });
    pieces = pieces.filter(p=>p.life>0 && p.y < H+50*devicePixelRatio);
    if(pieces.length===0){ running=false; ctx.clearRect(0,0,W,H); return; }
    requestAnimationFrame(tick);
  }
  function burst(count=110){
    spawn(count);
    running=true;
    requestAnimationFrame(tick);
  }
  return { burst };
})();

/* ==========================================================
   NAV + HEADER RULE
   - Home header only shows on Home
   - Settings button only shown on Home header
   ========================================================== */
function setTab(tabId){
  document.querySelectorAll(".navBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===tabId));
  document.querySelectorAll(".tabpane").forEach(p=>p.classList.toggle("hidden", p.id!==tabId));

  // Home header only
  $("homeHeader").style.display = (tabId==="home") ? "block" : "none";

  // Games: default to hub list when entering the tab
  if(tabId==="games") gamesShowHub();
}
document.querySelectorAll(".navBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>setTab(btn.dataset.tab));
});

/* ==========================================================
   DUOLINGO-LIKE "TODAY" LAYER (guided next step + habits)
   ========================================================== */
function buildPinnedTopics(){
  const row = $("pinnedTopicsRow");
  if(!row) return;
  row.innerHTML = "";
  // Pin first 6 topics by default (you can later persist custom pins)
  TOPICS.slice(0,6).forEach(t=>{
    const b = document.createElement("button");
    b.className = "pill";
    b.type = "button";
    b.textContent = t.title.replace(/^\d+\.\s*/,"");
    b.style.cursor = "pointer";
    b.addEventListener("click", ()=>{
      setTab("study");
      const sel = $("topicSelect");
      if(sel){ sel.value = t.id; sel.dispatchEvent(new Event("change")); }
      // default to all mode when manually picking
      const mode = $("modeSelect"); if(mode) mode.value = "all";
      window.scrollTo({top:0, behavior:"smooth"});
    });
    row.appendChild(b);
  });
}
function wireTodayButtons(){
  const cont = $("btnContinueToday");
  if(cont){
    cont.addEventListener("click", ()=>{
      // Go straight into today's flashcards (first step of the thread)
      if($("goDailyFlash")) $("goDailyFlash").click();
      else setTab("study");
    });
  }
  const smart = $("btnSmartReview");
  if(smart){
    smart.addEventListener("click", ()=>{
      setTab("study");
      const mode = $("modeSelect");
      if(mode){ mode.value = "focus"; mode.dispatchEvent(new Event("change")); }
      window.scrollTo({top:0, behavior:"smooth"});
    });
  }

  const openSettings = $("openSettingsBtn");
  if(openSettings){
    openSettings.addEventListener("click", ()=>setTab("settings"));
  }

  const libExam = $("libGoExam");
  if(libExam) libExam.addEventListener("click", ()=>setTab("exam"));
  const libSet = $("libGoSettings");
  if(libSet) libSet.addEventListener("click", ()=>setTab("settings"));
  const libStudy = $("libStartStudy");
  if(libStudy) libStudy.addEventListener("click", ()=>setTab("study"));
  const libQuiz = $("libStartQuiz");
  if(libQuiz) libQuiz.addEventListener("click", ()=>setTab("quiz"));
  const libGames = $("libStartGames");
  if(libGames) libGames.addEventListener("click", ()=>setTab("games"));
}
function updateWeeklyGoalPill(){
  const el = $("weeklyGoalText");
  if(!el) return;
  // Weekly percent is already computed; convert to a simple days-toward-goal indicator
  // Goal: 5 study days per week (proxy using weeklyPercent)
  const pct = weeklyPercent ? weeklyPercent() : 0;
  const days = Math.min(7, Math.round((pct/100)*7));
  const goal = 5;
  el.textContent = `${Math.min(days,goal)}/${goal}`;
}

/* Games hub navigation */
function gamesShowHub(){
  const hub = $("gamesHub");
  const panes = ["gamesConnPane","gamesEmojiPane","gamesMatchPane","gamesTimelinePane","gamesFactorsPane"];
  if(!hub) return;
  hub.classList.remove("hidden");
  panes.forEach(id => $(id) && $(id).classList.add("hidden"));
  if($("timelineTopicSelect")) tlPopulateSelect();
  window.scrollTo(0,0);
}
function openGamePane(paneId){
  const hub = $("gamesHub");
  const panes = ["gamesConnPane","gamesEmojiPane","gamesMatchPane","gamesTimelinePane","gamesFactorsPane"];
  if(hub) hub.classList.add("hidden");
  panes.forEach(id => $(id) && $(id).classList.toggle("hidden", id!==paneId));
  window.scrollTo(0,0);
}

/* ==========================================================
   FACTORS FACE‚ÄëOFF (table + quick check)
   ========================================================== */
function renderFactorsGame(){
  const table = $("factorsTable");
  if(table){
    const tbody = table.querySelector("tbody");
    if(tbody && tbody.children.length===0){
      FACTORS_DATA.forEach(row=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="vertical-align:top;padding:10px;border-bottom:1px solid var(--line);font-weight:800">${escapeHtml(row.factor)}</td>
          <td class="ffYork" style="vertical-align:top;padding:10px;border-bottom:1px solid var(--line)">${escapeHtml(row.yorkist)}</td>
          <td class="ffLanc" style="vertical-align:top;padding:10px;border-bottom:1px solid var(--line)">${escapeHtml(row.lancastrian)}</td>
        `;
        tr.style.cursor="pointer";
        tr.addEventListener("click", ()=>{
          // toggle a simple self-test mode per row: hide/show alternating sides
          tr.classList.toggle("hideLanc");
          tr.classList.toggle("hideYork");
          const y = tr.querySelector(".ffYork");
          const l = tr.querySelector(".ffLanc");
          if(tr.classList.contains("hideLanc")){
            if(l) l.style.visibility="hidden";
            if(y) y.style.visibility="visible";
          } else if(tr.classList.contains("hideYork")){
            if(y) y.style.visibility="hidden";
            if(l) l.style.visibility="visible";
          } else {
            if(y) y.style.visibility="visible";
            if(l) l.style.visibility="visible";
          }
        });
        tbody.appendChild(tr);
      });
    }
  }

  const box = $("factorsQuizBox");
  if(!box) return;

  // Build 6 quick questions (shuffled)
  const pool = [];
  FACTORS_DATA.forEach(r=>{
    pool.push({prompt:r.yorkist, answer:r.factor, side:"Yorkist"});
    pool.push({prompt:r.lancastrian, answer:r.factor, side:"Lancastrian"});
  });
  shuffle(pool);
  const qs = pool.slice(0,6);

  let i=0, score=0;
  function renderQ(){
    const q = qs[i];
    if(!q){
      box.innerHTML = `
        <div class="note" style="font-weight:900">Done.</div>
        <div class="pill" style="margin-top:10px;display:inline-flex;gap:8px;align-items:center">
          <span style="font-weight:900">${score}/${qs.length}</span>
          <span class="note" style="margin:0">correct</span>
        </div>
        <div style="margin-top:12px">
          <button class="btn primary" type="button" id="ffRetryBtn">Retry</button>
        </div>
      `;
      const rb = $("ffRetryBtn");
      if(rb) rb.addEventListener("click", ()=>{
        i=0; score=0; shuffle(pool); qs.splice(0,qs.length,...pool.slice(0,6)); renderQ();
      });
      return;
    }

    const choices = FACTORS_DATA.map(x=>x.factor);
    // ensure 4 options
    const opts = [q.answer, ...shuffle(choices.filter(c=>c!==q.answer)).slice(0,3)];
    shuffle(opts);

    box.innerHTML = `
      <div class="note" style="margin:0 0 8px 0"><span style="font-weight:900">${i+1}/${qs.length}</span> ‚Ä¢ ${escapeHtml(q.side)} statement</div>
      <div class="card" style="margin:0;padding:14px;background:#fff;border:1px solid var(--line)">
        <div style="font-weight:900;margin-bottom:6px">Which factor is this about?</div>
        <div class="note" style="margin:0">${escapeHtml(q.prompt)}</div>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px">
        ${opts.map(o=>`<button class="btn" type="button" data-ffopt="${escapeAttr(o)}">${escapeHtml(o)}</button>`).join("")}
      </div>
      <div id="ffFeedback" class="note" style="margin-top:10px"></div>
    `;

    box.querySelectorAll("[data-ffopt]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pick = btn.getAttribute("data-ffopt");
        const fb = $("ffFeedback");
        const correct = (pick===q.answer);
        if(correct){
          score++;
          btn.classList.add("primary");
          if(fb) fb.innerHTML = `‚úÖ Correct ‚Äî <b>${escapeHtml(q.answer)}</b>`;
        } else {
          if(fb) fb.innerHTML = `‚ùå Not quite ‚Äî correct answer: <b>${escapeHtml(q.answer)}</b>`;
        }
        // lock buttons, then advance
        box.querySelectorAll("[data-ffopt]").forEach(b=>b.disabled=true);
        setTimeout(()=>{ i++; renderQ(); }, 650);
      });
    });
  }

  renderQ();
}


window.addEventListener("DOMContentLoaded", ()=>{
  const openConn = $("openConnBtn"), openEmoji = $("openEmojiBtn"), openMatch = $("openMatchBtn"), openTimeline = $("openTimelineBtn"), openFactors = $("openFactorsBtn");
  const backConn = $("backFromConn"), backEmoji = $("backFromEmoji"), backMatch = $("backFromMatch"), backTimeline = $("backFromTimeline"), backFactors = $("backFromFactors");
  if(openConn) openConn.addEventListener("click", ()=>openGamePane("gamesConnPane"));
  if(openEmoji) openEmoji.addEventListener("click", ()=>openGamePane("gamesEmojiPane"));
  if(openMatch) openMatch.addEventListener("click", ()=>openGamePane("gamesMatchPane"));
  if(openTimeline) openTimeline.addEventListener("click", ()=>openGamePane("gamesTimelinePane"));
  if(openFactors) openFactors.addEventListener("click", ()=>{ openGamePane("gamesFactorsPane"); renderFactorsGame(); });
  if(backConn) backConn.addEventListener("click", gamesShowHub);
  if(backEmoji) backEmoji.addEventListener("click", gamesShowHub);
  if(backMatch) backMatch.addEventListener("click", gamesShowHub);
  if(backTimeline) backTimeline.addEventListener("click", gamesShowHub);
  if(backFactors) backFactors.addEventListener("click", gamesShowHub);
  if(typeof initTimelineGame==="function") initTimelineGame();
});


/* ==========================================================
   Build knowledge cards (unchanged logic)
   ========================================================== */
function buildKnowledgeCards(){
  const out = [];
  let n = 1;
  const push = (topicId,q,a,tags=[]) => {
    const qText = cleanText(q);
    const aText = cleanText(a);
    if(!qText || !aText) return;
    out.push({
    id:`c${String(n++).padStart(4,"0")}`,
    topicId, q:qText, a:aText, tags, kind:"knowledge"
  });
  };

  for(const topicId of Object.keys(FACT_BANK)){
    const T = FACT_BANK[topicId];

    (T.core||[]).forEach(c => push(topicId, c?.q, c?.a, c?.tags||[]));

(T.terms||[]).forEach(t=>{
  if(!hasText(t?.term) || !hasText(t?.meaning)) return;
  push(topicId, `Define: ${t.term}.`, t.meaning, [t.term,"definition"]);

  if (t.date && String(t.date).trim() !== "") {
    push(topicId, `Date check: ${t.term} ‚Äî when?`, `${t.date}.`, [t.term,"date"]);
  }

  const sig = cleanText(t?.significance);
  if(sig){
    push(topicId, `Why was ${t.term} significant?`, sig, [t.term,"significance"]);
  }
});

    (T.people||[]).forEach(p=>{
      if(!hasText(p?.name) || !hasText(p?.role)) return;
      push(topicId, `Who was ${p.name}?`, p.role, [p.name,"people"]);
      const psig = cleanText(p?.significance);
      if(psig){
        push(topicId, `Why does ${p.name} matter?`, psig, [p.name,"significance"]);
      }
      // (Removed) "Link to ONE policy/event" cards removed per request
});

(T.events||[]).forEach(e=>{
  if(!hasText(e?.name) || !hasText(e?.what)) return;
  push(topicId, `What happened in: ${e.name}?`, e.what, [e.name,"event"]);

  if (e.date && String(e.date).trim() !== "") {
    push(topicId, `Date check: ${e.name} ‚Äî when?`, `${e.date}.`, [e.name,"date"]);
  }

  if(hasText(e?.whyMatters)){
    push(topicId, `Why did ${e.name} matter?`, e.whyMatters, [e.name,"significance"]);
  }
  push(topicId, `Give two consequences of ${e.name}.`, `1) ‚Ä¶  2) ‚Ä¶ (be specific)`, [e.name,"consequences"]);
});
  }
  return out;
}
const ALL_CARDS = buildKnowledgeCards();

/* ==========================================================
   Spaced repetition (unchanged)
   ========================================================== */
function nextIntervalDays(score, prevInterval){
  const base = [0, 1, 3, 7];
  if(prevInterval == null) return base[score];
  if(score === 0) return 0;
  if(score === 1) return Math.max(1, Math.round(prevInterval * 1.3));
  if(score === 2) return Math.max(2, Math.round(prevInterval * 2.0));
  return Math.max(4, Math.round(prevInterval * 3.0));
}
function getReview(cardId){ return STATE.reviews[cardId] || null; }
function setReview(cardId, review){ STATE.reviews[cardId] = Object.assign(STATE.reviews[cardId]||{}, review); saveState(); }

function cardConfidenceLevel(cardId){
  // üî¥ Weak / üü° Developing / üü¢ Secure
  // Based on: repeat Again/Hard + time since last success
  const r = getReview(cardId);
  if(!r) return 'weak';
  const score = typeof r.score === 'number' ? r.score : 0;
  // If the last outcome was Again/Hard, treat as weak until a successful recall
  if(score <= 1) return 'weak';

  const lastSuccessTs = r.lastSuccessTs || (score >= 2 ? r.lastTs : 0) || 0;
  if(!lastSuccessTs) return 'developing';

  const daysSince = (Date.now() - lastSuccessTs) / 86400000;
  if(daysSince > 21) return 'weak';
  if(daysSince > 10) return 'developing';
  return 'secure';
}


function topicConfidence(topicId){
  const cards = ALL_CARDS.filter(c=>c.topicId===topicId);
  if(!cards.length) return { level:'starting', avg:0, counts:{weak:0, developing:0, secure:0}, total:0 };
  const counts = {weak:0, developing:0, secure:0};
  for(const c of cards){
    const lvl = cardConfidenceLevel(c.id);
    counts[lvl] = (counts[lvl]||0)+1;
  }
  const total = cards.length;
  const avg = (counts.developing*1 + counts.secure*2) / total; // 0..2
  const lvl = getXpLevel(avg);
  return { level: lvl.key, levelObj:lvl, avg, counts, total };
}


function renderTopicDashboard(){
  const el = document.getElementById('topicDash');
  if(!el) return;

  const topicIds = Object.keys(FACT_BANK);

  function tileTitleHTML(title){
    // Expect: "1. Something 1855-1894"
    const m = String(title).match(/^(\d+)\.\s*(.*)\s(\d{4}-\d{4})$/);
    if(m){
      return `
        <div>
          <div class="tileNum">${escapeHtml(m[1])}</div>
          <div class="tileMain">${escapeHtml(m[2])}</div>
          <div class="tileYears">${escapeHtml(m[3])}</div>
        </div>
      `;
    }
    return `<div class="tileMain">${escapeHtml(title)}</div>`;
  }


  el.innerHTML = topicIds.map(tid=>{
    const t = FACT_BANK[tid];
    const conf = topicConfidence(tid);

    const total = Math.max(1, conf.total || 0);
    const gRaw = (conf.counts.secure/total)*100;
    const yRaw = (conf.counts.developing/total)*100;

    // ensure the ring always closes cleanly
    let g = Math.round(gRaw);
    let y = Math.round(yRaw);
    if(g + y > 100){
      const over = (g + y) - 100;
      if(y >= over) y -= over; else g -= over;
    }
    const r = 100 - g - y;

    // Liquid fill: weight secure as 1, developing as 0.5 (0‚Äì100%)
    const fill = Math.max(0, Math.min(100, Math.round(((conf.counts.secure + (conf.counts.developing*0.5)) / total) * 100)));

    // Liquid colour shifts with progress (same traffic-light scheme)
    const liq = (fill >= 70) ? "var(--good)" : (fill >= 35) ? "var(--warn)" : "var(--bad)";

    const lvl = conf.levelObj || getXpLevel(conf.avg||0);
    const badgeText = lvl.label;

    // Level-up detection per topic (stored in localStorage)
    STATE.topicLevels ||= {};
    const prevRank = (typeof STATE.topicLevels[tid] === "number") ? STATE.topicLevels[tid] : null;
    if(prevRank === null){
      STATE.topicLevels[tid] = lvl.rank;
      saveState();
    }else if(lvl.rank > prevRank){
      STATE.topicLevels[tid] = lvl.rank;
      saveState();
      celebrateLevelUp(t.title, lvl);
    }

    return `
      <button class="topicTile ${isTopicEnabled(tid) ? "" : "isDisabled"}" data-topic="${tid}" title="Open this topic">
        <div class="progressTank" style="--fill:${fill}%; --liq:${liq};">
          
          <div class="topicToggleWrap" title="Toggle this topic on/off">
            <label class="switch">
              <input type="checkbox" class="topicToggle" data-topic-toggle="${tid}" ${isTopicEnabled(tid) ? "checked" : ""} aria-label="Toggle topic ${tid}">
              <span class="slider"></span>
            </label>
          </div>
<div class="progressLiquid"></div>
          <div class="tankContent">
            ${tileTitleHTML(t.title)}
          </div>
        </div>
        <div class="levelBadge level-${lvl.key}">${badgeText}</div>
      </button>
    `;
  }).join('');

  // click to jump topic into Study (Focus mode)
  el.querySelectorAll('[data-topic]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tid = btn.getAttribute('data-topic');

      // switch to Study tabpane
      if(typeof setTab === "function") setTab("study");

      // set filters to this topic + focus mode
      const ts = document.getElementById("topicSelect");
      if(ts){ ts.value = tid; ts.dispatchEvent(new Event("change")); }

      const ms = document.getElementById("modeSelect");
      if(ms){ ms.value = "all"; ms.dispatchEvent(new Event("change")); }

      // refresh card list
      if(typeof loadNextCard === "function") loadNextCard();

      // bring the card into view
      const frame = document.getElementById("flashcardFrame");
      if(frame) frame.scrollIntoView({behavior:"smooth", block:"start"});
    });
  });

  // Topic toggles: on/off controls (exclude from flashcards/quizzes/daily challenge)
  // IMPORTANT: The whole tile is a <button>. The toggle sits inside it.
  // On some browsers, clicking the slider/label can bubble up and trigger the tile click.
  // So we stop propagation for the wrapper AND for pointer events (touch/mouse) in capture phase.
  el.querySelectorAll('.topicToggleWrap').forEach(wrap=>{
    const stop = (ev)=>{ ev.stopPropagation(); };
    // capture phase = safest (prevents the tile button click handler)
    ["pointerdown","mousedown","touchstart","click"].forEach(evt=>{
      wrap.addEventListener(evt, stop, true);
    });
  });

  el.querySelectorAll('[data-topic-toggle]').forEach(inp=>{
    // Keep these as a backstop (if the click lands on the input itself)
    inp.addEventListener('click', (ev)=>{ ev.stopPropagation(); }, true);

    inp.addEventListener('change', (ev)=>{
      ev.stopPropagation();
      const tid = inp.getAttribute('data-topic-toggle');
      STATE.disabledTopics ||= {};
      if(inp.checked){
        delete STATE.disabledTopics[tid];
      }else{
        STATE.disabledTopics[tid] = true;
      }
      saveState();

      // If the currently-selected study/quiz topic is now disabled, bounce to ALL/MIXED
      const ts = document.getElementById("topicSelect");
      if(ts && ts.value !== "ALL" && !isTopicEnabled(ts.value)) ts.value = "ALL";
      const ms = document.getElementById("mcqTopicSelect");
      if(ms && ms.value !== "MIXED" && !isTopicEnabled(ms.value)) ms.value = "MIXED";

      // Refresh UI + daily topic (if needed)
      try{ populateSelectors(); }catch(e){}
      try{ renderTopicDashboard(); }catch(e){}
      try{ renderTopicTiles(); }catch(e){} // legacy tiles (if present)
      try{ updateDailyUI(); }catch(e){}
      try{ computeKpis(); }catch(e){}
    });
  });
}


/* ==========================================================
   Populate dropdowns + tiles
   ========================================================== */
function populateTopics(){
  const sel = $("topicSelect");
  const selQuiz = $("mcqTopicSelect");
  const selMatch = $("matchTopicSelect");
  const selEmoji = $("emojiTopicSelect");
  const selExamFilter = $("examTopicSelect");

  sel.innerHTML = "";
  selQuiz.innerHTML = "";
  selMatch.innerHTML = "";
  selEmoji.innerHTML = "";
  selExamFilter.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "ALL";
  optAll.textContent = "üåç All topics (class order)";
  sel.appendChild(optAll);

  const addMixed = (selectEl)=>{
    const opt = document.createElement("option");
    opt.value = "MIXED";
    opt.textContent = "üéØ Mixed (all topics)";
    selectEl.appendChild(opt);
  };
  addMixed(selQuiz);
  addMixed(selMatch);
  addMixed(selEmoji);

  const exAll = document.createElement("option");
  exAll.value="ALL"; exAll.textContent="üåç All topics";
  selExamFilter.appendChild(exAll);

  TOPICS.forEach(t=>{
    const o = document.createElement("option");
    o.value = t.id;
    o.textContent = t.title;
    sel.appendChild(o);

    const o2 = document.createElement("option");
    o2.value = t.id; o2.textContent = t.title;
    if(!isTopicEnabled(t.id)){ o2.disabled = true; o2.textContent = t.title + ' (off)'; }
    selQuiz.appendChild(o2);

    const o3 = document.createElement("option");
    o3.value = t.id; o3.textContent = t.title;
    if(!isTopicEnabled(t.id)){ o3.disabled = true; o3.textContent = t.title + ' (off)'; }
    selMatch.appendChild(o3);

    const o4 = document.createElement("option");
    o4.value = t.id; o4.textContent = t.title;
    if(!isTopicEnabled(t.id)){ o4.disabled = true; o4.textContent = t.title + ' (off)'; }
    selEmoji.appendChild(o4);

    const o5 = document.createElement("option");
    o5.value = t.id; o5.textContent = t.title;
    selExamFilter.appendChild(o5);
  });
}

function renderTopicTiles(){
  const box = $("topicTiles");
  box.innerHTML = "";
  TOPICS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.style.flex="1";
    b.style.minWidth="250px";
    b.innerHTML = `
  <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
    <div>
      üìö <b>${t.title}</b>
      <div class="note" style="margin-top:4px">
        Tap to jump into Focus for this topic
      </div>
      <div class="note" style="margin-top:6px">
        ${(()=>{ 
          const c = topicConfidence(t.id);
          const lab = c.level==='secure' ? 'üü¢ Secure' : (c.level==='developing' ? 'üü° Developing' : 'üî¥ Weak');
          return `${lab} ¬∑ ${c.counts.secure} secure / ${c.counts.developing} developing / ${c.counts.weak} weak`;
        })()}
      </div>
    </div>
    <div class="chip">${topicConfidence(t.id).total}</div>
  </div>
`;
    b.addEventListener("click", ()=>{
      setTab("study");
      $("topicSelect").value = t.id;
      $("modeSelect").value = "all";
      $("orderSelect").value = "ordered";
      loadNextCard();
    });
    box.appendChild(b);
  });
}

/* ==========================================================
   KPIs + ring + badge + streak (tasteful)
   ========================================================== */
// ---------------------------
// Header microcopy upgrades
// ---------------------------
const HOOK_SESSION_KEY = "APP_headerHookSessions";
const HOOK_INDEX_KEY   = "APP_headerHookIndex";

function bumpHeaderSessions(){
  const n = Number(localStorage.getItem(HOOK_SESSION_KEY) || "0") + 1;
  localStorage.setItem(HOOK_SESSION_KEY, String(n));
  // Rotate hook every 3 sessions (keeps it fresh, not noisy)
  if(n % 3 === 1){
    const i = Number(localStorage.getItem(HOOK_INDEX_KEY) || "0") + 1;
    localStorage.setItem(HOOK_INDEX_KEY, String(i));
  }
  return n;
}

function computeStatusLine(){
  const completed = STATE.stats?.studied || 0;
  return `Exam revision in progress ¬∑ ${completed} cards completed`;
}

function pickHook(){
  const hooks = [
    "Aim for short, frequent sessions (10‚Äì15 mins)",
    "If it feels easy, switch to Focus mode",
    "Use precise keywords, then explain the significance",
    "Mix topics to reduce confusion between similar ideas",
    "After a quiz, revisit the cards you missed",
  ];
// Behaviour-based nudges
  const attempted = STATE.quiz?.attempted || 0;
  const focus = computeFocusCount();
  if(attempted === 0) hooks.unshift("Quick win: do 10 MCQs after 3 flashcards");
  if(focus >= 20) hooks.unshift("Next step: strengthen weakest topics");

  const idx = Number(localStorage.getItem(HOOK_INDEX_KEY) || "0");
  return hooks[Math.abs(idx) % hooks.length];
}

function updateHeaderCopy(){
  const statusEl = document.getElementById("statusLine");
  const hookEl   = document.getElementById("hookLine");
  if(statusEl) statusEl.textContent = computeStatusLine();
  if(hookEl) hookEl.textContent = pickHook();
}


// Banner title pill effects (subtle)
function bannerTitleEl(){
  return document.querySelector(".banner-title-pill");
}
function isStreakMilestone(n){
  return [3, 7, 14, 30, 50, 100].includes(Number(n||0));
}
function updateBannerTitlePill(){
  const el = bannerTitleEl();
  if(!el) return;

  const badge = getWeeklyBadge ? getWeeklyBadge() : null;
  const isDiamond = badge && String(badge.name) === "Diamond";

  const streak = STATE.dailyStreak?.count || 0;

  el.classList.toggle("pill-diamond", !!isDiamond);

  // one-off pulse on milestones (only once per day per milestone)
  const token = `${streak}-${todayKey()}`;
  const storageKey = "ru_banner_pill_milestone_token";
  const lastShown = localStorage.getItem(storageKey);

  if(isStreakMilestone(streak) && lastShown !== token){
    localStorage.setItem(storageKey, token);
    el.classList.add("pill-pulse");
    window.setTimeout(()=> el.classList.remove("pill-pulse"), 1100);
  }
}


function weeklySignalSubtext(name){
  const n = String(name||"").toLowerCase();
  if(n.includes("diamond")) return "Top-tier engagement";
  if(n.includes("gold"))    return "Strong consistency";
  if(n.includes("silver"))  return "Good momentum";
  if(n.includes("bronze"))  return "Back on track";
  return "Keep momentum rolling";
}

function renderWeeklySignal(badge){
  const pill = document.getElementById("weeklyBadgePill");
  if(!pill) return;
  const top = `${badge.icon} ${badge.name} week`;
  const sub = weeklySignalSubtext(badge.name);
  pill.innerHTML = `<div class="pillTop">${top}</div><div class="pillSub">${sub}</div>`;
  updateBannerTitlePill();

}

function renderStreakSignal(){
  const btn = document.getElementById("streakPill");
  if(!btn) return;

  const count = STATE.dailyStreak?.count || 0;
  const last = STATE.dailyStreak?.lastDate;
  const t = todayKey();
  const y = yesterdayKey();

  let top = "Start today";
  let sub = "Don‚Äôt break the chain";

  if(last === t){
    top = "Active today";
    sub = "Don‚Äôt break the chain";
  }else if(last === y){
    top = "Keep it alive";
    sub = "";
  }else if(count > 0){
    top = "Restart today";
    sub = "Rebuild the chain";
  }

  btn.innerHTML = `<div class="pillTopRow"><span>${top}</span> <span class="streakBubble">${count}</span></div>${sub ? `<div class="pillSub">${sub}</div>` : ""}`;
  updateBannerTitlePill();

}


function computeProgressScore(){
  const attempted = STATE.quiz?.attempted || 0;
  const correct = STATE.quiz?.correct || 0;
  if(attempted <= 0) return 0;
  return Math.round((correct / attempted) * 100);
}
function computeFocusCount(){
  // Focus count = backlog of cards flagged as needing focus (üòê or ‚òπÔ∏è).
  // This means: 0 for new users, increases when they rate üòê/‚òπÔ∏è, and drops again when they later rate üôÇ.
  let n = 0;
  for(const c of ALL_CARDS){
    if(!isTopicEnabled(c.topicId)) continue;
    const r = getReview(c.id);
    if(r && Number(r.score) <= 1) n++;
  }
  return n;
}
function setRing(percent){
  const p = Math.max(0, Math.min(100, percent));
  // UI moved to a simple banner pill on mobile/desktop
  const el = $("kpiQuiz");
  if(el) el.textContent = `${p}%`;
}
function computeKpis(){
  const focusCount = computeFocusCount();
  const progress = computeProgressScore();

  $("kpiStudied").textContent = String(STATE.stats?.studied || 0);
  $("kpiFocus").textContent = String(focusCount);
  setRing(progress);

  const badge = getWeeklyBadge();
  // Banner microcopy (status + rotating teacher whisper)
  try{ updateHeaderCopy(); }catch(e){}

  // Weekly signal pill (meaning, not stats)
  try{ renderWeeklySignal(badge); }catch(e){}

  // progress note card removed from home; keep microcopy in weekly signal + streak panel

  // Daily streak (Duolingo-style)
  normalizeDailyStreak();
  try{ renderStreakHero(); }catch(e){}
  try{ renderStreakSignal(); }catch(e){}
  // Update topic confidence dashboard
  try{ renderTopicDashboard(); }catch(e){}
}
computeKpis();
updateDailyUI();

/* Home quick buttons (legacy IDs kept for safety) */

function goDailyFocus(){
  const d = ensureDaily();
  setTab("study");
  $("topicSelect").value = d.topicId;
  $("modeSelect").value = "all";
  $("orderSelect").value = "random";
  loadNextCard();
}
function goDailyQuiz(){
  const d = ensureDaily();
  setTab("quiz");
  $("mcqTopicSelect").value = d.topicId;
  $("mcqCount").value = "10";
  startQuiz();
}
function goDailyExam(){
  const d = ensureDaily();
  setTab("exam");
  const exFilter = $("examTopicSelect");
  if(exFilter){ exFilter.value = d.topicId; exFilter.dispatchEvent(new Event("change")); }
  const exId = getDailyExamId(d.topicId);
  if(exId){ $("examSelect").value = exId; renderExamQuestion(); }
}

{ const _b = document.getElementById('btnGoFocus'); if(_b) _b.addEventListener('click', goDailyFocus); }
{ const _b = document.getElementById('btnGoMixed'); if(_b) _b.addEventListener('click', goDailyQuiz); }
{ const _b = document.getElementById('btnGoExam'); if(_b) _b.addEventListener('click', goDailyExam); }

// Daily Challenge navigable checklist rows (these replace the removed top action buttons)
$("goDailyFlash").addEventListener("click", goDailyFocus);
$("goDailyQuiz").addEventListener("click", goDailyQuiz);
$("goDailyPlan").addEventListener("click", goDailyExam);

/* ==========================================================
   FLASHCARDS
   ========================================================== */
let CURRENT = { list:[], idx:0, card:null };

function getTopicIndex(topicId){
  const idx = TOPICS.findIndex(t=>t.id===topicId);
  return idx < 0 ? 999 : idx;
}
function getFilteredCards(){
  const topic = $("topicSelect").value;
  const mode = $("modeSelect").value;     // focus | all
  if(!["focus","all"].includes(mode)) $("modeSelect").value = "all";
  const order = $("orderSelect").value;   // ordered | random
  const q = $("searchInput").value.trim().toLowerCase();

  let list = ALL_CARDS.slice();

  // Exclude toggled-off topics
  list = list.filter(c=>isTopicEnabled(c.topicId));
  if(topic !== "ALL") list = list.filter(c=>c.topicId===topic);

  if(mode === "focus"){
    // Focus mode shows ONLY cards the student has flagged as needing focus (üòê or ‚òπÔ∏è).
    // New users start with 0 focus cards; unseen cards are excluded.
    list = list.filter(c=>{
      const r = getReview(c.id);
      return !!r && Number(r.score) <= 1;
    });
  }

  if(q){
    list = list.filter(c => (c.q + " " + c.a + " " + (c.tags||[]).join(" ")).toLowerCase().includes(q));
  }

  if(order === "random"){
    list.sort(()=>Math.random()-0.5);
  }else{
    list.sort((a,b)=>{
      const ta = getTopicIndex(a.topicId);
      const tb = getTopicIndex(b.topicId);
      if(ta !== tb) return ta - tb;

      const ra = getReview(a.id);
      const rb = getReview(b.id);

      const aUnseen = !ra;
      const bUnseen = !rb;
      if(aUnseen !== bUnseen) return aUnseen ? -1 : 1;

      const da = ra?.dueTs ?? Number.MAX_SAFE_INTEGER;
      const db = rb?.dueTs ?? Number.MAX_SAFE_INTEGER;
      if(da !== db) return da - db;

      return a.id.localeCompare(b.id);
    });
  }
  return list;
}
function loadNextCard(){
  CURRENT.list = getFilteredCards();
  CURRENT.idx = 0;
  CURRENT.card = CURRENT.list[0] || null;

  if(!CURRENT.card){
    $("qText").textContent = "No cards match these filters. Try switching topic or clearing search.";
    $("aBox").classList.add("hidden");
    const rb = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
    if(rb) rb.textContent = "üëÄ Reveal answer";
    $("cardMeta").textContent = "üÉè Card 0/0";
    return;
  }
  renderCard();
}
function renderCard(){
  const c = CURRENT.card;
  $("qText").textContent = c.q;
  $("aText").textContent = c.a;
  $("aBox").classList.add("hidden");

  // Reset reveal button label whenever a new card is rendered
  const rb = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
  if(rb) rb.textContent = "üëÄ Reveal answer";

  const mode = $("modeSelect").value;
  const badge = mode === "focus" ? "üéØ FOCUS" : "üìö STUDY";
  $("cardMeta").textContent = `üÉè ${CURRENT.idx+1}/${CURRENT.list.length} ‚Ä¢ ${badge}`;
}
function nextCard(){
  if(!CURRENT.list.length){ loadNextCard(); return; }
  CURRENT.idx = (CURRENT.idx + 1) % CURRENT.list.length;
  CURRENT.card = CURRENT.list[CURRENT.idx];
  renderCard();
}

$("topicSelect").addEventListener("change", loadNextCard);
$("modeSelect").addEventListener("change", loadNextCard);
$("orderSelect").addEventListener("change", loadNextCard);
$("searchInput").addEventListener("input", debounce(loadNextCard, 250));

(function(){
  const revealBtn = document.getElementById("btnRevealBand") || document.getElementById("btnReveal");
  const aBox = document.getElementById("aBox");
  if(revealBtn && aBox){
    const syncLabel = ()=>{
      const isHidden = aBox.classList.contains("hidden");
      revealBtn.textContent = isHidden ? "üëÄ Reveal answer" : "üôà Hide answer";
    };
    revealBtn.addEventListener("click", ()=>{
      // If no card is loaded yet, load one first.
      if(!CURRENT.card){ loadNextCard(); }
      aBox.classList.toggle("hidden");
      syncLabel();
    });
    // Ensure correct label on load
    syncLabel();
  }
  // Skip button removed from UI (no binding needed).
})();
document.querySelectorAll('#study [data-score]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(!CURRENT.card) return;

    const score = Number(btn.dataset.score);
    const id = CURRENT.card.id;
    const todayTs = startOfTodayTs();
    const prev = getReview(id);

    const prevInterval = prev ? prev.intervalDays : null;
    const intervalDays = nextIntervalDays(score, prevInterval);
    const dueTs = addDaysTs(todayTs, intervalDays);

    setReview(id, {
      lastTs: todayTs,
      dueTs,
      intervalDays,
      score,
      // Preserve the most recent successful recall timestamp for traffic-lights/confidence
      lastSuccessTs: (score >= 2) ? todayTs : (prev?.lastSuccessTs || 0),
      times: (prev?.times||0)+1
    });

    STATE.stats.studied = (STATE.stats.studied||0)+1;
    saveState();
    // Daily challenge progress (only counts if today‚Äôs topic matches)
    recordDailyFlashcard(CURRENT.card.topicId);
    computeKpis();
    nextCard();
  });
});

/* ==========================================================
   QUIZ BANK (auto-generated, unchanged logic)
   ========================================================== */
function allTerms(){
  return Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].terms||[]).map(x=>({...x, topicId:tid})));
}
function allPeople(){
  return Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].people||[]).map(x=>({...x, topicId:tid})));
}
function allEvents(){
  return Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].events||[]).map(x=>({...x, topicId:tid})));
}
function buildMcqBank(){
  const bank = [];
  const TERMS = allTerms();
  const PEOPLE = allPeople();
  const EVENTS = allEvents();

  const termDates = TERMS.filter(t=>hasText(t?.date)).map(t=>cleanText(t.date));
  const termMeans = TERMS.map(t=>cleanText(t?.meaning)).filter(Boolean);
  const termSigs  = TERMS.map(t=>cleanText(t?.significance)).filter(Boolean);
  const peopleRoles = PEOPLE.map(p=>cleanText(p?.role)).filter(Boolean);
  const peopleSigs  = PEOPLE.map(p=>cleanText(p?.significance)).filter(Boolean);
  const eventDates = EVENTS.filter(e=>hasText(e?.date)).map(e=>cleanText(e.date));
  const eventWhats  = EVENTS.map(e=>cleanText(e?.what)).filter(Boolean);

  function push(topicId,q,choices,answer,explain){
    if(!hasText(q) || !hasText(answer) || !hasText(explain)) return;
    const cleanedChoices = (choices||[]).map(cleanText).filter(Boolean);
    const uniqueChoices = [...new Set(cleanedChoices)];
    if(uniqueChoices.length < 2 || !uniqueChoices.includes(cleanText(answer))) return;
    bank.push({ topicId, q:cleanText(q), choices:uniqueChoices, answer:cleanText(answer), explain:cleanText(explain) });
  }

  TERMS.forEach(t=>{
    if(!hasText(t?.term) || !hasText(t?.meaning)) return;
    if (t.date && String(t.date).trim() !== "") {
  const wrongDates = shuffle(
    termDates.filter(d => d !== String(t.date))
  ).slice(0, 3);

  push(
    t.topicId,
    `When was: ${t.term}?`,
    shuffle([String(t.date), ...wrongDates]),
    String(t.date),
    `Correct: ${t.date}. Why it matters: ${t.significance}`
  );
}

    const meaningText = cleanText(t.meaning);
    const wrongDefs = shuffle(termMeans.filter(m=>m!==meaningText)).slice(0,3);
    push(t.topicId, `Which definition best matches: ${t.term}?`, shuffle([meaningText, ...wrongDefs]), meaningText,
      `Correct: ${t.meaning}`);

    const sigText = (t.significance ?? "").toString().trim();
    if(sigText){
      const wrongSigs = shuffle(termSigs.filter(s=>s!==sigText)).slice(0,3);
      push(t.topicId, `Which significance best fits: ${t.term}?`, shuffle([sigText, ...wrongSigs]), sigText,
        `Correct: ${sigText}`);

      const sigPrompt = sigText;
      const distractorTerms = shuffle(TERMS.filter(x=>x.term!==t.term).map(x=>x.term)).slice(0,3);
      push(t.topicId, `Which term matches this? ‚Äú${sigPrompt}‚Äù`, shuffle([t.term, ...distractorTerms]), t.term,
        `Correct: ${t.term}${(t.date && String(t.date).trim()!=="") ? ` (${t.date})` : ""}.`);
    }
  });

  PEOPLE.forEach(p=>{
    if(!hasText(p?.name) || !hasText(p?.role)) return;
    const roleText = cleanText(p.role);
    const wrongRoles = shuffle(peopleRoles.filter(r=>r!==roleText)).slice(0,3);
    push(p.topicId, `Which role best matches: ${p.name}?`, shuffle([roleText, ...wrongRoles]), roleText,
      `Correct: ${p.role}.`);

    const psigText = (p.significance ?? "").toString().trim();
    if(psigText){
      const wrongSig = shuffle(peopleSigs.filter(s=>s!==psigText)).slice(0,3);
      push(p.topicId, `Which significance best fits: ${p.name}?`, shuffle([psigText, ...wrongSig]), psigText,
        `Correct: ${psigText}`);

      const desc = psigText;
      const distractors = shuffle(PEOPLE.filter(x=>x.name!==p.name).map(x=>x.name)).slice(0,3);
      push(p.topicId, `Who is described? ‚Äú${desc}‚Äù`, shuffle([p.name, ...distractors]), p.name,
        `Correct: ${p.name} (${p.role}).`);
    }
  });

EVENTS.forEach(e=>{
 if(!hasText(e?.name) || !hasText(e?.what)) return;
 if (e.date && String(e.date).trim() !== "") {
  const wrongDates = shuffle(
    eventDates.filter(d => d !== String(e.date))
  ).slice(0, 3);

  push(
    e.topicId,
    `Date check: ${e.name} ‚Äî when?`,
    shuffle([String(e.date), ...wrongDates]),
    String(e.date),
    `Correct: ${e.date}. Why it matters: ${e.whyMatters}`
  );
}

    const whatText = cleanText(e.what);
    const wrongWhat = shuffle(eventWhats.filter(w=>w!==whatText)).slice(0,3);
    push(e.topicId, `What happened in: ${e.name}?`, shuffle([whatText, ...wrongWhat]), whatText,
      `Correct: ${e.what}`);

    const whyPrompt = cleanText(e.whyMatters);
    if(whyPrompt){
      const distractorEvents = shuffle(EVENTS.filter(x=>hasText(x?.name) && x.name!==e.name).map(x=>x.name)).slice(0,3);
      push(
        e.topicId,
        `Which event matches this impact? ‚Äú${whyPrompt}‚Äù`,
        shuffle([e.name, ...distractorEvents]),
        e.name,
        `Correct: ${e.name}${(e.date && String(e.date).trim()!=="") ? ` (${e.date})` : ""}.`
      );
    }
  });

  return bank;
}
const MCQ_BANK_MANUAL = Array.isArray(globalThis.MCQ_BANK_MANUAL) ? globalThis.MCQ_BANK_MANUAL : [];
const MCQ_BANK = [...MCQ_BANK_MANUAL, ...buildMcqBank()];

function getQuizPool(topicId){
  const enabled = (x)=>isTopicEnabled(x.topicId);
  if(topicId === "MIXED") return MCQ_BANK.filter(enabled);
  // If a topic is toggled off, it should yield an empty quiz pool
  if(!isTopicEnabled(topicId)) return [];
  return MCQ_BANK.filter(x=>x.topicId===topicId).filter(enabled);
}

/* QUIZ state + streaks */
let QUIZ = { list:[], idx:0, score:0, locked:false, streak:0, best:0 };

function startQuiz(){
  const topicId = $("mcqTopicSelect").value;
  const count = Number($("mcqCount").value);

  const pool = getQuizPool(topicId);
  QUIZ.list = shuffle(pool).slice(0, Math.min(count, pool.length));
  QUIZ.idx = 0;
  QUIZ.score = 0;
  QUIZ.locked = false;
  QUIZ.streak = 0;
  QUIZ.best = 0;
  QUIZ.wrong = [];
  QUIZ.topicId = topicId;
  if($('quizSummary')) $('quizSummary').classList.add('hidden');

  if(!QUIZ.list.length){
    $("quizEmpty").classList.remove("hidden");
    $("quizBox").classList.add("hidden");
    $("quizEmpty").textContent = "No complete quiz questions are available for this selection yet. Try another topic or Mixed mode.";
    return;
  }

  $("quizStreakPill").textContent = `üî• Streak: ${QUIZ.streak}`;
  $("quizBestStreakPill").textContent = `üèÜ Best: ${QUIZ.best}`;

  $("quizEmpty").classList.add("hidden");
  $("quizBox").classList.remove("hidden");
  $("quizExplainer").textContent = "Pick an answer.";
  renderQuizQ();
}

$("btnStartQuiz").addEventListener("click", startQuiz);

$("btnNextQ").addEventListener("click", ()=>{
  if(!QUIZ.list.length) return;
  QUIZ.idx++;
  QUIZ.locked=false;

  if(QUIZ.idx >= QUIZ.list.length){
    $("quizQ").textContent = `Finished! Final score: ${QUIZ.score}/${QUIZ.list.length}`;
    $("quizChoices").innerHTML = "";
    $("quizMeta").textContent = "Done";
    $("quizExplainer").textContent = `Progress score: ${computeProgressScore()}% ‚Ä¢ Weekly: ${weeklyPercent()}%`;

    const percent = QUIZ.list.length ? Math.round((QUIZ.score / QUIZ.list.length) * 100) : 0;
    recordDailyQuiz(QUIZ.topicId, percent);

    confetti.burst(140);
    computeKpis();

    // Show summary panel
    if($("quizSummary")){
      $("quizSummary").classList.remove("hidden");
      const acc = QUIZ.list.length ? Math.round((QUIZ.score/QUIZ.list.length)*100) : 0;
      $("sumAcc").textContent = acc + "%";
      $("sumBest").textContent = QUIZ.best;
      $("sumScore").textContent = `${QUIZ.score}/${QUIZ.list.length}`;
      $("quizSummaryNote").textContent = (acc>=70) ? "On track. Push for 80%+ next time." : "Target: hit 70%+ by retrying your weak set.";
    }
    return;
  }
  $("quizExplainer").textContent = "Pick an answer.";
  
// Quiz summary actions
if($("btnBackToToday")){
  $("btnBackToToday").addEventListener("click", ()=>setTab("home"));
}
if($("btnRetryWeak")){
  $("btnRetryWeak").addEventListener("click", ()=>{
    // Build a short retry quiz from wrong answers if available, otherwise restart the same quiz
    if(QUIZ.wrong && QUIZ.wrong.length){
      QUIZ.list = shuffle(QUIZ.wrong).slice(0, Math.min(10, QUIZ.wrong.length));
      QUIZ.idx = 0; QUIZ.score = 0; QUIZ.locked=false; QUIZ.streak=0; QUIZ.best=0;
      if($("quizSummary")) $("quizSummary").classList.add("hidden");
      $("quizMeta").textContent = `Q 1/${QUIZ.list.length}`;
      $("quizExplainer").textContent = "Retry set: pick an answer.";
      renderQuizQ();
    }else{
      startQuiz();
    }
  });
}
renderQuizQ();
});

function renderQuizQ(){
  const q = QUIZ.list[QUIZ.idx];
  if(!q) return;
  $("quizMeta").textContent = `Q ${QUIZ.idx+1}/${QUIZ.list.length}`;
  $("quizScore").textContent = `Score: ${QUIZ.score}`;
  $("quizQ").textContent = q.q;
  $("quizChoices").innerHTML = "";

  q.choices.forEach(choice=>{
    const b = document.createElement("button");
    b.className = "choiceBtn";
    b.textContent = choice;

    b.addEventListener("click", ()=>{
      if(QUIZ.locked) return;
      QUIZ.locked = true;

      STATE.quiz.attempted = (STATE.quiz.attempted||0) + 1;

      const { bucket } = getWeeklyBucket();
      bucket.attempted += 1;

      const correct = (choice === q.answer);
      if(correct){
        QUIZ.score++;
        STATE.quiz.correct = (STATE.quiz.correct||0) + 1;
        bucket.correct += 1;

        QUIZ.streak++;
        QUIZ.best = Math.max(QUIZ.best, QUIZ.streak);
        bucket.bestStreak = Math.max(bucket.bestStreak||0, QUIZ.best);
        STATE.quiz.bestStreakAllTime = Math.max(STATE.quiz.bestStreakAllTime||0, QUIZ.best);

        b.classList.add("correct");

        if(QUIZ.streak > 0 && QUIZ.streak % 5 === 0){
          confetti.burst(90);
        }
      }else{
        QUIZ.streak = 0;
        b.classList.add("wrong");
        if(QUIZ.wrong) QUIZ.wrong.push(q);
      }

      $("quizStreakPill").textContent = `üî• Streak: ${QUIZ.streak}`;
      $("quizBestStreakPill").textContent = `üèÜ Best: ${QUIZ.best}`;

      saveState();

      const expl = document.createElement("div");
      expl.className = "note";
      expl.style.marginTop = "10px";
      expl.textContent = q.explain;
      $("quizChoices").appendChild(expl);

      $("quizExplainer").textContent = `Progress score: ${computeProgressScore()}% ‚Ä¢ Weekly: ${weeklyPercent()}%`;
      computeKpis();
    });

    $("quizChoices").appendChild(b);
  });
}

/* ==========================================================
   EMOJI GAME
   ========================================================== */
let EMOJI = { score:0, attempted:0, current:null, choices:[], streak:0, best:0 };

function getEmojiPool(topicId, mode){
  const build = (tid)=>{
    const pack = EMOJI_BANK[tid];
    if(!pack) return [];
    if(mode === "terms") return (pack.terms||[]).map(x=>({...x, type:"term"}));
    if(mode === "people") return (pack.people||[]).map(x=>({...x, type:"people"}));
    return [
      ...(pack.terms||[]).map(x=>({...x, type:"term"})),
      ...(pack.people||[]).map(x=>({...x, type:"people"}))
    ];
  };

  if(topicId === "MIXED") return TOPICS.flatMap(t=>build(t.id));
  return build(topicId);
}

function allAnswerOptions(mode){
  const terms = Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].terms||[]).map(x=>x.term));
  const people = Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].people||[]).map(x=>x.name));
  if(mode === "terms") return unique(terms);
  if(mode === "people") return unique(people);
  return unique([...terms, ...people]);
}

function startEmojiRound(){
  const topicId = $("emojiTopicSelect").value;
  const mode = $("emojiMode").value;

  const pool = getEmojiPool(topicId, mode);
  if(pool.length < 4){
    $("emojiClue").textContent = "‚ö†Ô∏è Not enough emoji prompts yet for this selection.";
    $("emojiChoices").innerHTML = `<div class="note">Add more clues in EMOJI_BANK for this topic/mode.</div>`;
    return;
  }

  const prompt = pool[Math.floor(Math.random()*pool.length)];
  const optionsUniverse = allAnswerOptions(mode);

  const distractors = shuffle(optionsUniverse.filter(x=>x !== prompt.answer)).slice(0,3);
  const choices = shuffle([prompt.answer, ...distractors]);

  EMOJI.current = prompt;
  EMOJI.choices = choices;

  $("emojiClue").textContent = prompt.clue;
  renderEmojiChoices();
}

function renderEmojiChoices(){
  const box = $("emojiChoices");
  box.innerHTML = "";
  $("emojiMeta").textContent = `${EMOJI.score} correct ‚Ä¢ ${EMOJI.attempted} attempted`;
  $("emojiStreakPill").textContent = `üî• Streak: ${EMOJI.streak}`;
  $("emojiBestStreakPill").textContent = `üèÜ Best: ${EMOJI.best}`;

  EMOJI.choices.forEach(ch=>{
    const b = document.createElement("button");
    b.className = "choiceBtn";
    b.textContent = ch;

    b.addEventListener("click", ()=>{
      if(!EMOJI.current) return;
      EMOJI.attempted++;

      const correct = (ch === EMOJI.current.answer);
      if(correct){
        EMOJI.score++;
        EMOJI.streak++;
        EMOJI.best = Math.max(EMOJI.best, EMOJI.streak);

        b.classList.add("correct");
        $("emojiHelp").textContent = `‚úÖ ${EMOJI.current.why}`;

        if(EMOJI.streak > 0 && EMOJI.streak % 7 === 0){
          confetti.burst(105);
        }

        setTimeout(()=>startEmojiRound(), 650);
      }else{
        EMOJI.streak = 0;
        b.classList.add("wrong");
        $("emojiHelp").textContent = "‚ùå Not quite ‚Äî think conceptually (not literal emojis).";
      }

      $("emojiMeta").textContent = `${EMOJI.score} correct ‚Ä¢ ${EMOJI.attempted} attempted`;
      $("emojiStreakPill").textContent = `üî• Streak: ${EMOJI.streak}`;
      $("emojiBestStreakPill").textContent = `üèÜ Best: ${EMOJI.best}`;
    });

    box.appendChild(b);
  });
}

$("btnStartEmoji").addEventListener("click", ()=>{
  EMOJI.score = 0; EMOJI.attempted = 0; EMOJI.streak = 0; EMOJI.best = 0;
  $("emojiHelp").textContent = "Pick the best answer from 4.";
  startEmojiRound();
});
$("emojiTopicSelect").addEventListener("change", startEmojiRound);
$("emojiMode").addEventListener("change", startEmojiRound);

/* ==========================================================
   MATCHING GAME
   ========================================================== */
function dedupeByName(people){
  const seen = new Set();
  const out = [];
  for(const p of people){
    const k = String(p.name||"").toLowerCase();
    if(!k || seen.has(k)) continue;
    seen.add(k);
    out.push(p);
  }
  return out;
}
let MATCH = {
  pairs: [],
  names: [],
  descs: [],
  selectedNameId: null,
  selectedDescId: null,
  correct: 0,
  total: 0,
  locked: new Set(),
  streak: 0,
  best: 0
};

function buildPeoplePool(topicId){
  const allP = Object.keys(FACT_BANK).flatMap(tid => (FACT_BANK[tid].people||[]).map(p=>({...p, topicId: tid})));
  if(topicId === "MIXED") return dedupeByName(allP);

  const topicPeople = (FACT_BANK[topicId]?.people || []).map(p=>({...p, topicId}));
  const decoys = shuffle(allP.filter(p=>p.topicId!==topicId)).slice(0, 6);
  return dedupeByName([...topicPeople, ...decoys]);
}
function makeTrickyDescription(p){
  const role = p.role.replace(/\s+/g," ").trim();
  const sig = p.significance.replace(/\s+/g," ").trim();
  const safeSig = sig.replaceAll(p.name, "this figure");
  return `${role}. ${safeSig}`;
}
function startMatchGame(){
  const topicId = $("matchTopicSelect").value;
  const pairsWanted = Number($("matchDifficulty").value);

  const pool = buildPeoplePool(topicId);
  const chosen = shuffle(pool).slice(0, Math.min(pairsWanted, pool.length));

  const pairs = chosen.map((p, i)=>({
    key:`p${i}`,
    name: p.name,
    desc: makeTrickyDescription(p)
  }));

  MATCH = {
    pairs,
    names: shuffle(pairs.map(x=>({ id:`n_${x.key}`, key:x.key, text:x.name }))),
    descs: shuffle(pairs.map(x=>({ id:`d_${x.key}`, key:x.key, text:x.desc }))),
    selectedNameId: null,
    selectedDescId: null,
    correct: 0,
    total: pairs.length,
    locked: new Set(),
    streak: 0,
    best: 0
  };

  renderMatch();
}
function renderMatch(){
  $("matchNames").innerHTML = "";
  $("matchDescs").innerHTML = "";
  $("matchMeta").textContent = `Pairs: ${MATCH.total} ‚Ä¢ Correct: ${MATCH.correct}`;
  $("matchStreakPill").textContent = `üî• Streak: ${MATCH.streak}`;
  $("matchBestStreakPill").textContent = `üèÜ Best: ${MATCH.best}`;

  MATCH.names.forEach(item=>{
    const b = document.createElement("button");
    b.className = "matchItem";
    b.textContent = item.text;

    if(MATCH.locked.has(item.key)) b.classList.add("correct");
    if(MATCH.selectedNameId === item.id) b.classList.add("selected");

    b.addEventListener("click", ()=>{
      if(MATCH.locked.has(item.key)) return;
      MATCH.selectedNameId = (MATCH.selectedNameId === item.id) ? null : item.id;
      attemptMatch();
      renderMatch();
    });

    $("matchNames").appendChild(b);
  });

  MATCH.descs.forEach(item=>{
    const b = document.createElement("button");
    b.className = "matchItem";
    b.textContent = item.text;

    if(MATCH.locked.has(item.key)) b.classList.add("correct");
    if(MATCH.selectedDescId === item.id) b.classList.add("selected");

    b.addEventListener("click", ()=>{
      if(MATCH.locked.has(item.key)) return;
      MATCH.selectedDescId = (MATCH.selectedDescId === item.id) ? null : item.id;
      attemptMatch();
      renderMatch();
    });

    $("matchDescs").appendChild(b);
  });
}
function attemptMatch(){
  if(!MATCH.selectedNameId || !MATCH.selectedDescId) return;

  const nameItem = MATCH.names.find(x=>x.id===MATCH.selectedNameId);
  const descItem = MATCH.descs.find(x=>x.id===MATCH.selectedDescId);
  if(!nameItem || !descItem) return;

  const correct = (nameItem.key === descItem.key);

  if(correct){
    MATCH.locked.add(nameItem.key);
    MATCH.correct++;
    MATCH.streak++;
    MATCH.best = Math.max(MATCH.best, MATCH.streak);

    $("matchHelp").textContent = "‚úÖ Correct! Keep going.";

    if(MATCH.streak > 0 && MATCH.streak % 4 === 0){
      confetti.burst(80);
    }
  }else{
    MATCH.streak = 0;
    $("matchHelp").textContent = "‚ùå Not a match ‚Äî look for the precise clue in the wording.";
  }

  MATCH.selectedNameId = null;
  MATCH.selectedDescId = null;

  if(MATCH.correct >= MATCH.total){
    $("matchHelp").textContent = "üèÜ Completed! New game to reshuffle.";
    confetti.burst(160);
  }
}
$("btnStartMatch").addEventListener("click", startMatchGame);

/* ==========================================================
   EXAM TAB UI (enforce 3 per topic)
   ========================================================== */
function validateExamBank(){
  // ensures 3 per topicId (t1..t4)
  const counts = {};
  EXAM_BANK.forEach(q => counts[q.topicId] = (counts[q.topicId]||0)+1);
  for(const t of TOPICS){
    if((counts[t.id]||0) !== 3){
      console.warn("EXAM_BANK topic not equal to 3:", t.id, counts[t.id]);
    }
  }
}
validateExamBank();

function renderExamSelect(){
  const filter = $("examTopicSelect").value;
  $("examSelect").innerHTML = "";

  const list = EXAM_BANK.filter(q=>filter==="ALL" ? true : q.topicId===filter);

  list.forEach(q=>{
    const o=document.createElement("option");
    o.value=q.id;
    o.textContent = q.question.length>95 ? q.question.slice(0,95)+"‚Ä¶" : q.question;
    $("examSelect").appendChild(o);
  });

  if(list.length){
    $("examSelect").value=list[0].id;
    renderExamQuestion();
  }else{
    $("examQText").textContent="No questions in this filter.";
    $("examPlan").innerHTML="";
    $("examHelpBody").innerHTML="";
  }
}

function renderExamQuestion(){
  const id = $("examSelect").value;
  const q = EXAM_BANK.find(x=>x.id===id);
  if(!q) return;

  $("examQText").textContent = q.question;
  const topicTitle = (TOPICS.find(t=>t.id===q.topicId)||{}).title || "‚Äî";
  $("examTag").textContent = `Topic: ${topicTitle} ‚Ä¢ Suggested factors: ${q.factors.length}`;

  const plan = $("examPlan");
  plan.innerHTML="";
  q.plan.forEach((p,i)=>{
    const div=document.createElement("div");
    div.style.border="1px solid var(--line)";
    div.style.borderRadius="16px";
    div.style.padding="12px";
    div.style.background="#fff";
    div.style.marginBottom="10px";
    div.innerHTML = `<b>${i+1}. ${p.title}</b><div class="note" style="margin-top:6px;color:#333">${p.body}</div>`;
    plan.appendChild(div);
  });

  $("examHelpBody").innerHTML =
    `<ul style="margin:0 0 0 18px">${q.help.map(x=>`<li>${x}</li>`).join("")}</ul>`;
  $("examHelp").open = false;

  // Daily challenge: opening the relevant plan counts
  recordDailyPlanOpened(q.topicId);
}
$("examTopicSelect").addEventListener("change", renderExamSelect);
$("examSelect").addEventListener("change", renderExamQuestion);

/* ==========================================================
   EXPORT / IMPORT / RESET
   ========================================================== */
$("btnExport").addEventListener("click", ()=>{ $("dataBox").value = JSON.stringify(STATE); });

$("btnImport").addEventListener("click", ()=>{
  const raw = $("dataBox").value.trim();
  if(!raw) return alert("Paste JSON into the box first.");
  try{
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") throw new Error("Invalid data");
    STATE = obj;
    saveState();
    computeKpis();
    alert("Imported successfully.");
  }catch(e){
    alert("Import failed: invalid JSON.");
  }
});

$("btnReset").addEventListener("click", ()=>{
  const ok = confirm("Reset ALL progress on this device?");
  if(!ok) return;
  STATE = baseState();
  saveState();
  computeKpis();
  alert("Progress reset.");
});

/* ==========================================================
   INIT
   ========================================================== */
function init(){
  populateTopics();
  try{ bumpHeaderSessions(); }catch(e){}
  updateDailyUI();
  // sensible defaults
  $("topicSelect").value = "ALL";
  $("modeSelect").value = "all";
  $("orderSelect").value = "ordered";
  $("mcqTopicSelect").value = "MIXED";
  $("emojiTopicSelect").value = "MIXED";
  $("matchTopicSelect").value = "MIXED";
  $("examTopicSelect").value = "ALL";

  renderExamSelect();
  loadNextCard();
  computeKpis();
  buildPinnedTopics();
  wireTodayButtons();
  updateWeeklyGoalPill();

  // pre-load games
  startMatchGame();
  startEmojiRound();

  // start on Home
  setTab("home");
}
init();
</script>

<!-- Optional: PWA service worker registration (keeps mobile/PWA assets up to date) -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try{
        const reg = await navigator.serviceWorker.register("./service-worker.js?v8", { scope: "./" });
        // Ask the browser to check for an updated SW file
        if (reg && reg.update) reg.update();

        // If an updated SW is waiting, activate it and reload so new assets (e.g. header-bg.jpg) appear
        if (reg.waiting) {
          reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }
        reg.addEventListener("updatefound", () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener("statechange", () => {
            if (sw.state === "installed" && navigator.serviceWorker.controller) {
              sw.postMessage({ type: "SKIP_WAITING" });
            }
          });
        });

        navigator.serviceWorker.addEventListener("controllerchange", () => {
          window.location.reload();
        });
      }catch(e){
        console.warn("Service worker registration failed", e);
      }
    });
  }
</script>
</body>
</html>
